<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="My Little World" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta property="og:type" content="website">
<meta property="og:title" content="My Little World">
<meta property="og:url" content="http://yoohannah.github.io/page/6/index.html">
<meta property="og:site_name" content="My Little World">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My Little World">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoohannah.github.io/page/6/">





  <title> My Little World </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">My Little World</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">learn and share</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/js/strange2.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/js/strange2.html" itemprop="url">
                  一些奇思妙想(二)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-03T19:19:15+08:00">
                2020-08-03
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Jquery-链式调用原理"><a href="#Jquery-链式调用原理" class="headerlink" title="Jquery 链式调用原理"></a>Jquery 链式调用原理</h1><p>例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(&apos;div&apos;).eq(0).show().end().eq(1).hide();</span><br></pre></td></tr></table></figure></p>
<p>jquery 通过<b>更替this指向</b>实现<b>链式</b>调用<br>实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">jQuery.fn = jQuery.prototype = &#123;</span><br><span class="line">  pushStack: function( elems ) &#123;</span><br><span class="line">		// Build a new jQuery matched element set</span><br><span class="line">		var ret = jQuery.merge( this.constructor(), elems );</span><br><span class="line">		// Add the old object onto the stack (as a reference)</span><br><span class="line">		ret.prevObject = this;</span><br><span class="line">		// Return the newly-formed element set</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;,</span><br><span class="line">  eq: function( i ) &#123;</span><br><span class="line">		var len = this.length,</span><br><span class="line">			j = +i + ( i &lt; 0 ? len : 0 );</span><br><span class="line">		return this.pushStack( j &gt;= 0 &amp;&amp; j &lt; len ? [ this[ j ] ] : [] );</span><br><span class="line">	&#125;,</span><br><span class="line">  show: function() &#123;</span><br><span class="line">		return showHide( this, true );</span><br><span class="line">	&#125;,</span><br><span class="line">  hide: function() &#123;</span><br><span class="line">		return showHide( this );</span><br><span class="line">	&#125;,</span><br><span class="line">	end: function() &#123;</span><br><span class="line">		return this.prevObject || this.constructor();</span><br><span class="line">	&#125;,</span><br><span class="line">  </span><br><span class="line">  css: function( name, value ) &#123;</span><br><span class="line">		return access( this, function( elem, name, value ) &#123;	。。。。&#125;, name, value, arguments.length &gt; 1 );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">function showHide( elements, show ) &#123;</span><br><span class="line">  。。。。</span><br><span class="line">  return elements;</span><br><span class="line">&#125;</span><br><span class="line">var access = function( elems, fn, key, value, chainable, emptyGet, raw ) &#123;</span><br><span class="line">  var i = 0,</span><br><span class="line">    len = elems.length,</span><br><span class="line">    bulk = key == null;</span><br><span class="line">  if ( toType( key ) === &quot;object&quot; ) &#123;</span><br><span class="line">    chainable = true;</span><br><span class="line">    for ( i in key ) &#123;。。。。&#125;</span><br><span class="line">  &#125; else if ( value !== undefined ) &#123;</span><br><span class="line">    chainable = true;</span><br><span class="line">    if ( !isFunction( value ) ) &#123; 。。。。&#125;</span><br><span class="line">    if ( bulk ) &#123; 。。。。&#125;</span><br><span class="line">    if ( fn ) &#123; 。。。。。&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //当是链式调用时，返回对象</span><br><span class="line">  if ( chainable ) &#123;</span><br><span class="line">    return elems;</span><br><span class="line">  &#125;</span><br><span class="line">  // Gets</span><br><span class="line">  if ( bulk ) &#123;</span><br><span class="line">    return fn.call( elems );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return len ? fn( elems[ 0 ], key ) : emptyGet;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>当showHide，access传入this的时候，返回的即this,接着可以实现链式</p>
<h1 id="promise-then-原理"><a href="#promise-then-原理" class="headerlink" title="promise then 原理"></a>promise then 原理</h1><p>利用promise 对象去实现一系列功能的过程，可以理解为一个<b>链式</b>结构组成的过程<br>then 和 catch 函数的调用其实是对后续功能的收集<br><b>返回新的</b>promise对象，区别存放每个阶段的执行结果<br>resolve  和 rejec 函数的调用为后续then/catch收集的函数进行定调，决定到底执行什么<br>resolve和reject函数执行过程中根据返回值，实现链式结构的拼接和后续函数的执行顺序处理<br><a href="https://juejin.im/post/6844903839179472910" target="_blank" rel="noopener">相关链接</a><br><a href>代码实现</a></p>
<h1 id="async-await-原理"><a href="#async-await-原理" class="headerlink" title="async await 原理"></a>async await 原理</h1><p>借助generator,通过封装promise，利用<b>递归</b>可以实现相同的效果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function asyncToGenerator(generatorFunc) &#123;</span><br><span class="line">    return function() &#123;</span><br><span class="line">      const gen = generatorFunc.apply(this, arguments)</span><br><span class="line">      return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        function step(key, arg) &#123;</span><br><span class="line">          let generatorResult</span><br><span class="line">          try &#123;</span><br><span class="line">            generatorResult = gen[key](arg)</span><br><span class="line">          &#125; catch (error) &#123;</span><br><span class="line">            return reject(error)</span><br><span class="line">          &#125;</span><br><span class="line">          const &#123; value, done &#125; = generatorResult</span><br><span class="line">          if (done) &#123;</span><br><span class="line">            return resolve(value)</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            return Promise.resolve(value).then(</span><br><span class="line">              val =&gt; step(&apos;next&apos;, val), //递归</span><br><span class="line">              err =&gt; step(&apos;throw&apos;, err)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        step(&quot;next&quot;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="KOA-app-use-next-原理"><a href="#KOA-app-use-next-原理" class="headerlink" title="KOA app.use next 原理"></a>KOA app.use next 原理</h1><p>主要思想是<b>递归</b>实现<br><a href="https://yoohannah.github.io/post/nodejs/middlwareSrc.html">详见</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let index = -1</span><br><span class="line">return dispatch(0) //从第一个中间件开始执行</span><br><span class="line">function dispatch (i) &#123;</span><br><span class="line">  //防止next 在一个中间件中被调用多次</span><br><span class="line">  if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">  index = i</span><br><span class="line">  let fn = middleware[i] //拿到中间件</span><br><span class="line">  if (i === middleware.length) fn = next //如果中间件函数全部调用完，fn 赋值为next,next为undefined</span><br><span class="line">  if (!fn) return Promise.resolve() //fn为next=&gt;undefined时成立，即执行到最后返回一个Promise.resolve() 可以继续写then</span><br><span class="line">  try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</span><br><span class="line">    //执行中间件函数，传入ctx,next参数，next即dispatch.bind(null, i + 1)，</span><br><span class="line">    //递归调用下一个中间件函数</span><br><span class="line">    //从这一步可以实现await next()时，先执行下一个中间件函数</span><br><span class="line">    //中间件有调用next,就利用await暂停当前中间件执行，开始执行下一个中间件</span><br><span class="line">    return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    return Promise.reject(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="VUEROUTER-next-原理"><a href="#VUEROUTER-next-原理" class="headerlink" title="VUEROUTER next 原理"></a>VUEROUTER next 原理</h1><p>利用迭代器思想<b>递归</b>调用钩子函数<br>在vueRouter 的声明周期使用时，next函数会当做默认参数传递进去，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.beforeEach((to, from, next) =&gt; &#123;</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function confirmTransition (route, onComplete, onAbort) &#123;</span><br><span class="line">  var queue = [].concat(</span><br><span class="line">    // in-component leave guards</span><br><span class="line">    extractLeaveGuards(deactivated),</span><br><span class="line">    // global before hooks</span><br><span class="line">    this.router.beforeHooks, //beforeEach钩子函数传入的函数集合</span><br><span class="line">    extractUpdateHooks(updated),</span><br><span class="line">    activated.map(function (m) &#123; return m.beforeEnter; &#125;),</span><br><span class="line">    resolveAsyncComponents(activated)</span><br><span class="line">  );</span><br><span class="line">  this.pending = route;</span><br><span class="line">  var iterator = function (hook, next) &#123;</span><br><span class="line">    if (this$1.pending !== route) &#123;</span><br><span class="line">      return abort()</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">      hook(route, current, function (to) &#123; 。。。。。。&#125;);</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      abort(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  runQueue(queue, iterator, function () &#123;</span><br><span class="line">    var postEnterCbs = [];</span><br><span class="line">    var isValid = function () &#123; return this$1.current === route; &#125;;</span><br><span class="line">    var enterGuards = extractEnterGuards(activated, postEnterCbs, isValid);</span><br><span class="line">    var queue = enterGuards.concat(this$1.router.resolveHooks);</span><br><span class="line">    runQueue(queue, iterator, function () &#123;。。。。&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可见 beforeEach 钩子函数被装在queue数组中，传递给了runQueue函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function runQueue (queue, fn, cb) &#123;</span><br><span class="line">    var step = function (index) &#123;</span><br><span class="line">      if (index &gt;= queue.length) &#123;</span><br><span class="line">        cb();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        if (queue[index]) &#123; //拿到生命周期函数传递给fn函数</span><br><span class="line">          fn(queue[index], function () &#123;</span><br><span class="line">            step(index + 1);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          step(index + 1);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    step(0);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>参数fn函数是 iterator</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">iterator = function (hook, next) &#123;</span><br><span class="line">    if (this$1.pending !== route) &#123;</span><br><span class="line">      return abort()</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">      hook(route, current, function (to) &#123; 。。。。。。&#125;);</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      abort(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>参数hook即钩子函数，来看传递给它的三个参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hook(route, current, function (to) &#123; 。。。。。。&#125;);</span><br></pre></td></tr></table></figure>
<p>第三个参数即next</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function (to) &#123;</span><br><span class="line">  if (to === false || isError(to)) &#123;</span><br><span class="line">    // next(false) -&gt; abort navigation, ensure current URL</span><br><span class="line">    this$1.ensureURL(true);</span><br><span class="line">    abort(to);</span><br><span class="line">  &#125; else if (</span><br><span class="line">    typeof to === &apos;string&apos; ||</span><br><span class="line">    (typeof to === &apos;object&apos; &amp;&amp;</span><br><span class="line">      (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</span><br><span class="line">  ) &#123;</span><br><span class="line">    // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</span><br><span class="line">    abort();</span><br><span class="line">    if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123;</span><br><span class="line">      this$1.replace(to);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      this$1.push(to);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // confirm transition and pass on the value</span><br><span class="line">    next(to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面的next 指向参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function () &#123;</span><br><span class="line">  step(index + 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>即当我们在钩子函数调用next不传递任何参数时，<br>只是在调用迭代器函数，递归进行下一个函数的执行</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/js/strange1.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/js/strange1.html" itemprop="url">
                  一些奇思妙想(一)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-02T19:19:15+08:00">
                2020-08-02
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="为什么typeof-null-–-gt-object"><a href="#为什么typeof-null-–-gt-object" class="headerlink" title="为什么typeof null –&gt;object?"></a>为什么typeof null –&gt;object?</h1><p>解析器在存值的时候会以二进制形式存入，<br>编译时，如果一个值的二进制的前三位均为0的话，<br>那用typeof检测该值时，拿到的就是object<br>在null转二进制时，所有位都是0，所以typeof null —-&gt;object</p>
<h1 id="为什么NaN-NaN-—-gt-true"><a href="#为什么NaN-NaN-—-gt-true" class="headerlink" title="为什么NaN != NaN —&gt;true"></a>为什么NaN != NaN —&gt;true</h1><p>NaN这个东西在计算机数值里面，是个浮点数，小数部分的位连续多位是不确定的，即在一定范围内的这个浮点数在获取的时候我们都可以叫它NaN</p>
<p>V8引擎调用c++的类库limit 使用它的numeric_limit<double>的quiet_NaN()产生NaN时，<br>明显生成的是浮点数据类型，即每次生成的NaN是不同的数值<br>所以不相等</double></p>
<h1 id="为什么js的对象的key值不能是对象"><a href="#为什么js的对象的key值不能是对象" class="headerlink" title="为什么js的对象的key值不能是对象"></a>为什么js的对象的key值不能是对象</h1><p>当试图用非字符串类型做对象key值时，其值会被toString方法静默转为字符串类，<br>当非字符串类型为对象时，如果作为key的两个对象属于一个类的实例，<br>那么他们转化成字符串的结果将会是相同的，赋值时，就会导致后续赋值覆盖前者的值</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/somequestion.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/somequestion.html" itemprop="url">
                  一些问题小结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-02T10:48:15+08:00">
                2020-08-02
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="响应式两种方案"><a href="#响应式两种方案" class="headerlink" title="响应式两种方案"></a>响应式两种方案</h1><p> 前后端通过判断userAgent来跳转不同站点</p>
<p> 使用media query媒体查询让页面根据不同设备自动改变页面布局和显示</p>
<h1 id="移动端端适配方案"><a href="#移动端端适配方案" class="headerlink" title="移动端端适配方案"></a>移动端端适配方案</h1><p>  zoom<br>  vm/vh<br>  rem (font-size Media Query)<br>  flex<br>  viewport（scale=1/dpr）<br>  <a href="https://www.jianshu.com/p/b13d811a6a76" target="_blank" rel="noopener">链接</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">屏幕尺寸、屏幕分辨率--&gt;对角线分辨率/屏幕尺寸--&gt;屏幕像素密度PPI</span><br><span class="line">                                             |</span><br><span class="line">              设备像素比dpr = 物理像素 / 设备独立像素dip(dp)</span><br><span class="line">                                             |</span><br><span class="line">                                       viewport: scale</span><br><span class="line">                                             |</span><br><span class="line">                                          CSS像素px</span><br></pre></td></tr></table></figure>
<h1 id="实现动画的6种方式"><a href="#实现动画的6种方式" class="headerlink" title="实现动画的6种方式"></a>实现动画的6种方式</h1><p>纯JS（利用setInterval,16ms）<br>SVG (利用标签进行配置)<br>canvas(利用js API进行配置)<br>css3-transition(属于过度动画，不能独立实现动画)<br>css3-animation(纯css实现动画)<br>requestAnimationFrame(类似setInteval,但性能消耗低)</p>
<p>前两种兼容性良好<br>后四种适合移动端开发</p>
<h1 id="处理浏览器css样式兼容"><a href="#处理浏览器css样式兼容" class="headerlink" title="处理浏览器css样式兼容"></a>处理浏览器css样式兼容</h1><p>reset:清除浏览器默认样式，针对具体元素标签重写样式通过清除保持一致<br>normalize:样式规范确定的情况下，直接重写样式，通过使用默认统一保持一致<br>neat:前两者结合针对确定的样式直接重写，不确定的清除</p>
<p>css 样式权重<br>!important<br>内联（1000）<br>id(100)<br>类（10）<br>元素（1）</p>
<h1 id="根据浏览器设备屏幕宽度和分辨率加载不同大小的图片"><a href="#根据浏览器设备屏幕宽度和分辨率加载不同大小的图片" class="headerlink" title="根据浏览器设备屏幕宽度和分辨率加载不同大小的图片"></a>根据浏览器设备屏幕宽度和分辨率加载不同大小的图片</h1><p>使用Media Query 判断加载不同背景图<br>使用H5的Picture标签<br>使用模板语言进行判断，渲染不同图片<br>请求时带上相关参数，让服务器吐出不同大小图片</p>
<h1 id="JS-可能出现内存泄露的常见场景"><a href="#JS-可能出现内存泄露的常见场景" class="headerlink" title="JS 可能出现内存泄露的常见场景"></a>JS 可能出现内存泄露的常见场景</h1><p>闭包函数<br>全局变量<br>对象属性循环引用<br>DOM结点删除时未解绑事件<br>Map和Set的属性直接删除</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>1.<br>数据类型在内存中分布<br>常量池：boolean,number,string<br>栈：undefined<br>堆：object<br>函数定义区：function(其实在堆里面)<br> === 比较变量地址；==会通过V8进行隐式转换</p>
<p>2.<br> 把Object 看作普通类，Object 是Function的实例<br> Object.<strong>proto</strong> === Function.prototype<br> 把Object 看作构造函数，functionxxx 是 Object的派生<br> functionxxx.<strong>proto</strong> === Function.prototype<br> Function.prototype.<strong>proto</strong> === Object.prototype<br> Object.<strong>proto</strong>.<strong>proto</strong> === Object.prototype</p>
<ol start="3">
<li>CommonJs AMD CMD NodeModules</li>
</ol>
<p>4.LESS/SASS存在价值，有什么作用<br>编程式CSS,可维护性，可扩展性，静态样式一定程度上可以实现动态化</p>
<p>5.<br>前端基础：HTML/CSS/ECMAScript jQuery/bootStrap<br>新前端：React/VUE/Angular CommonJS/AMD/CMD/NodeModule<br>工具：npm/bowser 预编译（LESS\SASS\Babel）构建工具(webpack\gulp\grunt)<br>应用端服务器：Node Web应用\http协议\RPC\发布部署\微服务<br>跨平台开发：PC（window,mac）前端（web+h5）移动端(andorid,ios)（flutter\react-native）\小程序</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vueAddRoutes.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vueAddRoutes.html" itemprop="url">
                  动态添加路由
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-18T18:07:15+08:00">
                2020-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>需要将动态路由添加到当前静态路由的子路由中<br>即在路由的children属性中添加新路由</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>使用router.addRoutes方法API进行添加</p>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>在beforeEach方法中请求动态路由进行添加，<br>通过设置flag,保证动态路由仅请求一次</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="直接增加同名路由无法覆盖"><a href="#直接增加同名路由无法覆盖" class="headerlink" title="直接增加同名路由无法覆盖"></a>直接增加同名路由无法覆盖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const routes = [</span><br><span class="line">  &#123; path: &apos;/foo&apos;,name:&apos;foo&apos;, component: Foo,children:[&#123; path: &apos;/bar2/:id?&apos;,name:&apos;bar2&apos;, component: Foo1 &#125;]&#125;</span><br><span class="line">]</span><br><span class="line">const routes1 = [</span><br><span class="line">  &#123; path: &apos;/foo&apos;,name:&apos;foo&apos;, component: Foo ,children:[&#123; path: &apos;/bar21/:id?&apos;,name:&apos;bar21&apos;, component: Foo2 &#125;]&#125;,</span><br><span class="line">]</span><br><span class="line">const router = new VueRouter(&#123;</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line">router.addRoutes(routes1)</span><br></pre></td></tr></table></figure>
<p>添加路由记录时，如果之前已经添加过同名路由，则只会警告，不会更新<br>所以如果想通过传入不同的children进行子路由更新无法实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">function addRoutes (routes) &#123;</span><br><span class="line">  createRouteMap(routes, pathList, pathMap, nameMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">routes.forEach(function (route) &#123;</span><br><span class="line">  addRouteRecord(pathList, pathMap, nameMap, route);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">function addRouteRecord ( pathList, pathMap, nameMap ) &#123;</span><br><span class="line">  //如果有子路由，递归添加到路由表中</span><br><span class="line">  if (route.children) &#123;</span><br><span class="line">    route.children.forEach(function (child) &#123;</span><br><span class="line">      var childMatchAs = matchAs</span><br><span class="line">        ? cleanPath((matchAs + &quot;/&quot; + (child.path)))</span><br><span class="line">        : undefined;</span><br><span class="line">        console.log(childMatchAs)</span><br><span class="line">      addRouteRecord(pathList, pathMap, nameMap, child, record, childMatchAs);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!pathMap[record.path]) &#123; 关键！！！！！！详见下文</span><br><span class="line">    pathList.push(record.path);</span><br><span class="line">    pathMap[record.path] = record;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (name) &#123;</span><br><span class="line">    if (!nameMap[name]) &#123; </span><br><span class="line">      nameMap[name] = record;</span><br><span class="line">    &#125; else if ( !matchAs) &#123; //直接警告，不更新</span><br><span class="line">      warn(</span><br><span class="line">        false,</span><br><span class="line">        &quot;Duplicate named routes definition: &quot; +</span><br><span class="line">          &quot;&#123; name: \&quot;&quot; + name + &quot;\&quot;, path: \&quot;&quot; + (record.path) + &quot;\&quot; &#125;&quot;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>addRoutes时，子路由作为children属性，依托父路由添加时，子路由被递归添加后，<br>但父路由因为之前已经添加过，所以不会再对父路由进行任何处理，新添加的子路由<br>不会跟随父路由更新到路由表中，即addRoutes过程不会对原来老路由产生任何变动<br>所以新的子路由也不会被添加进去</p>
<h3 id="解决办法一"><a href="#解决办法一" class="headerlink" title="解决办法一"></a>解决办法一</h3><p>拼接好路由后，通过重新生成matcher对象，清空原始路由信息，再将最终路由添加进去<br><a href="https://github.com/YooHannah/algorithm/blob/master/blog/vueAddRouter1.js" target="_blank" rel="noopener">详见</a><br>缺点：容易引发各种问题，且引起重复路由</p>
<h3 id="解决办法二"><a href="#解决办法二" class="headerlink" title="解决办法二"></a>解决办法二</h3><p>按照API规则添加路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: Array&lt;RouteConfig&gt;)</span><br><span class="line">动态添加更多的路由规则。参数必须是一个符合 routes 选项要求的数组。</span><br></pre></td></tr></table></figure></p>
<p>将待更新的路由对象抽离，拿到动态路由拼接好后，与404路由组成数组，直接添加路由<br><a href="https://github.com/YooHannah/algorithm/blob/master/blog/vueAddRouter2.js" target="_blank" rel="noopener">详见</a></p>
<h2 id="无法正常刷新"><a href="#无法正常刷新" class="headerlink" title="无法正常刷新"></a>无法正常刷新</h2><p>F12刷新浏览器页面后路由对象name为null,无法正常跳转<br>如果直接再在next函数中添加跳转信息会引起无线循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">History.prototype.confirmTransition = function confirmTransition (route, onComplete, onAbort) &#123;</span><br><span class="line">var queue = [].concat(</span><br><span class="line">  // in-component leave guards</span><br><span class="line">  extractLeaveGuards(deactivated),</span><br><span class="line">  // global before hooks</span><br><span class="line">  this.router.beforeHooks,</span><br><span class="line">  // in-component update hooks</span><br><span class="line">  extractUpdateHooks(updated),</span><br><span class="line">  // in-config enter guards</span><br><span class="line">  activated.map(function (m) &#123; return m.beforeEnter; &#125;),</span><br><span class="line">  // async components</span><br><span class="line">  resolveAsyncComponents(activated)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">this.pending = route;</span><br><span class="line">var iterator = function (hook, next) &#123;</span><br><span class="line">  if (this$1.pending !== route) &#123;</span><br><span class="line">    return abort()</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">    hook(route, current, function (to) &#123; </span><br><span class="line">      if (to === false || isError(to)) &#123;</span><br><span class="line">        // next(false) -&gt; abort navigation, ensure current URL</span><br><span class="line">        this$1.ensureURL(true);</span><br><span class="line">        abort(to);</span><br><span class="line">      &#125; else if (</span><br><span class="line">        typeof to === &apos;string&apos; ||</span><br><span class="line">        (typeof to === &apos;object&apos; &amp;&amp;</span><br><span class="line">          (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</span><br><span class="line">      ) &#123;</span><br><span class="line">        // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</span><br><span class="line">        abort();</span><br><span class="line">        if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123; </span><br><span class="line">          this$1.replace(to);</span><br><span class="line">        &#125; else &#123; </span><br><span class="line">          this$1.push(to); //引起递归调用</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // confirm transition and pass on the value</span><br><span class="line">        next(to);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    abort(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">History.prototype.push = function push (location, onComplete, onAbort) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line"></span><br><span class="line">  var ref = this;</span><br><span class="line">  var fromRoute = ref.current;</span><br><span class="line">  this.transitionTo(location, function (route) &#123;</span><br><span class="line">    pushState(cleanPath(this$1.base + route.fullPath));</span><br><span class="line">    handleScroll(this$1.router, route, fromRoute, false);</span><br><span class="line">    onComplete &amp;&amp; onComplete(route);</span><br><span class="line">  &#125;, onAbort);</span><br><span class="line">&#125;;</span><br><span class="line">History.prototype.transitionTo = function transitionTo (</span><br><span class="line">  location,</span><br><span class="line">  onComplete,</span><br><span class="line">  onAbort</span><br><span class="line">) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line">  var route = this.router.match(location, this.current);</span><br><span class="line">  this.confirmTransition(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在next具体路由后再调用next(),可实现中止导航，即暂停递归</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if(!hasMenus)&#123;</span><br><span class="line">  hasMenus = true</span><br><span class="line">  let temp = await createRoutes() //拿到数据</span><br><span class="line">  router.addRoutes(temp) //添加路由</span><br><span class="line">  if(!to.name)&#123; //处理刷新，刷新时，当前页面name会变成null</span><br><span class="line">    next(&#123;name:to.path.substring(1)&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (to.matched.some(res =&gt; res.meta.requireAuth)) &#123;// 判断是否需要登录权限</span><br><span class="line">  cookies.getAuthorization().then(token=&gt;&#123;</span><br><span class="line">    if(!token)&#123;</span><br><span class="line">      next(&#123;</span><br><span class="line">        name: &apos;login&apos;,</span><br><span class="line">        params: &#123;from: to.name&#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      next()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  next() //终止递归</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>多读源码总是用好处的</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/nodejs/i18ntool.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/nodejs/i18ntool.html" itemprop="url">
                  多语言切换文字提取工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-24T18:15:15+08:00">
                2020-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>项目想要添加语言切换功能，负责该任务的同事由于待翻译的文本提取工作量巨大原因产生进度问题<br>项目领导委派我帮忙进行辅助提取的工作</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>  i18n原理就是在全局挂载自己的具有翻译功能的方法，然后将需要翻译的文本作为参数传入，<br>  然后函数根据当前语言环境，调用相应语言的翻译文件，通过key-value形式将对应语言的翻译结果返回给页面显示<br>  项目中以简体中文作为key,翻译结果作为value形成翻译文件<br>  如<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zh-CN.js 简体中文</span><br><span class="line">&apos;开始日期&apos;: &apos;开始日期&apos;,</span><br><span class="line">&apos;结束日期&apos;: &apos;结束日期&apos;,</span><br><span class="line"></span><br><span class="line">zh-TW.js 繁体中文</span><br><span class="line">&apos;开始日期&apos;: &apos;開始日期&apos;,</span><br><span class="line">&apos;结束日期&apos;: &apos;結束日期&apos;,</span><br></pre></td></tr></table></figure></p>
<p>  需要做的大量工作就是将项目中前端写的会展示在页面上的文本全部提取出来，形成文件，<br>  并给相应的简体中文地方用i18n全局函数括起来，通过调用函数返回翻译结果</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>因为同事使用纯手工作业，所以进度缓慢，按照这种做法，与其说自己比较懒，一个一个手动改，不如说自己觉得这种方式很low<br>一点都不酷，所以想起之前学习过的nodejs的知识，通过读取文件然后处理文件，最后生成新文件，用新文件替换老文件<br>处理文件过程会将简体中文提取出来形成文本提取文件，新文件中的简体中文会被i18n的全局函数包裹</p>
<h2 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;); //引入文件处理模块</span><br><span class="line">function read_file_sync(file_path) &#123;</span><br><span class="line">  var data = fs.readFileSync(file_path, &apos;utf-8&apos;); //读取文件</span><br><span class="line">  let arr = file_path.split(&apos;/&apos;)</span><br><span class="line">  let len = arr.length</span><br><span class="line">  let temp = arr[len-1].split(&apos;.&apos;)[0] </span><br><span class="line">  //获取文件名，如果待处理文件是子目录下的，保持生成的文本提取文件和新文件与原来文件保持相同目录结构</span><br><span class="line">  let fileName = arr[len-2] === &apos;console&apos;?temp:arr.slice(4,arr.length-1).join(&apos;/&apos;)+&apos;/&apos;+temp //子目录情况</span><br><span class="line">  GetChinese(data,fileName)</span><br><span class="line">&#125;</span><br><span class="line">read_file_sync(&apos;./src/components/console/san-manage.vue&apos;)</span><br></pre></td></tr></table></figure>
<p>提取生成文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function GetChinese(strValue,fileName) &#123; </span><br><span class="line">  if(strValue=== null || strValue === &quot;&quot;)&#123; </span><br><span class="line">    return []</span><br><span class="line">   &#125;</span><br><span class="line">  let originData = strValue</span><br><span class="line">  let arr = getWords(originData) //提取简体中文</span><br><span class="line">  let obj = &#123;&#125;</span><br><span class="line">  arr.map(item=&gt;&#123;obj[item]=&apos;&apos;&#125;)</span><br><span class="line">  let str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</span><br><span class="line">  str = &apos;export default &apos;+ str</span><br><span class="line">  //生成文本文件</span><br><span class="line">  fs.writeFile(&apos;./words/js/&apos;+fileName+&apos;.js&apos;, str,function(err)&#123; </span><br><span class="line">    if(err) console.log(&apos;提取操作失败&apos;);</span><br><span class="line">    else console.log(&apos;提取操作成功&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line">  //添加i18n全局函数，替换老文件，生成新文件</span><br><span class="line">  let index = originData.indexOf(&apos;&lt;script&gt;&apos;)</span><br><span class="line">  let template = originData.substring(0,index)//这里仅替换VUE文件的template模板部分，因为js部分有时涉及到拼接处理，单独处理</span><br><span class="line">  let templateResult = partTransfor(template) //得到替换结果</span><br><span class="line">  let other = originData.substring(index)//获取vue文件里面的js部分</span><br><span class="line">  //二者拼接写入新文件</span><br><span class="line">  fs.writeFile(&apos;./words/vue/&apos;+fileName+&apos;.vue&apos;, templateResult+other, function(err)&#123; </span><br><span class="line">    if(err) console.log(&apos;重写文件操作失败&apos;);</span><br><span class="line">    else console.log(&apos;重写文件操作成功&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="提取"><a href="#提取" class="headerlink" title="提取"></a>提取</h2><p>利用正则提取简体中文<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function getWords(strValue,flag)&#123;</span><br><span class="line"> //flag为true的时候，提取template部分简体中文，供替换使用</span><br><span class="line"> //flag为false的时候，提取全部简体中文，二者正则不同</span><br><span class="line">  var reg = flag? /\&quot;?([0-9a-zA-Z\u4e00-\u9fa5|\-|\s|\(|\)\:\：\、\，\,\！\!\。])+/g : /(([0-9a-zA-Z]+)?[\u4e00-\u9fa5|\-|\s|\(|\)\、\，\,\:\：\！\!\。\~]([0-9a-zA-Z]+)?)+/g</span><br><span class="line">  //匹配注释的正则，注释不用提取翻译，故提取前先移除</span><br><span class="line">  let regCommon = /(\/\/[\w\s\,\，\‘\(\)\—\:\：\=\&gt;\、\？\。a-zA-Z\.\u4e00-\u9fa5|\[|\]|-]*\n)|(\&lt;\!\-\-[\w\s\‘\-\、a-zA-Z\u4e00-\u9fa5|\[|\]|-]*\-\-\&gt;)|(\/\*[\w\‘\s\r\n\*\u4e00-\u9fa5|\-]*\*\/)/g</span><br><span class="line">  strValue = strValue.replace(regCommon, function(word) &#123; // 去除注释后的文本</span><br><span class="line">    return &apos;&apos;</span><br><span class="line">  &#125;);</span><br><span class="line">  //优化提取结果，去重，过滤，排序</span><br><span class="line">  let res = [...new Set(strValue.match(reg))].filter(item=&gt;&#123;return /([\u4e00-\u9fa5])+/g.test(item)&#125;).map(item=&gt;&#123;return item.trim()&#125;)</span><br><span class="line">  res = res.sort((a,b)=&gt;&#123;</span><br><span class="line">    return b.length-a.length</span><br><span class="line">  &#125;)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="去掉注释"><a href="#去掉注释" class="headerlink" title="去掉注释"></a>去掉注释</h3><p>本来想参考<a href="https://www.cnblogs.com/tugenhua0707/p/11332463.html" target="_blank" rel="noopener">webpack打包时去除注释的正则</a>，发现webpack去除注释，用的分词<br>直接通过判断astnode类型去判断是否为注释，然后根据配置决定保留去除<br>后来想起在阅读vue源码的时候有看到过在解析html的时候有形成注释类型的节点<br>所以从vue 源码中试图寻找注释的正则，发现vue也是只通过注释开头标志//，/** 或者&lt;!–<br>来判断注释开始，所以我在此基础上自己编写了解析注释的正则并将他们去除</p>
<h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><p>替换文本，用括号括起来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function partTransfor(strValue)&#123;</span><br><span class="line">  let originData = strValue</span><br><span class="line">  let res = getWords(strValue,true) //拿到template部分简体中文</span><br><span class="line">  for(let str of res)&#123;</span><br><span class="line">    let placeholder = str.charAt(0) ===&apos;\&quot;&apos; </span><br><span class="line">    let temp = placeholder?str.substring(1):str</span><br><span class="line">    let reg1 = new RegExp(str,&apos;ig&apos;)</span><br><span class="line">    let reg2 = new RegExp(&quot;placeholder=\&quot;(&quot;+temp+&quot;)\&quot;&quot;,&apos;ig&apos;)</span><br><span class="line">    let reg = placeholder?reg2:reg1</span><br><span class="line">    originData = originData.replace(reg,function(word,str)&#123;</span><br><span class="line">      if(placeholder)&#123; //如果是placeholder部分的简体中文</span><br><span class="line">        return &apos;:placeholder=&quot;i18nTitle(\&apos;&apos;+str+&apos;\&apos;)&quot;&apos;</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">        if(/[\u4e00-\u9fa5\:\&apos;]/.test(originData[str-1]) || /[\u4e00-\u9fa5\:\&apos;]/.test(originData[str+word]))&#123; //对于一些包含特殊字符连接的手动处理</span><br><span class="line">          return word</span><br><span class="line">        &#125;</span><br><span class="line">        return &apos;&#123;&#123;i18nTitle(\&apos;&apos;+word+&apos;\&apos;)&#125;&#125;&apos; //对于纯简体中文用函数包裹进行替换</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  return originData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实需要处理的情况分三种<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.js里面用this.i18nTitle(&apos;xxx&apos;)</span><br><span class="line">2.placeholder=&apos;xxx&apos;改成:placehoder=&quot;i18nTitle(&apos;xxxx&apos;)&quot;</span><br><span class="line">3.单纯标签的这种，&lt;label&gt;xxxx&lt;/label&gt;改成&lt;label&gt;&#123;&#123;i18nTitle(xxxx)&#125;&#125;&lt;/label&gt;</span><br></pre></td></tr></table></figure></p>
<p>另外涉及到组件里面的就直接在组件里需要展示的配置的中文简体字段变量外加全局函数</p>
<h2 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h2><p>每个文件提取处理好后，将所有字段合成一个文件，做去重处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">var path = require(&apos;path&apos;);//解析需要遍历的文件夹</span><br><span class="line">var filePath = path.resolve(&apos;./words/js&apos;);</span><br><span class="line">var words = []</span><br><span class="line">const getFileOfDirSync = (dir) =&gt; &#123;</span><br><span class="line">  let files = fs.readdirSync(dir);</span><br><span class="line">  let result;</span><br><span class="line">  if (files) &#123;</span><br><span class="line">    result = files.map((file) =&gt; &#123;</span><br><span class="line">      let filePath = path.join(dir, file);</span><br><span class="line">      if (fs.statSync(filePath).isDirectory()) &#123;</span><br><span class="line">        return getFileOfDirSync(filePath); //递归</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        let content = fs.readFileSync(filePath, &apos;utf-8&apos;);</span><br><span class="line">        content = content.replace(&apos;export default&apos;,&apos;module.exports =&apos;) //更改模块编写方法</span><br><span class="line">        fs.writeFileSync(filePath,content);//方便读取</span><br><span class="line">        let data = require(filePath)</span><br><span class="line">        let keys = Object.keys(data)</span><br><span class="line">        let comment = content.substring(0,content.indexOf(&apos;module&apos;))</span><br><span class="line">        return keys;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  return [... new Set(result.flat(Infinity))]; //数组摊平去重</span><br><span class="line">&#125;</span><br><span class="line">let res = getFileOfDirSync(filePath)</span><br><span class="line">res = res.sort((a,b)=&gt;&#123;</span><br><span class="line">  return b.length-a.length</span><br><span class="line">&#125;)</span><br><span class="line">let obj = &#123;&#125;</span><br><span class="line">res.map(item=&gt;&#123;obj[item]=&apos;&apos;&#125;)</span><br><span class="line">//res.map(item=&gt;&#123;obj[item]=item&#125;) //直接生成简体中文翻译文件</span><br><span class="line">let str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</span><br><span class="line">str = &apos;export default &apos;+ str</span><br><span class="line">fs.writeFile(&apos;./words/cnAll1.js&apos;, str,function(err)&#123;</span><br><span class="line">  if(err) console.log(&apos;提取操作失败&apos;);</span><br><span class="line">  else console.log(&apos;提取操作成功&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="翻译"><a href="#翻译" class="headerlink" title="翻译"></a>翻译</h2><p>根据简体中文和翻译结果形成翻译文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">let obj = &#123;&#125;</span><br><span class="line">let ll = &#123;&#125;</span><br><span class="line">let llkeys  = Object.keys(&#123; //翻译结果</span><br><span class="line">  &apos;建議選擇購買當前雲裸機已掛載使用的存儲類型和磁盤類型&apos;:&apos;&apos;,</span><br><span class="line">  &apos;超高端存儲：穩定性和安全性最好，適用於核心業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;高端存儲：穩定性和安全性較好，適用於重要業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;中端存儲：穩定性和安全性壹般，適用於壹般業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;普通存儲：穩定性和安全性較差，適用於邊緣業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;NVME：新壹代固態磁盤，性能最好、延時最低，適用於核心業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;SSD：固態磁盤，性能較好、延時較低，適用於重要業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;SAS：機械磁盤，性能壹般、延時壹般，適用於壹般業務系統&apos;:&apos;&apos;,</span><br><span class="line">  &apos;SATA：機械磁盤，性能較差、延時較高，適用於邊緣業務系統和歸檔數據&apos;:&apos;&apos;,</span><br><span class="line">&#125;)</span><br><span class="line">let objkeys = Object.keys(&#123; //简体中文</span><br><span class="line">  &apos;建议选择购买当前云裸机已挂载使用的存储类型和磁盘类型&apos;:&apos;&apos;,</span><br><span class="line">  &apos;超高端存储：稳定性和安全性最好，适用于核心业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;高端存储：稳定性和安全性较好，适用于重要业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;中端存储：稳定性和安全性一般，适用于一般业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;普通存储：稳定性和安全性较差，适用于边缘业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;NVME：新一代固态磁盘，性能最好、延时最低，适用于核心业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;SSD：固态磁盘，性能较好、延时较低，适用于重要业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;SAS：机械磁盘，性能一般、延时一般，适用于一般业务系统&apos;:&apos;&apos;,</span><br><span class="line">  &apos;SATA：机械磁盘，性能较差、延时较高，适用于边缘业务系统和归档数据&apos;:&apos;&apos;,</span><br><span class="line">&#125;)</span><br><span class="line">let tw = &#123;&#125;</span><br><span class="line">objkeys.map((item,i)=&gt;&#123;</span><br><span class="line">  tw[item] = llkeys[i] //生成繁体翻译文件</span><br><span class="line">  obj[item] = item //生成简体中文</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">let str = JSON.stringify(tw,&apos;&apos;,&quot;  &quot;)</span><br><span class="line">str = &apos;export default &apos;+ str</span><br><span class="line">fs.writeFile(&apos;zh-TW.js&apos;, str,function(err)&#123;</span><br><span class="line">  if(err) console.log(&apos;提取操作失败&apos;);</span><br><span class="line">  else console.log(&apos;提取操作成功&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</span><br><span class="line">str = &apos;export default &apos;+ str</span><br><span class="line">fs.writeFile(&apos;zh-CN.js&apos;, str,function(err)&#123;</span><br><span class="line">  if(err) console.log(&apos;提取操作失败&apos;);</span><br><span class="line">  else console.log(&apos;提取操作成功&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>有新页面上新需要对新老字段进行差值处理，仅新增原来没有的字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">let data = require(&apos;./words/zh-CN&apos;)</span><br><span class="line">let keys = Object.keys(data) //老数据</span><br><span class="line">let dataNew = require(&apos;./words/cnAll1&apos;) </span><br><span class="line">let keysNew = Object.keys(dataNew)//新页面数据</span><br><span class="line">let obj = &#123;&#125;</span><br><span class="line">let newWords = keysNew.filter(newkey=&gt;&#123;</span><br><span class="line">   return !keys.includes(newkey)</span><br><span class="line">&#125;).map(item=&gt;&#123;</span><br><span class="line">  obj[item]=item</span><br><span class="line">  return item</span><br><span class="line">&#125;)//得到新增的文本</span><br><span class="line">let ll = &#123;&#125; //新增文本翻译结果</span><br><span class="line">let llkeys  = Object.keys(ll)</span><br><span class="line">let objkeys = Object.keys(obj)</span><br><span class="line">let tw = &#123;&#125;</span><br><span class="line">objkeys.map((item,i)=&gt;&#123;</span><br><span class="line">  tw[item] = llkeys[i]</span><br><span class="line">&#125;)</span><br><span class="line">//生成简体和繁体翻译文件，再复制粘贴到老文件中</span><br><span class="line">// let str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</span><br><span class="line">let str = JSON.stringify(tw,&apos;&apos;,&quot;  &quot;)</span><br><span class="line">str = &apos;export default &apos;+ str</span><br><span class="line">fs.writeFile(&apos;./words/compareResult3.js&apos;, str,function(err)&#123;</span><br><span class="line">  if(err) console.log(&apos;提取操作失败&apos;);</span><br><span class="line">  else console.log(&apos;提取操作成功&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><h2 id="其他云多语言切换"><a href="#其他云多语言切换" class="headerlink" title="其他云多语言切换"></a>其他云多语言切换</h2><p>阿里云：首先会根据不同域名产生对应不同语言的站点，站点画面风格可能不同，如日本<br>另外根据语言切换，还会在同一域名下通过切换URI产生不同语言广告页面（切换时，请求cookie中会携带语言类型，aliyun_lang）<br>广告页面和站点页面可能相同，如香港，台湾的繁体页面，<br>可能不同，如简体中文和日文的时候</p>
<p>腾讯云：站点只有两种：中国站和国际站，两种站点风格不同<br>多语言切换在国际站点里面进行，同样通过切换URI，切换不同语言<br>切换时直接在query里面携带语言信息（<a href="https://intl.cloud.tencent.com/jp/?lang=jp&amp;pg=）" target="_blank" rel="noopener">https://intl.cloud.tencent.com/jp/?lang=jp&amp;pg=）</a></p>
<p>平安云：只有两种语言切换，中文和英文，使用同一站点，<br>切换时通过在cookie里面携带需要的语言类型字段language，<br>获取相应语言的html和图片</p>
<h2 id="i18n大致原理"><a href="#i18n大致原理" class="headerlink" title="i18n大致原理"></a>i18n大致原理</h2><p>i18n 的翻译原理就是在vue.use挂载i18n后,在install阶段会挂载上$t全局函数<br>我们在使用$t的时候只是单纯传入待翻译的简体中文，<br>$t会再调用VUEI18N对象上的内部方法，将当前语言环境和语言库传入，<br>然后通过message[key]的形式找到对应的翻译值，返回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$t = function (key) &#123;</span><br><span class="line">  var values = [], len = arguments.length - 1;</span><br><span class="line">  while ( len-- &gt; 0 ) values[ len ] = arguments[ len + 1 ];</span><br><span class="line"></span><br><span class="line">  var i18n = this.$i18n;</span><br><span class="line">  return i18n._t.apply(i18n, [ key, i18n.locale, i18n._getMessages(), this ].concat( values ))</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VueI18n.prototype._getMessages = function _getMessages () &#123; return this._vm.messages &#125;;</span><br><span class="line"></span><br><span class="line">//this._vm.messages 值生成</span><br><span class="line">VueI18n.prototype.setLocaleMessage = function setLocaleMessage (locale, message) &#123;</span><br><span class="line">  if (this._warnHtmlInMessage === &apos;warn&apos; || this._warnHtmlInMessage === &apos;error&apos;) &#123;</span><br><span class="line">    this._checkLocaleMessage(locale, this._warnHtmlInMessage, message);</span><br><span class="line">  &#125;</span><br><span class="line">  this._vm.$set(this._vm.messages, locale, message);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VueI18n.prototype.mergeLocaleMessage = function mergeLocaleMessage (locale, message) &#123;</span><br><span class="line">  if (this._warnHtmlInMessage === &apos;warn&apos; || this._warnHtmlInMessage === &apos;error&apos;) &#123;</span><br><span class="line">    this._checkLocaleMessage(locale, this._warnHtmlInMessage, message);</span><br><span class="line">  &#125;</span><br><span class="line">  this._vm.$set(this._vm.messages, locale, merge(&#123;&#125;, this._vm.messages[locale] || &#123;&#125;, message));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VueI18n.prototype._t = function _t (key, _locale, messages, host) &#123;</span><br><span class="line">    var ref;</span><br><span class="line"></span><br><span class="line">    var values = [], len = arguments.length - 4;</span><br><span class="line">    while ( len-- &gt; 0 ) values[ len ] = arguments[ len + 4 ];</span><br><span class="line">  if (!key) &#123; return &apos;&apos; &#125;</span><br><span class="line"></span><br><span class="line">  var parsedArgs = parseArgs.apply(void 0, values);</span><br><span class="line">  var locale = parsedArgs.locale || _locale;</span><br><span class="line"></span><br><span class="line">  var ret = this._translate(</span><br><span class="line">    messages, locale, this.fallbackLocale, key,</span><br><span class="line">    host, &apos;string&apos;, parsedArgs.params</span><br><span class="line">  );</span><br><span class="line">  if (this._isFallbackRoot(ret)) &#123;</span><br><span class="line">    if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallbackWarn(key)) &#123;</span><br><span class="line">      warn((&quot;Fall back to translate the keypath &apos;&quot; + key + &quot;&apos; with root locale.&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    /* istanbul ignore if */</span><br><span class="line">    if (!this._root) &#123; throw Error(&apos;unexpected error&apos;) &#125;</span><br><span class="line">    return (ref = this._root).$t.apply(ref, [ key ].concat( values ))</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    ret = this._warnDefault(locale, key, ret, host, values, &apos;string&apos;);</span><br><span class="line">    if (this._postTranslation) &#123;</span><br><span class="line">      ret = this._postTranslation(ret);</span><br><span class="line">    &#125;</span><br><span class="line">    return ret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VueI18n.prototype._translate = function _translate (</span><br><span class="line">  messages,</span><br><span class="line">  locale,</span><br><span class="line">  fallback,</span><br><span class="line">  key,</span><br><span class="line">  host,</span><br><span class="line">  interpolateMode,</span><br><span class="line">  args</span><br><span class="line">) &#123; </span><br><span class="line">  //messages[locale] 拿到语言库</span><br><span class="line">  var res =</span><br><span class="line">    this._interpolate(locale, messages[locale], key, host, interpolateMode, args, [key]);</span><br><span class="line">  if (!isNull(res)) &#123; return res &#125;</span><br><span class="line"></span><br><span class="line">  res = this._interpolate(fallback, messages[fallback], key, host, interpolateMode, args, [key]);</span><br><span class="line">  if (!isNull(res)) &#123;</span><br><span class="line">    if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallbackWarn(key)) &#123;</span><br><span class="line">      warn((&quot;Fall back to translate the keypath &apos;&quot; + key + &quot;&apos; with &apos;&quot; + fallback + &quot;&apos; locale.&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    return res</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VueI18n.prototype._interpolate = function _interpolate (</span><br><span class="line">  locale,</span><br><span class="line">  message,</span><br><span class="line">  key,</span><br><span class="line">  host,</span><br><span class="line">  interpolateMode,</span><br><span class="line">  values,</span><br><span class="line">  visitedLinkStack</span><br><span class="line">) &#123;</span><br><span class="line">  if (!message) &#123; return null &#125;</span><br><span class="line"></span><br><span class="line">  var pathRet = this._path.getPathValue(message, key);</span><br><span class="line">  if (Array.isArray(pathRet) || isPlainObject(pathRet)) &#123; return pathRet &#125;</span><br><span class="line"></span><br><span class="line">  var ret;</span><br><span class="line">  if (isNull(pathRet)) &#123;</span><br><span class="line">    /* istanbul ignore else */</span><br><span class="line">    if (isPlainObject(message)) &#123;</span><br><span class="line">      ret = message[key]; //从语言库里面拿到对应翻译值</span><br><span class="line">      if (typeof ret !== &apos;string&apos;) &#123;</span><br><span class="line">        if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallback(locale, key)) &#123;</span><br><span class="line">          warn((&quot;Value of key &apos;&quot; + key + &quot;&apos; is not a string!&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        return null</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    /* istanbul ignore else */</span><br><span class="line">    if (typeof pathRet === &apos;string&apos;) &#123;</span><br><span class="line">      ret = pathRet;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallback(locale, key)) &#123;</span><br><span class="line">        warn((&quot;Value of key &apos;&quot; + key + &quot;&apos; is not a string!&quot;));</span><br><span class="line">      &#125;</span><br><span class="line">      return null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Check for the existence of links within the translated string</span><br><span class="line">  if (ret.indexOf(&apos;@:&apos;) &gt;= 0 || ret.indexOf(&apos;@.&apos;) &gt;= 0) &#123;</span><br><span class="line">    ret = this._link(locale, message, ret, host, &apos;raw&apos;, values, visitedLinkStack);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return this._render(ret, interpolateMode, values, key)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VueI18n.prototype._render = function _render (message, interpolateMode, values, path) &#123;</span><br><span class="line">  var ret = this._formatter.interpolate(message, values, path);</span><br><span class="line">  // If the custom formatter refuses to work - apply the default one</span><br><span class="line">  if (!ret) &#123;</span><br><span class="line">    ret = defaultFormatter.interpolate(message, values, path);</span><br><span class="line">  &#125;</span><br><span class="line">  // if interpolateMode is **not** &apos;string&apos; (&apos;row&apos;),</span><br><span class="line">  // return the compiled data (e.g. [&apos;foo&apos;, VNode, &apos;bar&apos;]) with formatter</span><br><span class="line">  return interpolateMode === &apos;string&apos; &amp;&amp; typeof ret !== &apos;string&apos; ? ret.join(&apos;&apos;) : ret</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/nodejs/middlwareSrc.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/nodejs/middlwareSrc.html" itemprop="url">
                  KOA框架剥洋葱原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-24T17:18:37+08:00">
                2020-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="收集"><a href="#收集" class="headerlink" title="收集"></a>收集</h1><p>new 一个koa实例后，调用use接口会将传入的中间件函数push到middleware属性数组中做收集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">application.js</span><br><span class="line"></span><br><span class="line">use(fn) &#123;</span><br><span class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;middleware must be a function!&apos;);</span><br><span class="line">    if (isGeneratorFunction(fn)) &#123;</span><br><span class="line">      deprecate(&apos;Support for generators will be removed in v3. &apos; +</span><br><span class="line">                &apos;See the documentation for examples of how to convert old middleware &apos; +</span><br><span class="line">                &apos;https://github.com/koajs/koa/blob/master/docs/migration.md&apos;);</span><br><span class="line">      fn = convert(fn);</span><br><span class="line">    &#125;</span><br><span class="line">    debug(&apos;use %s&apos;, fn._name || fn.name || &apos;-&apos;);</span><br><span class="line">    this.middleware.push(fn);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>根据koa框架版本不同，需要将使用generator函数写的中间件转化成基于promise的函数形式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">const convert = require(&apos;koa-convert&apos;);</span><br><span class="line"></span><br><span class="line">function convert (mw) &#123;</span><br><span class="line">  if (typeof mw !== &apos;function&apos;) &#123;</span><br><span class="line">    throw new TypeError(&apos;middleware must be a function&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">  //再次确认是否是generator函数</span><br><span class="line">  if (mw.constructor.name !== &apos;GeneratorFunction&apos;) &#123;</span><br><span class="line">    // 假设它是一个基于promise的中间件</span><br><span class="line">    // 就直接返回</span><br><span class="line">    return mw</span><br><span class="line">  &#125;</span><br><span class="line">  //如果是generator函数就转换成promise形式</span><br><span class="line">  const converted = function (ctx, next) &#123;</span><br><span class="line">    return co.call(ctx, mw.call(ctx, createGenerator(next)))</span><br><span class="line">  &#125;</span><br><span class="line">  converted._name = mw._name || mw.name</span><br><span class="line">  return converted</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const co = require(&apos;co&apos;)</span><br><span class="line"></span><br><span class="line">function co(gen) &#123;</span><br><span class="line">  var ctx = this;</span><br><span class="line">  var args = slice.call(arguments, 1)</span><br><span class="line"></span><br><span class="line">  // we wrap everything in a promise to avoid promise chaining,</span><br><span class="line">  // which leads to memory leak errors.</span><br><span class="line">  // see https://github.com/tj/co/issues/180</span><br><span class="line">  return new Promise(function(resolve, reject) &#123;</span><br><span class="line">    if (typeof gen === &apos;function&apos;) gen = gen.apply(ctx, args);</span><br><span class="line">    if (!gen || typeof gen.next !== &apos;function&apos;) return resolve(gen);</span><br><span class="line"></span><br><span class="line">    onFulfilled();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param &#123;Mixed&#125; res</span><br><span class="line">     * @return &#123;Promise&#125;</span><br><span class="line">     * @api private</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    function onFulfilled(res) &#123;</span><br><span class="line">      var ret;</span><br><span class="line">      try &#123;</span><br><span class="line">        ret = gen.next(res);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      next(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param &#123;Error&#125; err</span><br><span class="line">     * @return &#123;Promise&#125;</span><br><span class="line">     * @api private</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    function onRejected(err) &#123;</span><br><span class="line">      var ret;</span><br><span class="line">      try &#123;</span><br><span class="line">        ret = gen.throw(err);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      next(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Get the next value in the generator,</span><br><span class="line">     * return a promise.</span><br><span class="line">     *</span><br><span class="line">     * @param &#123;Object&#125; ret</span><br><span class="line">     * @return &#123;Promise&#125;</span><br><span class="line">     * @api private</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    function next(ret) &#123;</span><br><span class="line">      if (ret.done) return resolve(ret.value);</span><br><span class="line">      var value = toPromise.call(ctx, ret.value);</span><br><span class="line">      if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);</span><br><span class="line">      return onRejected(new TypeError(&apos;You may only yield a function, promise, generator, array, or object, &apos;</span><br><span class="line">        + &apos;but the following object was passed: &quot;&apos; + String(ret.value) + &apos;&quot;&apos;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h1><p>调用listen函数开启服务时，整合所有中间件为一个大函数，大函数中进行剥洋葱流程<br>在收到请求时调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">application.js</span><br><span class="line"></span><br><span class="line">listen(...args) &#123;</span><br><span class="line">  debug(&apos;listen&apos;);</span><br><span class="line">  const server = http.createServer(this.callback());</span><br><span class="line">  return server.listen(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">callback() &#123;</span><br><span class="line">  const fn = compose(this.middleware); //整合中间件</span><br><span class="line"></span><br><span class="line">  if (!this.listenerCount(&apos;error&apos;)) this.on(&apos;error&apos;, this.onerror);</span><br><span class="line"></span><br><span class="line">  const handleRequest = (req, res) =&gt; &#123;</span><br><span class="line">    const ctx = this.createContext(req, res);</span><br><span class="line">    return this.handleRequest(ctx, fn); //调用中间件</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return handleRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handleRequest(ctx, fnMiddleware) &#123;</span><br><span class="line">  //通过传递过来的ctx,获取到原生的可写流</span><br><span class="line">  const res = ctx.res;</span><br><span class="line">  //设置默认状态码</span><br><span class="line">  res.statusCode = 404;</span><br><span class="line">  const onerror = err =&gt; ctx.onerror(err);</span><br><span class="line">  const handleResponse = () =&gt; respond(ctx);</span><br><span class="line">  onFinished(res, onerror);</span><br><span class="line">  //调用中间件大函数 同时准备catch处理中间件级错误</span><br><span class="line">  return fnMiddleware(ctx).then(handleResponse).catch(onerror); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整合中间件 ，返回大函数，大函数中有剥洋葱模型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function compose (middleware) &#123;</span><br><span class="line">  if (!Array.isArray(middleware)) throw new TypeError(&apos;Middleware stack must be an array!&apos;)</span><br><span class="line">  for (const fn of middleware) &#123;</span><br><span class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;Middleware must be composed of functions!&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">  //调用时fnMiddleware(ctx).then(handleResponse).catch(onerror); </span><br><span class="line">  //next 是undefined</span><br><span class="line">  return function (context, next) &#123;</span><br><span class="line">    // last called middleware #</span><br><span class="line">    let index = -1</span><br><span class="line">    return dispatch(0)</span><br><span class="line">    function dispatch (i) &#123;</span><br><span class="line">      if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">      index = i</span><br><span class="line">      let fn = middleware[i]</span><br><span class="line">      if (i === middleware.length) fn = next</span><br><span class="line">      if (!fn) return Promise.resolve()</span><br><span class="line">      try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</span><br><span class="line">        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span><br><span class="line">      &#125; catch (err) &#123;</span><br><span class="line">        return Promise.reject(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="剥洋葱流程"><a href="#剥洋葱流程" class="headerlink" title="剥洋葱流程"></a>剥洋葱流程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let index = -1</span><br><span class="line">return dispatch(0) //从第一个中间件开始执行</span><br><span class="line">function dispatch (i) &#123;</span><br><span class="line">  //防止next 在一个中间件中被调用多次</span><br><span class="line">  if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">  index = i</span><br><span class="line">  let fn = middleware[i] //拿到中间件</span><br><span class="line">  if (i === middleware.length) fn = next //如果中间件函数全部调用完，fn 赋值为next,next为undefined</span><br><span class="line">  if (!fn) return Promise.resolve() //fn为next=&gt;undefined时成立，即执行到最后返回一个Promise.resolve() 可以继续写then</span><br><span class="line">  try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</span><br><span class="line">    //执行中间件函数，传入ctx,next参数，next即dispatch.bind(null, i + 1)，</span><br><span class="line">    //递归调用下一个中间件函数</span><br><span class="line">    //从这一步可以实现await next()时，先执行下一个中间件函数</span><br><span class="line">    //中间件有调用next,就利用await暂停当前中间件执行，开始执行下一个中间件</span><br><span class="line">    return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    return Promise.reject(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用await暂停当前中间件执行，调用next开始执行下一个中间件</p>
<p>如果下一个中间件没有调next,且不是最后一个中间件，<br>即不会再调用dispatch执行下下一个中间件，则后续中间件都不会被执行到</p>
<p>如果下一个中间件是最后一个中间件，且在其中调用了next,则不会走到这个流程，<br>在上面的流程中就return</p>
<p>如果下一个中间件是最后一个中间件,则执行完return Promise.resolve<br>上一个中间件await 拿到结果后继续执行await后面的代码<br>执行完await后面代码后，上上一个中间件await 拿到结果，继续执行当前中间件await后代码<br>依次类推，直到第一个中间件await后代码执行完毕，整个中间件流程，<br>即剥洋葱流程先内层后外层执行流程完毕<br>返回promise 接着then处理响应或者中间有错误捕获错误<br>fnMiddleware(ctx).then(handleResponse).catch(onerror)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuex2.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuex2.html" itemprop="url">
                  vuex 源码学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-27T07:46:15+08:00">
                2020-04-27
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">let moduleA = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state()&#123; </span><br><span class="line">    return&#123;</span><br><span class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/aa/getCount&apos;] 作为b子模块时</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter~~~~~&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;,</span><br><span class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let moduleB = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state: &#123; </span><br><span class="line">    countb: 0,//this.$store.state.b.countb</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/getCount&apos;] 因为设置了namespaced所以可以重名</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter~~~~~&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</span><br><span class="line">      state.countb++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</span><br><span class="line">    aa: moduleA,//this.$store.state.b.aa.counta</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// vuex相关代码</span><br><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123; </span><br><span class="line">    count: 0, //this.$store.state.count</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters.getCount</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    a: moduleA, //this.$store.state.a.counta</span><br><span class="line">    b: moduleB //this.$store.state.b.countb</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上面store结构为例，分析vuex源码</p>
<h1 id="new-Store"><a href="#new-Store" class="headerlink" title="new Store"></a>new Store</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">var Store = function Store (options) &#123;</span><br><span class="line">   var this$1 = this;</span><br><span class="line">   if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line">   if (!Vue &amp;&amp; typeof window !== &apos;undefined&apos; &amp;&amp; window.Vue) &#123;</span><br><span class="line">     install(window.Vue);</span><br><span class="line">   &#125;</span><br><span class="line">   var plugins = options.plugins; if ( plugins === void 0 ) plugins = [];</span><br><span class="line">   var strict = options.strict; if ( strict === void 0 ) strict = false;</span><br><span class="line"></span><br><span class="line">   // 一些内部参数</span><br><span class="line">   this._committing = false;</span><br><span class="line">   this._actions = Object.create(null);</span><br><span class="line">   this._actionSubscribers = [];</span><br><span class="line">   this._mutations = Object.create(null);</span><br><span class="line">   this._wrappedGetters = Object.create(null);</span><br><span class="line">   this._modules = new ModuleCollection(options);</span><br><span class="line">   this._modulesNamespaceMap = Object.create(null);</span><br><span class="line">   this._subscribers = [];</span><br><span class="line">   this._watcherVM = new Vue();</span><br><span class="line">   this._makeLocalGettersCache = Object.create(null);</span><br><span class="line"></span><br><span class="line">   //绑定 commit 和 dispatch 的执行对象始终指向自己，防止外界重新绑定</span><br><span class="line">   var store = this;</span><br><span class="line">   var ref = this;</span><br><span class="line">   var dispatch = ref.dispatch;</span><br><span class="line">   var commit = ref.commit;</span><br><span class="line">   this.dispatch = function boundDispatch (type, payload) &#123;</span><br><span class="line">     return dispatch.call(store, type, payload)</span><br><span class="line">   &#125;;</span><br><span class="line">   this.commit = function boundCommit (type, payload, options) &#123;</span><br><span class="line">     return commit.call(store, type, payload, options)</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   // 严格模式</span><br><span class="line">   //使 Vuex store 进入严格模式，在严格模式下，任何 mutation 处理函数以外修改 Vuex state 都会抛出错误。</span><br><span class="line">   this.strict = strict;</span><br><span class="line">   //拿到处理后的state</span><br><span class="line">   var state = this._modules.root.state;</span><br><span class="line"></span><br><span class="line">   // 初始化全局module</span><br><span class="line">   // 同时递归注册所有子模块</span><br><span class="line">   // 收集this._wrappedGetters中的所有模块的getters</span><br><span class="line">   installModule(this, state, [], this._modules.root);</span><br><span class="line"></span><br><span class="line">   // 初始化store vm, 用于数据响应</span><br><span class="line">   // 同时注册 _wrappedGetters 作为计算属性)</span><br><span class="line">   resetStoreVM(this, state);</span><br><span class="line"></span><br><span class="line">   // 使用插件处理</span><br><span class="line">   plugins.forEach(function (plugin) &#123; return plugin(this$1); &#125;);</span><br><span class="line">   //options.devtools为某个特定的 Vuex 实例打开或关闭 devtools。</span><br><span class="line">   //对于传入 false 的实例来说 Vuex store 不会订阅到 devtools 插件。可用于一个页面中有多个 store 的情况</span><br><span class="line">   var useDevtools = options.devtools !== undefined ? options.devtools : Vue.config.devtools;</span><br><span class="line">   if (useDevtools) &#123;</span><br><span class="line">     devtoolPlugin(this);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">function install (_Vue) &#123;</span><br><span class="line">  if (Vue &amp;&amp; _Vue === Vue) &#123;</span><br><span class="line">    //Vue.use(Vuex) should be called only once</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  Vue = _Vue;</span><br><span class="line">  applyMixin(Vue);</span><br><span class="line">&#125;</span><br><span class="line">function applyMixin (Vue) &#123;</span><br><span class="line">  var version = Number(Vue.version.split(&apos;.&apos;)[0]);</span><br><span class="line"></span><br><span class="line">  if (version &gt;= 2) &#123;</span><br><span class="line">    Vue.mixin(&#123; beforeCreate: vuexInit &#125;); //使用beforeCreate将$store绑定到每个VueComponent 上</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    //小于版本2的用_init初始化</span><br><span class="line">    var _init = Vue.prototype._init;</span><br><span class="line">    Vue.prototype._init = function (options) &#123;</span><br><span class="line">      if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">      options.init = options.init</span><br><span class="line">        ? [vuexInit].concat(options.init)</span><br><span class="line">        : vuexInit;</span><br><span class="line">      _init.call(this, options);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function vuexInit () &#123;</span><br><span class="line">    var options = this.$options;</span><br><span class="line">    // store injection</span><br><span class="line">    if (options.store) &#123;</span><br><span class="line">      this.$store = typeof options.store === &apos;function&apos;</span><br><span class="line">        ? options.store()</span><br><span class="line">        : options.store;</span><br><span class="line">    &#125; else if (options.parent &amp;&amp; options.parent.$store) &#123;</span><br><span class="line">      this.$store = options.parent.$store; //当前组件$store指向父组件$store，递归指向，从而保证唯一性</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ModuleCollection"><a href="#ModuleCollection" class="headerlink" title="ModuleCollection"></a>ModuleCollection</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var ModuleCollection = function ModuleCollection (rawRootModule) &#123;</span><br><span class="line">    // 根据new Store 传入的参数，注册根模块</span><br><span class="line">    this.register([], rawRootModule, false);</span><br><span class="line">  &#125;;</span><br><span class="line">  // new store 时传入的参数 [], rawRootModule, false</span><br><span class="line">  ModuleCollection.prototype.register = function register (path, rawModule, runtime) &#123;</span><br><span class="line">    var this$1 = this;</span><br><span class="line">    if ( runtime === void 0 ) runtime = true;</span><br><span class="line">    var newModule = new Module(rawModule, runtime);</span><br><span class="line">    //&#123;runtime:false,_children:&#123;&#125;,_rawModule:rawModule,state:rawModule上面的state,__proto__:一系列方法&#125;</span><br><span class="line">    if (path.length === 0) &#123;</span><br><span class="line">      this.root = newModule; //初始化根模块</span><br><span class="line">    &#125; else &#123; //初始化子模块</span><br><span class="line">      var parent = this.get(path.slice(0, -1)); //拿到父模块</span><br><span class="line">      parent.addChild(path[path.length - 1], newModule); //给父模块_children属性增加子模块</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 注册嵌套模块</span><br><span class="line">    if (rawModule.modules) &#123;</span><br><span class="line">      forEachValue(rawModule.modules, function (rawChildModule, key) &#123;</span><br><span class="line">        this$1.register(path.concat(key), rawChildModule, runtime); //递归注册</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var Module = function Module (rawModule, runtime) &#123;</span><br><span class="line">  this.runtime = runtime;</span><br><span class="line">  // Store some children item</span><br><span class="line">  this._children = Object.create(null);</span><br><span class="line">  // Store the origin module object which passed by programmer</span><br><span class="line">  this._rawModule = rawModule;</span><br><span class="line">  var rawState = rawModule.state;</span><br><span class="line"></span><br><span class="line">  // Store the origin module&apos;s state</span><br><span class="line">  this.state = (typeof rawState === &apos;function&apos; ? rawState() : rawState) || &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Module.prototype.addChild = function addChild (key, module) &#123;</span><br><span class="line">  this._children[key] = module;</span><br><span class="line">&#125;;</span><br><span class="line">Module.prototype.getChild = function getChild (key) &#123;</span><br><span class="line">  return this._children[key]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>  所以这一步结束后<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this._modules = new ModuleCollection(options);</span><br></pre></td></tr></table></figure></p>
<p>  this._modules为如下对象<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection &#123;</span><br><span class="line">  root: Module &#123;</span><br><span class="line">    runtime: false,</span><br><span class="line">    _children: &#123;a: Module, b: Module&#125;</span><br><span class="line">    _rawModule: &#123;state: &#123;…&#125;, mutations: &#123;…&#125;, modules: &#123;…&#125;&#125;</span><br><span class="line">    state: &#123;count: 0&#125;</span><br><span class="line">    __proto__: Object</span><br><span class="line">  &#125;</span><br><span class="line">  __proto__: Object</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  ModuleCollection对象上的其他方法<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection.prototype.get = function get (path) &#123;</span><br><span class="line">  return path.reduce(function (module, key) &#123;</span><br><span class="line">    return module.getChild(key)</span><br><span class="line">  &#125;, this.root)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ModuleCollection.prototype.getNamespace = function getNamespace (path) &#123;</span><br><span class="line">  var module = this.root;</span><br><span class="line">  //对设置了namespaced的模块进行拼接</span><br><span class="line">  return path.reduce(function (namespace, key) &#123;</span><br><span class="line">    module = module.getChild(key); //从_children取出子模块</span><br><span class="line">    return namespace + (module.namespaced ? key + &apos;/&apos; : &apos;&apos;)</span><br><span class="line">  &#125;, &apos;&apos;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ModuleCollection.prototype.update = function update$1 (rawRootModule) &#123;</span><br><span class="line">  update([], this.root, rawRootModule);</span><br><span class="line">&#125;;</span><br><span class="line">ModuleCollection.prototype.unregister = function unregister (path) &#123;</span><br><span class="line">  var parent = this.get(path.slice(0, -1));</span><br><span class="line">  var key = path[path.length - 1];</span><br><span class="line">  if (!parent.getChild(key).runtime) &#123; return &#125;</span><br><span class="line"></span><br><span class="line">  parent.removeChild(key);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1 id="installModule"><a href="#installModule" class="headerlink" title="installModule"></a>installModule</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">//初始化调用时传参 （this, state, [], this._modules.root)</span><br><span class="line">function installModule (store, rootState, path, module, hot) &#123;</span><br><span class="line">  //根模块时，参数分别为store本身，根模块state, [], 根模块，undefined</span><br><span class="line">  //递归子模块时，参数为 store本身，根模块state,子模块在modules对象中的路径key值</span><br><span class="line">  var isRoot = !path.length; //空数组即根模块</span><br><span class="line">  //ModuleCollection.prototype.getNamespace 根模块返回空字符串&apos;&apos;</span><br><span class="line">  var namespace = store._modules.getNamespace(path); </span><br><span class="line"></span><br><span class="line">  //如果模块设置了命名空间 在store._modulesNamespaceMap属性中注册</span><br><span class="line">  if (module.namespaced) &#123;</span><br><span class="line">    if (store._modulesNamespaceMap[namespace] &amp;&amp; &quot;development&quot; !== &apos;production&apos;) &#123;</span><br><span class="line">      console.error((&quot;[vuex] duplicate namespace &quot; + namespace + &quot; for the namespaced module &quot; + (path.join(&apos;/&apos;))));</span><br><span class="line">    &#125;</span><br><span class="line">    store._modulesNamespaceMap[namespace] = module;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //对子模块state进行数据劫持处理</span><br><span class="line">  if (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">    var parentState = getNestedState(rootState, path.slice(0, -1));</span><br><span class="line">    var moduleName = path[path.length - 1];</span><br><span class="line">    store._withCommit(function () &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        if (moduleName in parentState) &#123;</span><br><span class="line">          console.warn(</span><br><span class="line">            (&quot;[vuex] state field \&quot;&quot; + moduleName + &quot;\&quot; was overridden by a module with the same name at \&quot;&quot; + (path.join(&apos;.&apos;)) + &quot;\&quot;&quot;)</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      Vue.set(parentState, moduleName, module.state); //将子模块state按照模块名添加到父模块state中</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  //根据有无namespace</span><br><span class="line">  //截取state,getter的get,</span><br><span class="line">  //封装触发函数dispactch和commit,有namespace拼接后再触发</span><br><span class="line">  var local = module.context = makeLocalContext(store, namespace, path);</span><br><span class="line"></span><br><span class="line">  module.forEachMutation(function (mutation, key) &#123;</span><br><span class="line">    var namespacedType = namespace + key;</span><br><span class="line">    registerMutation(store, namespacedType, mutation, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  module.forEachAction(function (action, key) &#123;</span><br><span class="line">    var type = action.root ? key : namespace + key;</span><br><span class="line">    var handler = action.handler || action;</span><br><span class="line">    registerAction(store, type, handler, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  module.forEachGetter(function (getter, key) &#123;</span><br><span class="line">    var namespacedType = namespace + key;</span><br><span class="line">    registerGetter(store, namespacedType, getter, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  module.forEachChild(function (child, key) &#123;</span><br><span class="line">    installModule(store, rootState, path.concat(key), child, hot);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="forEachValue"><a href="#forEachValue" class="headerlink" title="forEachValue"></a>forEachValue</h2><p>公共方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function forEachValue (obj, fn) &#123;</span><br><span class="line">   Object.keys(obj).forEach(function (key) &#123; return fn(obj[key], key); &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="注册-Mutation"><a href="#注册-Mutation" class="headerlink" title="注册 Mutation"></a>注册 Mutation</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachMutation = function forEachMutation (fn) &#123;</span><br><span class="line">  if (this._rawModule.mutations) &#123;</span><br><span class="line">    forEachValue(this._rawModule.mutations, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">//参数：store本身，经过namespace拼接后的类型标记，具体对应的mutation,当前模块上封装好的state,getters,commit,dispatch</span><br><span class="line">function registerMutation (store, type, handler, local) &#123;</span><br><span class="line">  var entry = store._mutations[type] || (store._mutations[type] = []);</span><br><span class="line">  entry.push(function wrappedMutationHandler (payload) &#123;</span><br><span class="line">    handler.call(store, local.state, payload);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结：将当前模块的mutations上的各个mutations结合namespace存储到store._mutations属性上<br>可见，如果子模块没有namespace,同名的mutation会跟根模块的mutation存储在相同的type下面<br>所以当触发commit的时候会一起执行，<br>如果子模块设置了namespace，这时存储的type会包含该模块对应的名称，<br>即使同名的mutation也被存放在不同的type中，实现了隔离</p>
<h2 id="注册-Action"><a href="#注册-Action" class="headerlink" title="注册 Action"></a>注册 Action</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachAction = function forEachAction (fn) &#123;</span><br><span class="line">  if (this._rawModule.actions) &#123;</span><br><span class="line">    forEachValue(this._rawModule.actions, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function registerAction (store, type, handler, local) &#123;</span><br><span class="line">  var entry = store._actions[type] || (store._actions[type] = []);</span><br><span class="line">  entry.push(function wrappedActionHandler (payload) &#123;</span><br><span class="line">    var res = handler.call(store, &#123;</span><br><span class="line">      dispatch: local.dispatch,</span><br><span class="line">      commit: local.commit,</span><br><span class="line">      getters: local.getters,</span><br><span class="line">      state: local.state,</span><br><span class="line">      rootGetters: store.getters,</span><br><span class="line">      rootState: store.state</span><br><span class="line">    &#125;, payload);</span><br><span class="line">    if (!isPromise(res)) &#123;</span><br><span class="line">      res = Promise.resolve(res);</span><br><span class="line">    &#125;</span><br><span class="line">    if (store._devtoolHook) &#123;</span><br><span class="line">      return res.catch(function (err) &#123;</span><br><span class="line">        store._devtoolHook.emit(&apos;vuex:error&apos;, err);</span><br><span class="line">        throw err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结：将当前模块的actions上的各个action结合namespace存储到store._actions属性上</p>
<h2 id="注册-Getter"><a href="#注册-Getter" class="headerlink" title="注册 Getter"></a>注册 Getter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachGetter = function forEachGetter (fn) &#123;</span><br><span class="line">  if (this._rawModule.getters) &#123;</span><br><span class="line">    forEachValue(this._rawModule.getters, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function registerGetter (store, type, rawGetter, local) &#123;</span><br><span class="line">  if (store._wrappedGetters[type]) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      console.error((&quot;[vuex] duplicate getter key: &quot; + type));</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  store._wrappedGetters[type] = function wrappedGetter (store) &#123;</span><br><span class="line">    return rawGetter(</span><br><span class="line">      local.state, // 当前模块state</span><br><span class="line">      local.getters, // 当前模块 getters</span><br><span class="line">      store.state, // 根模块 state</span><br><span class="line">      store.getters // 根模块 getters</span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结：将当前模块的getters上的各个getter结合namespace存储到store._wrappedGetters属性上</p>
<h2 id="注册-Module"><a href="#注册-Module" class="headerlink" title="注册 Module"></a>注册 Module</h2><p>递归调用installModule注册子模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachChild = function forEachChild (fn) &#123;</span><br><span class="line">  forEachValue(this._children, fn);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module.forEachChild(function (child, key) &#123;</span><br><span class="line">  installModule(store, rootState, path.concat(key), child, hot);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="makeLocalContext"><a href="#makeLocalContext" class="headerlink" title="makeLocalContext"></a>makeLocalContext</h2><p>优化 dispatch, commit, getters and state<br>如果没有设置namespace, 就使用根模块的名称<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">  function makeLocalContext (store, namespace, path) &#123;</span><br><span class="line">    var noNamespace = namespace === &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    var local = &#123;</span><br><span class="line">      dispatch: noNamespace ? store.dispatch : function (_type, _payload, _options) &#123;</span><br><span class="line">        var args = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">        var payload = args.payload;</span><br><span class="line">        var options = args.options;</span><br><span class="line">        var type = args.type;</span><br><span class="line"></span><br><span class="line">        if (!options || !options.root) &#123;</span><br><span class="line">          type = namespace + type;//有namespace拼接后再触发</span><br><span class="line">          if (!store._actions[type]) &#123;</span><br><span class="line">            console.error((&quot;[vuex] unknown local action type: &quot; + (args.type) + &quot;, global type: &quot; + type));</span><br><span class="line">            return</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return store.dispatch(type, payload)</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      commit: noNamespace ? store.commit : function (_type, _payload, _options) &#123;</span><br><span class="line">        var args = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">        var payload = args.payload;</span><br><span class="line">        var options = args.options;</span><br><span class="line">        var type = args.type;</span><br><span class="line"></span><br><span class="line">        if (!options || !options.root) &#123;</span><br><span class="line">          type = namespace + type; //有namespace拼接后再触发</span><br><span class="line">          if (!store._mutations[type]) &#123;</span><br><span class="line">            console.error((&quot;[vuex] unknown local mutation type: &quot; + (args.type) + &quot;, global type: &quot; + type));</span><br><span class="line">            return</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        store.commit(type, payload, options);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // getters and state object must be gotten lazily</span><br><span class="line">    // because they will be changed by vm update</span><br><span class="line">    Object.defineProperties(local, &#123;</span><br><span class="line">      getters: &#123;</span><br><span class="line">        get: noNamespace</span><br><span class="line">          ? function () &#123; return store.getters; &#125;</span><br><span class="line">          : function () &#123; return makeLocalGetters(store, namespace); &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      state: &#123;</span><br><span class="line">        get: function () &#123; return getNestedState(store.state, path); &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return local</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">function makeLocalGetters (store, namespace) &#123;</span><br><span class="line">  if (!store._makeLocalGettersCache[namespace]) &#123;</span><br><span class="line">    var gettersProxy = &#123;&#125;;</span><br><span class="line">    var splitPos = namespace.length;</span><br><span class="line">    Object.keys(store.getters).forEach(function (type) &#123;</span><br><span class="line">      // skip if the target getter is not match this namespace</span><br><span class="line">      if (type.slice(0, splitPos) !== namespace) &#123; return &#125;</span><br><span class="line"></span><br><span class="line">      // extract local getter type</span><br><span class="line">      var localType = type.slice(splitPos);</span><br><span class="line"></span><br><span class="line">      // Add a port to the getters proxy.</span><br><span class="line">      // Define as getter property because</span><br><span class="line">      // we do not want to evaluate the getters in this time.</span><br><span class="line">      Object.defineProperty(gettersProxy, localType, &#123;</span><br><span class="line">        get: function () &#123; return store.getters[type]; &#125;,</span><br><span class="line">        enumerable: true</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    store._makeLocalGettersCache[namespace] = gettersProxy;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return store._makeLocalGettersCache[namespace]</span><br><span class="line">&#125;</span><br><span class="line">function getNestedState (state, path) &#123;</span><br><span class="line">  return path.reduce(function (state, key) &#123; return state[key]; &#125;, state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>该步骤完成后</p>
<p>store对象长这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">commit: ƒ boundCommit(type, payload, options)</span><br><span class="line">dispatch: ƒ boundDispatch(type, payload)</span><br><span class="line">strict: false</span><br><span class="line">_actionSubscribers: []</span><br><span class="line">_actions: &#123;&#125; //存放所有模块的action</span><br><span class="line">_committing: false</span><br><span class="line">_makeLocalGettersCache: &#123;&#125;</span><br><span class="line">_modules: ModuleCollection &#123;</span><br><span class="line">  root: Module</span><br><span class="line">  context: //新增根据namespace处理后的触发函数</span><br><span class="line">    commit: ƒ boundCommit(type, payload, options)</span><br><span class="line">    dispatch: ƒ boundDispatch(type, payload)</span><br><span class="line">    getters: (...)</span><br><span class="line">    state: (...)</span><br><span class="line">    get getters: ƒ ()</span><br><span class="line">    get state: ƒ ()</span><br><span class="line">    __proto__: Object</span><br><span class="line">  runtime: false</span><br><span class="line">  state: //将子模块state集中到根模块state</span><br><span class="line">    a: &#123;counta: 2329&#125;</span><br><span class="line">    b:</span><br><span class="line">      aa: &#123;counta: 2329&#125;</span><br><span class="line">      countb: 0</span><br><span class="line">      __proto__: Object</span><br><span class="line">    count: 0</span><br><span class="line">    __proto__: Object</span><br><span class="line">  _children: //对子模块递归过程挂载context属性</span><br><span class="line">    a: Module &#123;runtime: false, _children: &#123;…&#125;, _rawModule: &#123;…&#125;, state: &#123;…&#125;, context: &#123;…&#125;&#125;</span><br><span class="line">    b: Module &#123;runtime: false, _children: &#123;…&#125;, _rawModule: &#123;…&#125;, state: &#123;…&#125;, context: &#123;…&#125;&#125;</span><br><span class="line">  _rawModule: &#123;state: &#123;…&#125;, mutations: &#123;…&#125;, modules: &#123;…&#125;&#125;</span><br><span class="line">  namespaced: (...)</span><br><span class="line">  __proto__: Object</span><br><span class="line">__proto__: Object</span><br><span class="line">&#125;</span><br><span class="line">_modulesNamespaceMap: &#123;b/: Module&#125; //存放设置了namespace的模块</span><br><span class="line">_mutations: &#123;increment: Array(1), incrementaaa: Array(1), b/increment: Array(1), b/incrementaaa: Array(1)&#125; //存放所有模块的mutation</span><br><span class="line">_subscribers: []</span><br><span class="line">_watcherVM: Vue &#123;_uid: 0, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: Vue, …&#125;</span><br><span class="line">_wrappedGetters: &#123;&#125; //存放所有模块的getters</span><br><span class="line">state: (...) //对局部变量做了处理，还没有挂到store上</span><br></pre></td></tr></table></figure>
<h1 id="resetStoreVM"><a href="#resetStoreVM" class="headerlink" title="resetStoreVM"></a>resetStoreVM</h1><p>利用vue的数据处理逻辑，解决getters和state之间订阅发布关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">function partial (fn, arg) &#123;</span><br><span class="line">  return function () &#123;</span><br><span class="line">    return fn(arg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function resetStoreVM (store, state, hot) &#123;</span><br><span class="line">    var oldVm = store._vm;</span><br><span class="line">    //绑定存储公共的getters</span><br><span class="line">    store.getters = &#123;&#125;;</span><br><span class="line">    // 重置内部getters缓存到_makeLocalGettersCache</span><br><span class="line">    store._makeLocalGettersCache = Object.create(null);</span><br><span class="line">    var wrappedGetters = store._wrappedGetters;</span><br><span class="line">    var computed = &#123;&#125;;</span><br><span class="line">    forEachValue(wrappedGetters, function (fn, key) &#123;</span><br><span class="line">      //如果直接使用，闭包里面会包含oldVm</span><br><span class="line">      computed[key] = partial(fn, store);</span><br><span class="line">      Object.defineProperty(store.getters, key, &#123;</span><br><span class="line">        get: function () &#123; return store._vm[key]; &#125;,//直接调用vue的compute属性</span><br><span class="line">        enumerable: true // for local getters</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //使用vue实例存放state和getters</span><br><span class="line">    var silent = Vue.config.silent;</span><br><span class="line">    /* Vue.config.silent暂时设置为true的目的是在new一个Vue实例的过程中不会报出一切警告 */</span><br><span class="line">    Vue.config.silent = true</span><br><span class="line">    store._vm = new Vue(&#123;</span><br><span class="line">      data: &#123;</span><br><span class="line">        $$state: state</span><br><span class="line">      &#125;,</span><br><span class="line">      computed: computed</span><br><span class="line">    &#125;);</span><br><span class="line">    Vue.config.silent = silent;</span><br><span class="line"></span><br><span class="line">     /* 使能严格模式，保证修改store只能通过mutation */</span><br><span class="line">    if (store.strict) &#123;</span><br><span class="line">      enableStrictMode(store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (oldVm) &#123;</span><br><span class="line">      if (hot) &#123;</span><br><span class="line">        // dispatch changes in all subscribed watchers</span><br><span class="line">        // to force getter re-evaluation for hot reloading.</span><br><span class="line">        store._withCommit(function () &#123;</span><br><span class="line">          oldVm._data.$$state = null;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      Vue.nextTick(function () &#123; return oldVm.$destroy(); &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="store上的其他方法"><a href="#store上的其他方法" class="headerlink" title="store上的其他方法"></a>store上的其他方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">Store.prototype.commit = function commit (_type, _payload, _options) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line"></span><br><span class="line">  // check object-style commit</span><br><span class="line">  var ref = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">  var type = ref.type;</span><br><span class="line">  var payload = ref.payload;</span><br><span class="line">  var options = ref.options;</span><br><span class="line"></span><br><span class="line">  var mutation = &#123; type: type, payload: payload &#125;;</span><br><span class="line">  var entry = this._mutations[type];</span><br><span class="line">  if (!entry) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      console.error((&quot;[vuex] unknown mutation type: &quot; + type));</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  this._withCommit(function () &#123;</span><br><span class="line">    entry.forEach(function commitIterator (handler) &#123;</span><br><span class="line">      handler(payload);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  this._subscribers</span><br><span class="line">    .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span><br><span class="line">    .forEach(function (sub) &#123; return sub(mutation, this$1.state); &#125;);</span><br><span class="line"></span><br><span class="line">  if (</span><br><span class="line">    options &amp;&amp; options.silent</span><br><span class="line">  ) &#123;</span><br><span class="line">    console.warn(</span><br><span class="line">      &quot;[vuex] mutation type: &quot; + type + &quot;. Silent option has been removed. &quot; +</span><br><span class="line">      &apos;Use the filter functionality in the vue-devtools&apos;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Store.prototype.dispatch = function dispatch (_type, _payload) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    // check object-style dispatch</span><br><span class="line">    var ref = unifyObjectStyle(_type, _payload);</span><br><span class="line">      var type = ref.type;</span><br><span class="line">      var payload = ref.payload;</span><br><span class="line"></span><br><span class="line">    var action = &#123; type: type, payload: payload &#125;;</span><br><span class="line">    var entry = this._actions[type];</span><br><span class="line">    if (!entry) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        console.error((&quot;[vuex] unknown action type: &quot; + type));</span><br><span class="line">      &#125;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      this._actionSubscribers</span><br><span class="line">        .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span><br><span class="line">        .filter(function (sub) &#123; return sub.before; &#125;)</span><br><span class="line">        .forEach(function (sub) &#123; return sub.before(action, this$1.state); &#125;);</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        console.warn(&quot;[vuex] error in before action subscribers: &quot;);</span><br><span class="line">        console.error(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var result = entry.length &gt; 1</span><br><span class="line">      ? Promise.all(entry.map(function (handler) &#123; return handler(payload); &#125;))</span><br><span class="line">      : entry[0](payload);</span><br><span class="line"></span><br><span class="line">    return result.then(function (res) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        this$1._actionSubscribers</span><br><span class="line">          .filter(function (sub) &#123; return sub.after; &#125;)</span><br><span class="line">          .forEach(function (sub) &#123; return sub.after(action, this$1.state); &#125;);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          console.warn(&quot;[vuex] error in after action subscribers: &quot;);</span><br><span class="line">          console.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return res</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.subscribe = function subscribe (fn) &#123;</span><br><span class="line">    return genericSubscribe(fn, this._subscribers)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.subscribeAction = function subscribeAction (fn) &#123;</span><br><span class="line">    var subs = typeof fn === &apos;function&apos; ? &#123; before: fn &#125; : fn;</span><br><span class="line">    return genericSubscribe(subs, this._actionSubscribers)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.watch = function watch (getter, cb, options) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      assert(typeof getter === &apos;function&apos;, &quot;store.watch only accepts a function.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return this._watcherVM.$watch(function () &#123; return getter(this$1.state, this$1.getters); &#125;, cb, options)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.replaceState = function replaceState (state) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    this._withCommit(function () &#123;</span><br><span class="line">      this$1._vm._data.$$state = state;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.registerModule = function registerModule (path, rawModule, options) &#123;</span><br><span class="line">      if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    if (typeof path === &apos;string&apos;) &#123; path = [path]; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      assert(Array.isArray(path), &quot;module path must be a string or an Array.&quot;);</span><br><span class="line">      assert(path.length &gt; 0, &apos;cannot register the root module by using registerModule.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this._modules.register(path, rawModule);</span><br><span class="line">    installModule(this, this.state, path, this._modules.get(path), options.preserveState);</span><br><span class="line">    // reset store to update getters...</span><br><span class="line">    resetStoreVM(this, this.state);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.unregisterModule = function unregisterModule (path) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    if (typeof path === &apos;string&apos;) &#123; path = [path]; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      assert(Array.isArray(path), &quot;module path must be a string or an Array.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this._modules.unregister(path);</span><br><span class="line">    this._withCommit(function () &#123;</span><br><span class="line">      var parentState = getNestedState(this$1.state, path.slice(0, -1));</span><br><span class="line">      Vue.delete(parentState, path[path.length - 1]);</span><br><span class="line">    &#125;);</span><br><span class="line">    resetStore(this);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.hotUpdate = function hotUpdate (newOptions) &#123;</span><br><span class="line">    this._modules.update(newOptions);</span><br><span class="line">    resetStore(this, true);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype._withCommit = function _withCommit (fn) &#123;</span><br><span class="line">    var committing = this._committing;</span><br><span class="line">    this._committing = true;</span><br><span class="line">    fn();</span><br><span class="line">    this._committing = committing;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  function genericSubscribe (fn, subs) &#123;</span><br><span class="line">    if (subs.indexOf(fn) &lt; 0) &#123;</span><br><span class="line">      subs.push(fn);</span><br><span class="line">    &#125;</span><br><span class="line">    return function () &#123;</span><br><span class="line">      var i = subs.indexOf(fn);</span><br><span class="line">      if (i &gt; -1) &#123;</span><br><span class="line">        subs.splice(i, 1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function resetStore (store, hot) &#123;</span><br><span class="line">    store._actions = Object.create(null);</span><br><span class="line">    store._mutations = Object.create(null);</span><br><span class="line">    store._wrappedGetters = Object.create(null);</span><br><span class="line">    store._modulesNamespaceMap = Object.create(null);</span><br><span class="line">    var state = store.state;</span><br><span class="line">    // init all modules</span><br><span class="line">    installModule(store, state, [], store._modules.root, true);</span><br><span class="line">    // reset vm</span><br><span class="line">    resetStoreVM(store, state, hot);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/src4.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/src4.html" itemprop="url">
                  vue 源码学习四【数据双向绑定】
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-11T22:58:15+08:00">
                2020-04-11
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vue双向绑定原理，依赖收集是<br>在created声明周期之前，<br>render生成虚拟dom的时候<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._init = function (options) &#123;</span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor),</span><br><span class="line">    options || &#123;&#125;,</span><br><span class="line">    vm</span><br><span class="line">  );</span><br><span class="line">  callHook(vm, &apos;beforeCreate&apos;);//运行订阅了beforecreate钩子的相关方法</span><br><span class="line">  initState(vm);//处理数据</span><br><span class="line">  callHook(vm, &apos;created&apos;);</span><br></pre></td></tr></table></figure></p>
<h1 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h1><p>转换成内置函数mergedInstanceDataFn<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">function mergeOptions (</span><br><span class="line">   parent,</span><br><span class="line">   child,</span><br><span class="line">   vm</span><br><span class="line"> ) &#123;</span><br><span class="line">   &#123;</span><br><span class="line">     checkComponents(child);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   if (typeof child === &apos;function&apos;) &#123;</span><br><span class="line">     child = child.options;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // ... normalizeProps, normalizeInject, normalizeDirectives</span><br><span class="line"></span><br><span class="line">   if (!child._base) &#123;</span><br><span class="line">     if (child.extends) &#123;</span><br><span class="line">       parent = mergeOptions(parent, child.extends, vm);</span><br><span class="line">     &#125;</span><br><span class="line">     if (child.mixins) &#123;</span><br><span class="line">       for (var i = 0, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">         parent = mergeOptions(parent, child.mixins[i], vm);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   var options = &#123;&#125;;</span><br><span class="line">   var key;</span><br><span class="line">   for (key in parent) &#123;</span><br><span class="line">     mergeField(key);</span><br><span class="line">   &#125;</span><br><span class="line">   for (key in child) &#123;</span><br><span class="line">     if (!hasOwn(parent, key)) &#123;</span><br><span class="line">       mergeField(key);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   //在上面的循环中会遍历到配置的options参数里的data属性，则会调用到strats.data</span><br><span class="line">   function mergeField (key) &#123; </span><br><span class="line">     var strat = strats[key] || defaultStrat;</span><br><span class="line">     options[key] = strat(parent[key], child[key], vm, key);</span><br><span class="line">   &#125;</span><br><span class="line">   return options</span><br><span class="line"> &#125;</span><br><span class="line"> //</span><br><span class="line"> strats.data = function (</span><br><span class="line">   parentVal,</span><br><span class="line">   childVal,</span><br><span class="line">   vm</span><br><span class="line"> ) &#123;</span><br><span class="line">   if (!vm) &#123;</span><br><span class="line">     //...vm就是VUE实例，所以不会走这里</span><br><span class="line">     return mergeDataOrFn(parentVal, childVal)</span><br><span class="line">   &#125;</span><br><span class="line">   return mergeDataOrFn(parentVal, childVal, vm)</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> function mergeDataOrFn (</span><br><span class="line">   parentVal,</span><br><span class="line">   childVal,</span><br><span class="line">   vm</span><br><span class="line"> ) &#123;</span><br><span class="line">   if (!vm) &#123;</span><br><span class="line">     ...</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     return function mergedInstanceDataFn () &#123;</span><br><span class="line">       // instance merge</span><br><span class="line">       var instanceData = typeof childVal === &apos;function&apos;</span><br><span class="line">         ? childVal.call(vm, vm)</span><br><span class="line">         : childVal;</span><br><span class="line">       var defaultData = typeof parentVal === &apos;function&apos;</span><br><span class="line">         ? parentVal.call(vm, vm)</span><br><span class="line">         : parentVal;</span><br><span class="line">       if (instanceData) &#123;</span><br><span class="line">         return mergeData(instanceData, defaultData)</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">         return defaultData</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这一步结束后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vm.$options.data = function mergedInstanceDataFn () &#123;</span><br><span class="line">  //声明时传递进来的data属性值,是函数则执行拿到对象</span><br><span class="line">  var instanceData = typeof childVal === &apos;function&apos; </span><br><span class="line">    ? childVal.call(vm, vm)</span><br><span class="line">    : childVal;</span><br><span class="line">  //内部属性没有data属性，所以 defaultData 为undefined</span><br><span class="line">  var defaultData = typeof parentVal === &apos;function&apos;</span><br><span class="line">    ? parentVal.call(vm, vm)</span><br><span class="line">    : parentVal;</span><br><span class="line">  if (instanceData) &#123;</span><br><span class="line">    return mergeData(instanceData, defaultData)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return defaultData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function mergeData (to, from) &#123;</span><br><span class="line">  if (!from) &#123; return to &#125;</span><br><span class="line">  ...//省略若干逻辑</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="数据劫持"><a href="#数据劫持" class="headerlink" title="数据劫持"></a>数据劫持</h1><p>开始进行真正初始化—数据劫持<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function initState (vm) &#123;</span><br><span class="line">  vm._watchers = [];</span><br><span class="line">  var opts = vm.$options;</span><br><span class="line">  if (opts.data) &#123;</span><br><span class="line">    initData(vm);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    observe(vm._data = &#123;&#125;, true /* asRootData */);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function initData (vm) &#123;</span><br><span class="line">    var data = vm.$options.data;</span><br><span class="line">    data = vm._data = typeof data === &apos;function&apos;</span><br><span class="line">      ? getData(data, vm)</span><br><span class="line">      : data || &#123;&#125;;</span><br><span class="line">    //得到的data不是object对象</span><br><span class="line">    if (!isPlainObject(data)) &#123;</span><br><span class="line">      data = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // proxy data on instance</span><br><span class="line">    var keys = Object.keys(data);</span><br><span class="line">    var props = vm.$options.props;</span><br><span class="line">    var methods = vm.$options.methods;</span><br><span class="line">    var i = keys.length;</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">      var key = keys[i];</span><br><span class="line">      &#123;if (methods &amp;&amp; hasOwn(methods, key)) &#123;...与method同名警告&#125;&#125;</span><br><span class="line">      if (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">       ...与prop同名警告</span><br><span class="line">      &#125; else if (!isReserved(key)) &#123; //不是以$或者_开头的key</span><br><span class="line">        proxy(vm, &quot;_data&quot;, key); //将key值存一份到vm的&apos;_data&apos;属性上</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // observe data</span><br><span class="line">    observe(data, true /* asRootData */);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getData (data, vm) &#123;</span><br><span class="line">    // #7573 disable dep collection when invoking(调用) data getters</span><br><span class="line">    pushTarget();</span><br><span class="line">    try &#123;</span><br><span class="line">      return data.call(vm, vm)</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      handleError(e, vm, &quot;data()&quot;);</span><br><span class="line">      return &#123;&#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      popTarget();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  var sharedPropertyDefinition = &#123;</span><br><span class="line">    enumerable: true,</span><br><span class="line">    configurable: true,</span><br><span class="line">    get: noop,</span><br><span class="line">    set: noop</span><br><span class="line">  &#125;;</span><br><span class="line">  function proxy (target, sourceKey, key) &#123;</span><br><span class="line">    sharedPropertyDefinition.get = function proxyGetter () &#123;</span><br><span class="line">      return this[sourceKey][key]</span><br><span class="line">    &#125;;</span><br><span class="line">    sharedPropertyDefinition.set = function proxySetter (val) &#123;</span><br><span class="line">      this[sourceKey][key] = val;</span><br><span class="line">    &#125;;</span><br><span class="line">    Object.defineProperty(target, key, sharedPropertyDefinition);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>给data创建观察者实例，挂载‘_ob_’属性，指向一个Observer对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function observe (value, asRootData) &#123;</span><br><span class="line">  if (!isObject(value) || value instanceof VNode) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  var ob;</span><br><span class="line">  if (hasOwn(value, &apos;__ob__&apos;) &amp;&amp; value.__ob__ instanceof Observer) &#123;</span><br><span class="line">    ob = value.__ob__;</span><br><span class="line">  &#125; else if (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !isServerRendering() &amp;&amp;</span><br><span class="line">    (Array.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    Object.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue</span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = new Observer(value);</span><br><span class="line">  &#125;</span><br><span class="line">  if (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++;</span><br><span class="line">  &#125;</span><br><span class="line">  return ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Observer对象有三个属性,‘<strong>ob</strong>’属性相同<br>{<br>  value:data,<br>  dep : new Dep();<br>  vmCount :0<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var Observer = function Observer (value) &#123;</span><br><span class="line">  this.value = value;</span><br><span class="line">  this.dep = new Dep();</span><br><span class="line">  this.vmCount = 0;</span><br><span class="line">  def(value, &apos;__ob__&apos;, this);</span><br><span class="line">  if (Array.isArray(value)) &#123;</span><br><span class="line">    if (hasProto) &#123;</span><br><span class="line">      protoAugment(value, arrayMethods);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      copyAugment(value, arrayMethods, arrayKeys);</span><br><span class="line">    &#125;</span><br><span class="line">    this.observeArray(value);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    this.walk(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">function def (obj, key, val, enumerable) &#123;</span><br><span class="line">  Object.defineProperty(obj, key, &#123;</span><br><span class="line">    value: val,</span><br><span class="line">    enumerable: !!enumerable,</span><br><span class="line">    writable: true,</span><br><span class="line">    configurable: true</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">//遍历所有属性并将它们转换为getter / setter。 </span><br><span class="line">//仅当值类型为Object时才应调用此方法。</span><br><span class="line">Observer.prototype.walk = function walk (obj) &#123;</span><br><span class="line">  var keys = Object.keys(obj);</span><br><span class="line">  for (var i = 0; i &lt; keys.length; i++) &#123;</span><br><span class="line">    defineReactive$$1(obj, keys[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>真正进行劫持的方法defineReactive$$1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">function defineReactive$$1 (</span><br><span class="line">    obj,</span><br><span class="line">    key,</span><br><span class="line">    val,</span><br><span class="line">    customSetter,</span><br><span class="line">    shallow</span><br><span class="line">  ) &#123;</span><br><span class="line">    var dep = new Dep();</span><br><span class="line"></span><br><span class="line">    var property = Object.getOwnPropertyDescriptor(obj, key);</span><br><span class="line">    if (property &amp;&amp; property.configurable === false) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // cater(迎合) for pre-defined getter/setters</span><br><span class="line">    var getter = property &amp;&amp; property.get;</span><br><span class="line">    var setter = property &amp;&amp; property.set;</span><br><span class="line">    if ((!getter || setter) &amp;&amp; arguments.length === 2) &#123;</span><br><span class="line">      val = obj[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var childOb = !shallow &amp;&amp; observe(val);//对值进行劫持处理 开始递归处理</span><br><span class="line">    Object.defineProperty(obj, key, &#123;</span><br><span class="line">      enumerable: true,</span><br><span class="line">      configurable: true,</span><br><span class="line">      get: function reactiveGetter () &#123;</span><br><span class="line">        var value = getter ? getter.call(obj) : val;</span><br><span class="line">        if (Dep.target) &#123; //new watch的时候，Dep.target指向Watcher对象,再运行render函数，访问具体变量就会调用这里</span><br><span class="line">          dep.depend();//对key的依赖进行依赖收集</span><br><span class="line">          if (childOb) &#123;//如果值是一个对象的情况下</span><br><span class="line">            childOb.dep.depend();//对对象值的依赖进行依赖收集 实现深度监听</span><br><span class="line">            if (Array.isArray(value)) &#123;</span><br><span class="line">              dependArray(value);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return value</span><br><span class="line">      &#125;,</span><br><span class="line">      set: function reactiveSetter (newVal) &#123;</span><br><span class="line">        var value = getter ? getter.call(obj) : val;</span><br><span class="line">        //相同值，不更新</span><br><span class="line">        if (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">          return</span><br><span class="line">        &#125;</span><br><span class="line">        //有setter方法直接用setter方法更新，没有直接赋值</span><br><span class="line">        if (getter &amp;&amp; !setter) &#123; return &#125;</span><br><span class="line">        if (setter) &#123;</span><br><span class="line">          setter.call(obj, newVal);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          val = newVal;</span><br><span class="line">        &#125;</span><br><span class="line">        //对新值进行劫持处理 更新childOb</span><br><span class="line">        //如果新值是对象对新赋的值在更新时进行依赖收集</span><br><span class="line">        childOb = !shallow &amp;&amp; observe(newVal); </span><br><span class="line">        dep.notify();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>每个被劫持过的数据的标识<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">var Dep = function Dep () &#123;</span><br><span class="line">  this.id = uid++;</span><br><span class="line">  this.subs = [];</span><br><span class="line">&#125;;</span><br><span class="line">Dep.prototype.addSub = function addSub (sub) &#123;</span><br><span class="line">  this.subs.push(sub);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Dep.prototype.depend = function depend () &#123;</span><br><span class="line">  if (Dep.target) &#123;</span><br><span class="line">    Dep.target.addDep(this); //调用Watcher.addDep方法，this指dep</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Dep.prototype.notify = function notify () &#123;</span><br><span class="line">  // stabilize the subscriber list first</span><br><span class="line">  var subs = this.subs.slice();</span><br><span class="line">  if (!config.async) &#123;</span><br><span class="line">    // subs aren&apos;t sorted in scheduler if not running async</span><br><span class="line">    // we need to sort them now to make sure they fire in correct</span><br><span class="line">    // order</span><br><span class="line">    subs.sort(function (a, b) &#123; return a.id - b.id; &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  for (var i = 0, l = subs.length; i &lt; l; i++) &#123;</span><br><span class="line">    subs[i].update(); //执行watcher的update函数</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Dep.target = null;</span><br><span class="line">var targetStack = [];</span><br></pre></td></tr></table></figure></p>
<h1 id="订阅发布"><a href="#订阅发布" class="headerlink" title="订阅发布"></a>订阅发布</h1><p>mountComponent函数会new Watcher一个对象,执行get方法【详见源码分析二】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">var _Set;</span><br><span class="line">/* istanbul ignore if */ // $flow-disable-line</span><br><span class="line">if (typeof Set !== &apos;undefined&apos; &amp;&amp; isNative(Set)) &#123;</span><br><span class="line">  // use native Set when available.</span><br><span class="line">  _Set = Set;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  // a non-standard Set polyfill that only works with primitive keys.</span><br><span class="line">  _Set = /*@__PURE__*/(function () &#123;</span><br><span class="line">    function Set () &#123;</span><br><span class="line">      this.set = Object.create(null);</span><br><span class="line">    &#125;</span><br><span class="line">    Set.prototype.has = function has (key) &#123;</span><br><span class="line">      return this.set[key] === true</span><br><span class="line">    &#125;;</span><br><span class="line">    Set.prototype.add = function add (key) &#123;</span><br><span class="line">      this.set[key] = true;</span><br><span class="line">    &#125;;</span><br><span class="line">    Set.prototype.clear = function clear () &#123;</span><br><span class="line">      this.set = Object.create(null);</span><br><span class="line">    &#125;;</span><br><span class="line">    return Set;</span><br><span class="line">  &#125;());</span><br><span class="line">&#125;</span><br><span class="line">var Watcher = function Watcher (...args)&#123;</span><br><span class="line">  this.deps = [];</span><br><span class="line">  this.newDeps = [];</span><br><span class="line">  this.depIds = new _Set();</span><br><span class="line">  this.newDepIds = new _Set();</span><br><span class="line">&#125;</span><br><span class="line">Watcher.prototype.get = function get () &#123;</span><br><span class="line">    pushTarget(this); //将当前Watcher挂到第三方Dep.target上</span><br><span class="line">    var value;</span><br><span class="line">    var vm = this.vm;</span><br><span class="line">    try &#123;</span><br><span class="line">      //this.getter会执行render,触发数据的get方法，进行相互订阅</span><br><span class="line">      value = this.getter.call(vm, vm); </span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      // &quot;touch&quot; every property so they are all tracked as</span><br><span class="line">      // dependencies for deep watching</span><br><span class="line">      if (this.deep) &#123;</span><br><span class="line">        traverse(value);</span><br><span class="line">      &#125;</span><br><span class="line">      popTarget();</span><br><span class="line">      this.cleanupDeps();</span><br><span class="line">    &#125;</span><br><span class="line">    return value</span><br><span class="line">  &#125;;</span><br><span class="line">function pushTarget (target) &#123;</span><br><span class="line">  targetStack.push(target);</span><br><span class="line">  Dep.target = target;</span><br><span class="line">&#125;</span><br><span class="line">//watcher和dep互相存id</span><br><span class="line">Watcher.prototype.addDep = function addDep (dep) &#123; </span><br><span class="line">  var id = dep.id;</span><br><span class="line">  if (!this.newDepIds.has(id)) &#123;</span><br><span class="line">    this.newDepIds.add(id);</span><br><span class="line">    this.newDeps.push(dep);</span><br><span class="line">    if (!this.depIds.has(id)) &#123;</span><br><span class="line">      dep.addSub(this); //将watcher加入到dep的sub属性中</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Watcher.prototype.update = function update () &#123;</span><br><span class="line">  /* istanbul ignore else */</span><br><span class="line">  if (this.lazy) &#123;</span><br><span class="line">    this.dirty = true;</span><br><span class="line">  &#125; else if (this.sync) &#123;</span><br><span class="line">    this.run();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    queueWatcher(this);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Watcher.prototype.run = function run () &#123;</span><br><span class="line">  if (this.active) &#123;</span><br><span class="line">    var value = this.get(); //重新调用render函数更新数据</span><br><span class="line">    if (</span><br><span class="line">      value !== this.value ||</span><br><span class="line">      //对于需要深度监听的数据类型，值没有变，也许值内容发生了变化 </span><br><span class="line">      isObject(value) ||</span><br><span class="line">      this.deep</span><br><span class="line">    ) &#123;</span><br><span class="line">      var oldValue = this.value;</span><br><span class="line">      this.value = value;</span><br><span class="line">      if (this.user) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          this.cb.call(this.vm, value, oldValue);</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">          handleError(e, this.vm, (&quot;callback for watcher \&quot;&quot; + (this.expression) + &quot;\&quot;&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this.cb.call(this.vm, value, oldValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://github.com/YooHannah/algorithm/blob/master/html/vuesrc/dataResponse.js" target="_blank" rel="noopener">vue3.0数据响应式原理</a></p>
<h1 id="vue3-0的改进"><a href="#vue3-0的改进" class="headerlink" title="vue3.0的改进"></a>vue3.0的改进</h1><p>1.对源码进行优化<br>使用monorepo和TS管理和开发源码，提升自身代码的可维护性<br>2.性能优化<br>减少源码体积<br>移除冷门的feature(如filter,inline-template)<br>引入tree-shaking,减小打包体积</p>
<p>数据劫持优化<br>原来缺点<br>无法判断对象属性删除新增<br>深度层次结点要递归遍历，也不知道会不会用到，都要劫持，不友好</p>
<p>解决<br>使用proxy API 可以检测到删除还是新增<br>在用到时才劫持，避免无脑递归</p>
<p>3.编译优化<br>判断更新的颗粒度变小，从原来的组件级，利用block tree的区块细化到动态节点级<br>引入 compositionAPI 优化逻辑关注点相关的代码，可以避免mixin的时候的命名冲突</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/sso.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/sso.html" itemprop="url">
                  sso单点登录实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-25T23:27:15+08:00">
                2020-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>多项目想要实现统一登录，即登录一个系统后，在打开其他相关系统页面后，是已经登录的状态，不再进行登录</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>多个系统使用统一的顶级域名，利用cookie的domain属性，将登录后cookie保存在浏览器中，只要是该cookie的domain所包含的域名的站点，都可以拿到这个cookie</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>选择原来多个站点中其中一个站点的登录页，作为公共跳转页<br>在登录之后将token塞到浏览器中<br>这里设置统一token在cookie中的key值为_a<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">根据运行环境设置domain,sit,dev均为测试环境</span><br><span class="line">function getDomain(name)&#123;</span><br><span class="line">  let testENVs = [&apos;localhost&apos;,&apos;sit&apos;,&apos;dev&apos;]</span><br><span class="line">  let testENV = &apos;&apos;</span><br><span class="line">  testENVs.forEach(env=&gt;&#123;</span><br><span class="line">    if(location.hostname.includes(env))&#123; //根据域名判断环境</span><br><span class="line">      testENV = env</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  let temp = testENV?testENV +&apos;.xxxx.com&apos;:&apos;xxxx.com&apos;</span><br><span class="line">  //本地开发不加domain,默认localhost,否则本地没办法进行开发</span><br><span class="line">  let domain = testENV === &apos;localhost&apos; ? &apos;&apos;: (name === &apos;_a&apos;? temp:location.hostname)//个别cookie字段仅用于本站点，所以domain设置为站点域名</span><br><span class="line">  return domain</span><br><span class="line">&#125;</span><br><span class="line">setCookie=(name,value) =&gt; &#123;</span><br><span class="line">    const Days = 0.5</span><br><span class="line">    const exp = new Date()</span><br><span class="line">    exp.setTime(exp.getTime() + Days*24*60*60*1000)</span><br><span class="line">    let str =  name + &apos;=&apos; + escape(value) + &apos;;expires=&apos; + exp.toGMTString()</span><br><span class="line">    let domain = getDomain(name)</span><br><span class="line">    if(domain)&#123;</span><br><span class="line">      str +=&apos;;domain=&apos; + domain</span><br><span class="line">    &#125;</span><br><span class="line">    document.cookie = str</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure></p>
<p>之所以要根据不同运行环境设置不同domain,是因为要在不同测试环境也要实现单点登录<br>比如测试环境在sit环境的a.sit.xxxx.com和b.sit.xxxx.com<br>a.sit.xxxx.com登录页作为公共登录页<br>在a.sit.xxxx.com登录后，token的cookie会被设置成<br>key是_a,domain是sit.xxxx.com(浏览器会自动在前面加一个点)，这样打开b.sit.xxxx.com的页面，浏览器中还会存在_a这个cookie,b.sit.xxxx.com就可以直接拿这个cookie向服务器发请求了</p>
<p>以此类推，在dev环境，这两个站点域名会变成<br>a.dev.xxxx.com和b.dev.xxxx.com<br>_a的domain会被设置成dev.xxxx.com<br>这时如果去b.dev.xxxx.com,_a是会有的<br>但去a.sit.xxxx.com,是不会有的，因为_a此时仅限于dev.xxxx.com域名及其子域名</p>
<p>等到了生产环境，二者域名变为<br>a.xxxx.com和b.xxxx.com<br>_a的domain会被设置成xxxx.com<br>此时就会出现一个问题，假如我先登录了线上环境<br>有了domain为xxxx.com的_a<br>再去测试环境登录，此时会加进去domain为sit/dev.xxx.com的_a<br>两个_a如何区分哪个才是当前环境的_a？</p>
<p>遇到的问题一 ：测试环境_a加不进去，出现一闪而过<br>开始以为是浏览器机制问题，后来才发现，是代码逻辑问题<br>其实cookie是有写进浏览器的，跟cookie本身处理机制无关，可以写进去，问题出在了取cookie _a再给后台发请求的时候，以前是保存token的只有一个特殊key名，直接取那个key名就行，现在有两个_a，逻辑还是按照第一个来取，结果取错了，后台给发过来401，前端代码处理http状态码的逻辑又是401清cookie跳登录，所以domain为. sit/dev. xxxx. com的cookie就又消失了😅</p>
<p>遇到问题二 ：两个_a如何区分哪个才是当前环境的_a？<br>因为后台实现分层，与前端直接对接的后台，无法访问后台的用户cookie表，能拿到cookie表的后台站在大局角度看问题，这个逻辑又觉得不是有必要加的，所以不能要求后台拿到报文中cookie后去表里面做判断<br>所以由前端通过读取document.cookie,整理拿到两个_a后，依次用每个_a去给后台发请求，如果成功了，说明当前_a是正确的，就可以用这个_a去发真正的请求，同时记录下这个_a,避免之后的重复探测</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>1.碰到问题一时，很无厘头，但分析出原因后，让人感觉很无语，正确的说是，让人很没面子，遇到问题应该善于分析，戒骄戒躁<br>2.问题二，有时候，你认为很恶心的做法，恰巧可能会被采纳</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>发版到线上后，发现部分同事登陆成功后又跳回登录页面，中间发起的请求报401</p>
<p>经过查看同事浏览器的cookie发现,存在设置了httponly的_a，即我们所有系统统一使用的token标识，<br>cookie设置了httponly意味着js没有权限进行获取更改甚至不能删除，所以新登录的token是没有写进去的，拿到的token也就是错的<br>解决办法就是让后台同事强制写一个没有httponly的_a进去，让后台覆盖后台，<br>说明浏览器优先级是先处理set-cookie的cookie逻辑，再看是否有httponly,决定js是否有权限处理cookie</p>
<p>相关链接<br><a href="https://www.cnblogs.com/zdz8207/p/vue-cookie-https-secure.html" target="_blank" rel="noopener">Cookie写不进去问题深入调查 https Secure Cookie</a><br><a href="https://blog.csdn.net/Paranoid99/article/details/101015172" target="_blank" rel="noopener">js创建cookie时获取一级域名设置domain解决跨域问题</a><br><a href="https://www.cnblogs.com/gg1234/p/5611086.html" target="_blank" rel="noopener">js与cookie的domain和path之间的关系</a><br><a href="https://www.cnblogs.com/Easty/p/7338940.html" target="_blank" rel="noopener">前端单点登录（SSO）实现方法（二级域名与主域名）</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuepress.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuepress.html" itemprop="url">
                  使用vuepress构建文档系统
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T13:18:15+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>面向普通用户的应用系统，包含很多产品的使用说明，属于静态页面<br>一方面占据整体项目的体积，打包时间用时长，打包结果体积大<br>另一方面，不断新增的不同产品的使用说明，对于前端开发人员来说，<br>相对开发真正的产品功能来说优先级较低，且占用开发时间</p>
<p>所以希望将产品使用说明与当前项目隔离，建立静态网站，存放使用说明<br>再由原系统进行跳转<br>将新增使用说明的任务交由相关产品负责人等非开发人员进行新增</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>1.对于非开发人员来说，选择何种文档格式，可以既方便编写，又可以轻松转成html<br>2.原有系统用vue编写的批量文件如何迁移到新的静态网站</p>
<h1 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h1><h2 id="vuepress"><a href="#vuepress" class="headerlink" title="vuepress"></a>vuepress</h2><p>vuepress是一款使用vue驱动的静态网站生成器<br>用户可以使用markdown格式文件编辑文本，然后转义成html<br>另外页面中功能还可以使用vue进行嵌入</p>
<h2 id="批量迁移"><a href="#批量迁移" class="headerlink" title="批量迁移"></a>批量迁移</h2><p>原系统vue编写的批量页面含有vue语法，不能直接迁移<br>所以需要将生成好的html爬下来转成md文件，应用到新系统<br>‘html-to-md’的npm 包可以帮助将html转换成md</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h2 id="vuepress搭建"><a href="#vuepress搭建" class="headerlink" title="vuepress搭建"></a>vuepress搭建</h2><p>因为要与原系统主题风格样式类似，故需要在原来主题代码上进行修改<br>安装好vuepress包之后<br>将包里面的默认主题@vuepress/theme-default复制粘贴到doc/.vuepress/theme文件夹下面<br>修改里面的代码就可以直接应用了</p>
<h3 id="配置config-js文件"><a href="#配置config-js文件" class="headerlink" title="配置config.js文件"></a>配置config.js文件</h3><p>在.vuepress文件夹下新增config.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">title:标签页名称</span><br><span class="line">head:在页面头部引入的文件</span><br><span class="line">base:当不在域名根目录下部署时，配置部署路径</span><br><span class="line">themeConfig:&#123; 主题配置</span><br><span class="line">  logo：标题栏左上角logo</span><br><span class="line">  nav:右上角搜索后面的按钮</span><br><span class="line">  sidebar:左侧侧边栏</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="enhanceApp-js"><a href="#enhanceApp-js" class="headerlink" title="enhanceApp.js"></a>enhanceApp.js</h3><p>在.vuepress文件夹下新增enhanceApp.js<br>该文件，可以添加对项目的额外处理<br>比如当前项目右上角三个按钮根据权限显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">export default (&#123;</span><br><span class="line">  Vue, // VUE构造函数对象</span><br><span class="line">  options, // vue实例选项</span><br><span class="line">  router, // 路由对象</span><br><span class="line">  siteData//配置的数据</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">  async function getAuthorization()&#123;</span><br><span class="line">    if(location.hostname.includes(&apos;localhost&apos;))&#123;</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line">    let cookie_str = document.cookie</span><br><span class="line">    let cookie_parts = cookie_str.split(&apos;;&apos;)</span><br><span class="line">    let auths = []</span><br><span class="line">    cookie_parts.forEach(c=&gt;&#123;</span><br><span class="line">      if (c)&#123;</span><br><span class="line">        let kv = c.split(&apos;=&apos;)</span><br><span class="line">        let k = kv[0].trim()</span><br><span class="line">        let v = kv[1].trim()</span><br><span class="line">        if (k == &apos;_a&apos;)&#123;</span><br><span class="line">          auths.push(v)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    if(auths.length&lt;1)&#123;</span><br><span class="line">      return false</span><br><span class="line">    &#125;</span><br><span class="line">    for (var c of auths)&#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        let response = await axios.get(location.origin + &apos;/api/v1/edit-user&apos;, &#123;headers: &#123;&apos;X-Auth-Token&apos;: c&#125;&#125;)</span><br><span class="line">        if(response.status &lt; 400)&#123;</span><br><span class="line">          return true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (err) &#123;</span><br><span class="line">        console.log(err)</span><br><span class="line">        return false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  getAuthorization().then(flag=&gt;&#123;</span><br><span class="line">    let divs = document.getElementsByClassName(&apos;nav-item&apos;)</span><br><span class="line">    if(flag)&#123;</span><br><span class="line">      divs[1].style.display = &apos;none&apos;</span><br><span class="line">      divs[2].style.display = &apos;none&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="更改页面呈现样式"><a href="#更改页面呈现样式" class="headerlink" title="更改页面呈现样式"></a>更改页面呈现样式</h3><p>增加悬浮锚点定位<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">page.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;main class=&quot;page&quot;&gt;</span><br><span class="line">    &lt;div v-show=&quot;$page.headers &amp;&amp; isShowAncher &amp;&amp; $page.frontmatter.ancherShow&quot; class=&apos;ancherSection&apos;&gt;</span><br><span class="line">      &lt;template v-for=&quot;(item,i) in headers&quot;&gt;</span><br><span class="line">        &lt;div :key=&quot;i&quot;&gt;</span><br><span class="line">          &lt;a  @click=&quot;gotoAncher(item.slug)&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;slot name=&quot;top&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Content class=&quot;theme-default-content&quot; /&gt;</span><br><span class="line">    &lt;PageEdit /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;PageNav v-bind=&quot;&#123; sidebarItems &#125;&quot; /&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;slot name=&quot;bottom&quot; /&gt;</span><br><span class="line">  &lt;/main&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123; PageEdit, PageNav&#125;,</span><br><span class="line">  props: [&apos;sidebarItems&apos;],</span><br><span class="line">  data () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      isShowAncher: false, //滚动过程控制悬浮锚点</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed:&#123;</span><br><span class="line">    headers:function()&#123;//计算锚点内容</span><br><span class="line">      let ancherLevel = this.$page.frontmatter.ancherLevel </span><br><span class="line">      let sidebarDepth = this.$page.frontmatter.sidebarDepth?this.$page.frontmatter.sidebarDepth:this.$themeConfig.sidebarDepth</span><br><span class="line">      let levelStr = ancherLevel?ancherLevel:(sidebarDepth&gt;1?&apos;h2,h3&apos;:&apos;h2&apos;)</span><br><span class="line">      if(ancherLevel &amp;&amp; !(/^(h2|h3|h2\,\s*\h3)$/ig.test(ancherLevel.trim())))&#123;</span><br><span class="line">        return []</span><br><span class="line">      &#125;</span><br><span class="line">      if(levelStr.includes(&apos;,&apos;))&#123;</span><br><span class="line">        return this.$page.headers &amp;&amp; groupHeaders(this.$page.headers).length&gt;0?this.$page.headers:[]</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">        let level = +levelStr[1]</span><br><span class="line">        return this.$page.headers.filter(h =&gt; h.level === level)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  updated()&#123;</span><br><span class="line">    this.setPictureZoom()</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    let  handleScroll= ()=&gt;&#123;</span><br><span class="line">      let scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop // 滚动条偏移量</span><br><span class="line">      this.isShowAncher = !!scrollTop</span><br><span class="line">    &#125;</span><br><span class="line">    window.addEventListener(&apos;scroll&apos;,handleScroll,false)</span><br><span class="line">    this.setPictureZoom()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    //锚点定位</span><br><span class="line">    gotoAncher(ancher)&#123;</span><br><span class="line">      let el = document.getElementById(ancher)</span><br><span class="line">      let anchersHeight = document.getElementsByClassName(&apos;ancherSection&apos;)[0].clientHeight</span><br><span class="line">      window.scrollTo(&#123; </span><br><span class="line">          top: el.offsetTop-anchersHeight, </span><br><span class="line">          behavior: &quot;smooth&quot; </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    //添加图片放大功能</span><br><span class="line">    setPictureZoom () &#123;</span><br><span class="line">      let img = document.querySelectorAll(&apos;p &gt; img&apos;)</span><br><span class="line">        for (let i = 0; i &lt; img.length; i++) &#123;</span><br><span class="line">            if (img[i]) &#123;</span><br><span class="line">                let a = document.createElement(&quot;a&quot;);</span><br><span class="line">                let parent = img[i].parentNode</span><br><span class="line">                parent.appendChild(a)</span><br><span class="line">                let src = img[i].getAttribute(&apos;src&apos;)</span><br><span class="line">                a.setAttribute(&apos;data-fancybox&apos;, &apos;&apos;)</span><br><span class="line">                a.setAttribute(&apos;href&apos;, src)</span><br><span class="line">                a.appendChild(img[i])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;stylus&quot;&gt;</span><br><span class="line">@require &apos;../styles/wrapper.styl&apos;</span><br><span class="line">.page</span><br><span class="line">  padding-bottom 2rem</span><br><span class="line">  display block</span><br><span class="line">.ancherSection</span><br><span class="line">  position: fixed</span><br><span class="line">  background-color: white</span><br><span class="line">  box-shadow: rgb(234, 229, 229) 0px 1px 2px;</span><br><span class="line">  top: 64px</span><br><span class="line">  min-height: 42px</span><br><span class="line">  width: calc(100% - 320px);</span><br><span class="line">  display flex</span><br><span class="line">  align-items center</span><br><span class="line">  justify-content left</span><br><span class="line">  flex-wrap: wrap;</span><br><span class="line">  padding: 10px 0px 0px;</span><br><span class="line">  z-index:2</span><br><span class="line">  div</span><br><span class="line">    margin-left 20px</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    a</span><br><span class="line">      color black</span><br><span class="line">      cursor pointer</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="更换图标"><a href="#更换图标" class="headerlink" title="更换图标"></a>更换图标</h3><p>在sidebarGroup.vue文件同级别新增arrow.svg图片，使用相对路径可插入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&apos;./arrow.svg&apos; v-if=&quot;collapsable&quot; :class=&quot;open ? &apos;down&apos; : &apos;&apos;&quot; style=&apos;width:20px&apos; /&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="批量迁移-1"><a href="#批量迁移-1" class="headerlink" title="批量迁移"></a>批量迁移</h2><h3 id="目录改造"><a href="#目录改造" class="headerlink" title="目录改造"></a>目录改造</h3><p>原有系统页面图片按照产品名命名文件夹，故先将整体文件结构进行改造<br>原来目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--content</span><br><span class="line">  --a</span><br><span class="line">    --a1.png</span><br><span class="line">    --a2.png</span><br><span class="line">    ......省略若干</span><br><span class="line">    --a13.png</span><br><span class="line">  --b</span><br><span class="line">    --b1.png</span><br><span class="line">    --b2.png</span><br><span class="line">    ......省略若干</span><br><span class="line">    --b13.png</span><br></pre></td></tr></table></figure></p>
<p>改造成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--content</span><br><span class="line">  --a</span><br><span class="line">    --images</span><br><span class="line">        --a1.png</span><br><span class="line">        --a2.png</span><br><span class="line">        ......省略若干</span><br><span class="line">        --a13.png</span><br><span class="line">  --b</span><br><span class="line">    --images</span><br><span class="line">      --b1.png</span><br><span class="line">      --b2.png</span><br><span class="line">      ......省略若干</span><br><span class="line">      --b13.png</span><br></pre></td></tr></table></figure></p>
<p>就是在当前父文件夹下新增images文件夹，然后把图片移进去<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);//引用文件系统模块</span><br><span class="line">function readFileList(path, filesList) &#123;</span><br><span class="line">  var files = fs.readdirSync(path);</span><br><span class="line">  files.forEach(function (itm) &#123;</span><br><span class="line">    var obj = &#123;&#125;;//定义一个对象存放文件的路径和名字</span><br><span class="line">    obj.path = path;//路径</span><br><span class="line">    obj.filename = itm//名字</span><br><span class="line">    filesList.push(obj);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">var getFiles = &#123;</span><br><span class="line">  //获取文件夹下的所有文件</span><br><span class="line">  getFileList: function (path) &#123;</span><br><span class="line">      var filesList = [];</span><br><span class="line">      readFileList(path, filesList);</span><br><span class="line">      return filesList;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">let files = getFiles.getFileList(&quot;./content/&quot;)  //拿到a,b这一级别文件</span><br><span class="line">for(let i=0;i&lt;files.length;i++)&#123;</span><br><span class="line">  let filepath = files[i].path+files[i].filename+&apos;/&apos; //拼接a,b路径</span><br><span class="line">  let images = getFiles.getFileList(filepath)  //拿到a,b下一级的文件，即所有图片</span><br><span class="line">  let imgpath = filepath+&apos;images&apos;</span><br><span class="line">  fs.mkdirSync(imgpath);//新建文件夹</span><br><span class="line">  for(let j = 0;j&lt;images.length;j++)&#123; //将图片移到新文件夹中</span><br><span class="line">    let oldpath = images[j].path+images[j].filename</span><br><span class="line">    let newpath = imgpath+&apos;/&apos;+images[j].filename</span><br><span class="line">    fs.rename(oldpath,newpath,function(err)&#123;</span><br><span class="line">      console.log(err)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="转义文件"><a href="#转义文件" class="headerlink" title="转义文件"></a>转义文件</h3><p>因为原项目为单页面文件，无法进行爬虫批量获取<br>最终实现也还是手动copy页面中dom,一个页面一个页面的copy<br>然后处理</p>
<p>安装转义包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install html-to-md</span><br></pre></td></tr></table></figure></p>
<p>开始使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const html2md=require(&apos;html-to-md&apos;)</span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">//在页面中找到使用说明的dom,copy之后存放到temp.txt中</span><br><span class="line">//当做字符串被读取</span><br><span class="line">var contentText = fs.readFileSync(&apos;temp.txt&apos;,&apos;utf-8&apos;);</span><br><span class="line">let res = html2md(contentText)</span><br><span class="line">//匹配md的‘[]()’书写形式</span><br><span class="line">let reg1=/\[([\S ]*?)]\s?()\( *&lt;?([^\s&apos;&quot;]*?(?:\([\S]*?\)[\S]*?)?)&gt;?\s*(?:()([&apos;&quot;])(.*?)\5)? *\)/g</span><br><span class="line">//匹配md的‘![]()’书写形式</span><br><span class="line">let reg2 = /!\[([^\]]*?)][ \t]*()\([ \t]?&lt;?([\S]+?(?:\([\S]*?\)[\S]*?)?)&gt;?(?: =([*\d]+[A-Za-z%]&#123;0,4&#125;)x([*\d]+[A-Za-z%]&#123;0,4&#125;))?[ \t]*(?:([&quot;&apos;])([^&quot;]*?)\6)?[ \t]?\)/g</span><br><span class="line">//在每篇开头注入转义规则front matter</span><br><span class="line">res = &apos;---\nsidebarDepth: 2 \nancherShow: true \nancherLevel: h3 \n--- \n&apos; + res.replace(reg1,function(group,text)&#123; //html-to-md包转义结果将标题转移成没有连接但有连接名的书写形式[xxx](),所以这里将其替换成 md写法</span><br><span class="line">  return text?&apos;## &apos;+text:group</span><br><span class="line">&#125;).replace(reg2,function(...res)&#123; //将图片引用路径做统一处理</span><br><span class="line">  let arr =  res[3].slice(res[3].lastIndexOf(&apos;/&apos;)+1).split(&apos;.&apos;)</span><br><span class="line">  return &apos;![](./images/&apos;+arr[0]+&apos;.&apos;+arr[2]+&apos;)&apos;</span><br><span class="line">&#125;)</span><br><span class="line">//将处理后的文件写入相应的文件夹中的manual.md文件中，即生成md文件</span><br><span class="line">fs.writeFile(&quot;./content/xxxx/manual.md&quot;, res, function(err) &#123; </span><br><span class="line">  if(err) &#123;</span><br><span class="line">      return console.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(&quot;The file was saved!&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>所以最终文件夹目录为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--content</span><br><span class="line">  --a</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br><span class="line">  --b</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br></pre></td></tr></table></figure></p>
<p>现在将content目录下文件全都粘贴到docs文件夹下面，与.vuepres平级<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--docs</span><br><span class="line">  --.vuepress</span><br><span class="line">  --a</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br><span class="line">  --b</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br></pre></td></tr></table></figure></p>
<p>就可以在.vuepress文件夹下面的config.js中配置sidebar了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> sidebar: [</span><br><span class="line">      &#123;</span><br><span class="line">        title: &apos;产品a&apos;,</span><br><span class="line">        collapsable: true,</span><br><span class="line">        children:[</span><br><span class="line">            [&apos;/a/manual.md&apos;, &apos;a操作手册&apos;],</span><br><span class="line">          ]</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>1.如何将公共开源的项目更契合的应用到公司级项目，对原项目的破坏是避免不了的，比如替换主题颜色，替换相关图标，以及为了新增一些原来项目中没有的功能，而去更改原有处理逻辑，所谓二次开发，实质上，可能应该叫破坏性开发，不遵循原来的使用规则，在原来基础上，造自己的规则</p>
<p>2.对于大批量重复性工作的处理，要学会使用工具，<br>比如局部大量替换，借助vscode的局部锁定（先选取范围再点击下图1，锁定按钮）<br>再比如规则类似的替换，又要善于利用vscode的正则匹配去替换，如下图2<br><img src="/image/vscode.png" alt="vscode"><br>如果属于大规模处理，还要学会自己造工具<br>比如上述批量处理目录结构，改造md文件<br>人之所以为人，学会使用工具才能算是进入了文明社会</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/psb.jpg" alt="YooHannah">
          <p class="site-author-name" itemprop="name">YooHannah</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">245</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YooHannah</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/treedocument/treedocument.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
