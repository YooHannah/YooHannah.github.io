<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="My Little World" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta property="og:type" content="website">
<meta property="og:title" content="My Little World">
<meta property="og:url" content="http://yoohannah.github.io/page/6/index.html">
<meta property="og:site_name" content="My Little World">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My Little World">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoohannah.github.io/page/6/">





  <title> My Little World </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">My Little World</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">learn and share</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/nodejs/middlwareSrc.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/nodejs/middlwareSrc.html" itemprop="url">
                  KOA框架剥洋葱原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-24T17:18:37+08:00">
                2020-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="收集"><a href="#收集" class="headerlink" title="收集"></a>收集</h1><p>new 一个koa实例后，调用use接口会将传入的中间件函数push到middleware属性数组中做收集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">application.js</span><br><span class="line"></span><br><span class="line">use(fn) &#123;</span><br><span class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;middleware must be a function!&apos;);</span><br><span class="line">    if (isGeneratorFunction(fn)) &#123;</span><br><span class="line">      deprecate(&apos;Support for generators will be removed in v3. &apos; +</span><br><span class="line">                &apos;See the documentation for examples of how to convert old middleware &apos; +</span><br><span class="line">                &apos;https://github.com/koajs/koa/blob/master/docs/migration.md&apos;);</span><br><span class="line">      fn = convert(fn);</span><br><span class="line">    &#125;</span><br><span class="line">    debug(&apos;use %s&apos;, fn._name || fn.name || &apos;-&apos;);</span><br><span class="line">    this.middleware.push(fn);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>根据koa框架版本不同，需要将使用generator函数写的中间件转化成基于promise的函数形式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">const convert = require(&apos;koa-convert&apos;);</span><br><span class="line"></span><br><span class="line">function convert (mw) &#123;</span><br><span class="line">  if (typeof mw !== &apos;function&apos;) &#123;</span><br><span class="line">    throw new TypeError(&apos;middleware must be a function&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">  //再次确认是否是generator函数</span><br><span class="line">  if (mw.constructor.name !== &apos;GeneratorFunction&apos;) &#123;</span><br><span class="line">    // 假设它是一个基于promise的中间件</span><br><span class="line">    // 就直接返回</span><br><span class="line">    return mw</span><br><span class="line">  &#125;</span><br><span class="line">  //如果是generator函数就转换成promise形式</span><br><span class="line">  const converted = function (ctx, next) &#123;</span><br><span class="line">    return co.call(ctx, mw.call(ctx, createGenerator(next)))</span><br><span class="line">  &#125;</span><br><span class="line">  converted._name = mw._name || mw.name</span><br><span class="line">  return converted</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const co = require(&apos;co&apos;)</span><br><span class="line"></span><br><span class="line">function co(gen) &#123;</span><br><span class="line">  var ctx = this;</span><br><span class="line">  var args = slice.call(arguments, 1)</span><br><span class="line"></span><br><span class="line">  // we wrap everything in a promise to avoid promise chaining,</span><br><span class="line">  // which leads to memory leak errors.</span><br><span class="line">  // see https://github.com/tj/co/issues/180</span><br><span class="line">  return new Promise(function(resolve, reject) &#123;</span><br><span class="line">    if (typeof gen === &apos;function&apos;) gen = gen.apply(ctx, args);</span><br><span class="line">    if (!gen || typeof gen.next !== &apos;function&apos;) return resolve(gen);</span><br><span class="line"></span><br><span class="line">    onFulfilled();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param &#123;Mixed&#125; res</span><br><span class="line">     * @return &#123;Promise&#125;</span><br><span class="line">     * @api private</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    function onFulfilled(res) &#123;</span><br><span class="line">      var ret;</span><br><span class="line">      try &#123;</span><br><span class="line">        ret = gen.next(res);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      next(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param &#123;Error&#125; err</span><br><span class="line">     * @return &#123;Promise&#125;</span><br><span class="line">     * @api private</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    function onRejected(err) &#123;</span><br><span class="line">      var ret;</span><br><span class="line">      try &#123;</span><br><span class="line">        ret = gen.throw(err);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      next(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Get the next value in the generator,</span><br><span class="line">     * return a promise.</span><br><span class="line">     *</span><br><span class="line">     * @param &#123;Object&#125; ret</span><br><span class="line">     * @return &#123;Promise&#125;</span><br><span class="line">     * @api private</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    function next(ret) &#123;</span><br><span class="line">      if (ret.done) return resolve(ret.value);</span><br><span class="line">      var value = toPromise.call(ctx, ret.value);</span><br><span class="line">      if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);</span><br><span class="line">      return onRejected(new TypeError(&apos;You may only yield a function, promise, generator, array, or object, &apos;</span><br><span class="line">        + &apos;but the following object was passed: &quot;&apos; + String(ret.value) + &apos;&quot;&apos;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h1><p>调用listen函数开启服务时，整合所有中间件为一个大函数，大函数中进行剥洋葱流程<br>在收到请求时调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">application.js</span><br><span class="line"></span><br><span class="line">listen(...args) &#123;</span><br><span class="line">  debug(&apos;listen&apos;);</span><br><span class="line">  const server = http.createServer(this.callback());</span><br><span class="line">  return server.listen(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">callback() &#123;</span><br><span class="line">  const fn = compose(this.middleware); //整合中间件</span><br><span class="line"></span><br><span class="line">  if (!this.listenerCount(&apos;error&apos;)) this.on(&apos;error&apos;, this.onerror);</span><br><span class="line"></span><br><span class="line">  const handleRequest = (req, res) =&gt; &#123;</span><br><span class="line">    const ctx = this.createContext(req, res);</span><br><span class="line">    return this.handleRequest(ctx, fn); //调用中间件</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return handleRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handleRequest(ctx, fnMiddleware) &#123;</span><br><span class="line">  //通过传递过来的ctx,获取到原生的可写流</span><br><span class="line">  const res = ctx.res;</span><br><span class="line">  //设置默认状态码</span><br><span class="line">  res.statusCode = 404;</span><br><span class="line">  const onerror = err =&gt; ctx.onerror(err);</span><br><span class="line">  const handleResponse = () =&gt; respond(ctx);</span><br><span class="line">  onFinished(res, onerror);</span><br><span class="line">  //调用中间件大函数 同时准备catch处理中间件级错误</span><br><span class="line">  return fnMiddleware(ctx).then(handleResponse).catch(onerror); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整合中间件 ，返回大函数，大函数中有剥洋葱模型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function compose (middleware) &#123;</span><br><span class="line">  if (!Array.isArray(middleware)) throw new TypeError(&apos;Middleware stack must be an array!&apos;)</span><br><span class="line">  for (const fn of middleware) &#123;</span><br><span class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;Middleware must be composed of functions!&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">  //调用时fnMiddleware(ctx).then(handleResponse).catch(onerror); </span><br><span class="line">  //next 是undefined</span><br><span class="line">  return function (context, next) &#123;</span><br><span class="line">    // last called middleware #</span><br><span class="line">    let index = -1</span><br><span class="line">    return dispatch(0)</span><br><span class="line">    function dispatch (i) &#123;</span><br><span class="line">      if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">      index = i</span><br><span class="line">      let fn = middleware[i]</span><br><span class="line">      if (i === middleware.length) fn = next</span><br><span class="line">      if (!fn) return Promise.resolve()</span><br><span class="line">      try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</span><br><span class="line">        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span><br><span class="line">      &#125; catch (err) &#123;</span><br><span class="line">        return Promise.reject(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="剥洋葱流程"><a href="#剥洋葱流程" class="headerlink" title="剥洋葱流程"></a>剥洋葱流程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let index = -1</span><br><span class="line">return dispatch(0) //从第一个中间件开始执行</span><br><span class="line">function dispatch (i) &#123;</span><br><span class="line">  //防止next 在一个中间件中被调用多次</span><br><span class="line">  if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">  index = i</span><br><span class="line">  let fn = middleware[i] //拿到中间件</span><br><span class="line">  if (i === middleware.length) fn = next //如果中间件函数全部调用完，fn 赋值为next,next为undefined</span><br><span class="line">  if (!fn) return Promise.resolve() //fn为next=&gt;undefined时成立，即执行到最后返回一个Promise.resolve() 可以继续写then</span><br><span class="line">  try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</span><br><span class="line">    //执行中间件函数，传入ctx,next参数，next即dispatch.bind(null, i + 1)，</span><br><span class="line">    //递归调用下一个中间件函数</span><br><span class="line">    //从这一步可以实现await next()时，先执行下一个中间件函数</span><br><span class="line">    //中间件有调用next,就利用await暂停当前中间件执行，开始执行下一个中间件</span><br><span class="line">    return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    return Promise.reject(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用await暂停当前中间件执行，调用next开始执行下一个中间件</p>
<p>如果下一个中间件没有调next,且不是最后一个中间件，<br>即不会再调用dispatch执行下下一个中间件，则后续中间件都不会被执行到</p>
<p>如果下一个中间件是最后一个中间件，且在其中调用了next,则不会走到这个流程，<br>在上面的流程中就return</p>
<p>如果下一个中间件是最后一个中间件,则执行完return Promise.resolve<br>上一个中间件await 拿到结果后继续执行await后面的代码<br>执行完await后面代码后，上上一个中间件await 拿到结果，继续执行当前中间件await后代码<br>依次类推，直到第一个中间件await后代码执行完毕，整个中间件流程，<br>即剥洋葱流程先内层后外层执行流程完毕<br>返回promise 接着then处理响应或者中间有错误捕获错误<br>fnMiddleware(ctx).then(handleResponse).catch(onerror)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuex2.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuex2.html" itemprop="url">
                  vuex 源码学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-27T07:46:15+08:00">
                2020-04-27
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">let moduleA = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state()&#123; </span><br><span class="line">    return&#123;</span><br><span class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/aa/getCount&apos;] 作为b子模块时</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter~~~~~&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;,</span><br><span class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let moduleB = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state: &#123; </span><br><span class="line">    countb: 0,//this.$store.state.b.countb</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/getCount&apos;] 因为设置了namespaced所以可以重名</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter~~~~~&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</span><br><span class="line">      state.countb++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</span><br><span class="line">    aa: moduleA,//this.$store.state.b.aa.counta</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// vuex相关代码</span><br><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123; </span><br><span class="line">    count: 0, //this.$store.state.count</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters.getCount</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    a: moduleA, //this.$store.state.a.counta</span><br><span class="line">    b: moduleB //this.$store.state.b.countb</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上面store结构为例，分析vuex源码</p>
<h1 id="new-Store"><a href="#new-Store" class="headerlink" title="new Store"></a>new Store</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">var Store = function Store (options) &#123;</span><br><span class="line">   var this$1 = this;</span><br><span class="line">   if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line">   if (!Vue &amp;&amp; typeof window !== &apos;undefined&apos; &amp;&amp; window.Vue) &#123;</span><br><span class="line">     install(window.Vue);</span><br><span class="line">   &#125;</span><br><span class="line">   var plugins = options.plugins; if ( plugins === void 0 ) plugins = [];</span><br><span class="line">   var strict = options.strict; if ( strict === void 0 ) strict = false;</span><br><span class="line"></span><br><span class="line">   // 一些内部参数</span><br><span class="line">   this._committing = false;</span><br><span class="line">   this._actions = Object.create(null);</span><br><span class="line">   this._actionSubscribers = [];</span><br><span class="line">   this._mutations = Object.create(null);</span><br><span class="line">   this._wrappedGetters = Object.create(null);</span><br><span class="line">   this._modules = new ModuleCollection(options);</span><br><span class="line">   this._modulesNamespaceMap = Object.create(null);</span><br><span class="line">   this._subscribers = [];</span><br><span class="line">   this._watcherVM = new Vue();</span><br><span class="line">   this._makeLocalGettersCache = Object.create(null);</span><br><span class="line"></span><br><span class="line">   //绑定 commit 和 dispatch 的执行对象始终指向自己，防止外界重新绑定</span><br><span class="line">   var store = this;</span><br><span class="line">   var ref = this;</span><br><span class="line">   var dispatch = ref.dispatch;</span><br><span class="line">   var commit = ref.commit;</span><br><span class="line">   this.dispatch = function boundDispatch (type, payload) &#123;</span><br><span class="line">     return dispatch.call(store, type, payload)</span><br><span class="line">   &#125;;</span><br><span class="line">   this.commit = function boundCommit (type, payload, options) &#123;</span><br><span class="line">     return commit.call(store, type, payload, options)</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   // 严格模式</span><br><span class="line">   //使 Vuex store 进入严格模式，在严格模式下，任何 mutation 处理函数以外修改 Vuex state 都会抛出错误。</span><br><span class="line">   this.strict = strict;</span><br><span class="line">   //拿到处理后的state</span><br><span class="line">   var state = this._modules.root.state;</span><br><span class="line"></span><br><span class="line">   // 初始化全局module</span><br><span class="line">   // 同时递归注册所有子模块</span><br><span class="line">   // 收集this._wrappedGetters中的所有模块的getters</span><br><span class="line">   installModule(this, state, [], this._modules.root);</span><br><span class="line"></span><br><span class="line">   // 初始化store vm, 用于数据响应</span><br><span class="line">   // 同时注册 _wrappedGetters 作为计算属性)</span><br><span class="line">   resetStoreVM(this, state);</span><br><span class="line"></span><br><span class="line">   // 使用插件处理</span><br><span class="line">   plugins.forEach(function (plugin) &#123; return plugin(this$1); &#125;);</span><br><span class="line">   //options.devtools为某个特定的 Vuex 实例打开或关闭 devtools。</span><br><span class="line">   //对于传入 false 的实例来说 Vuex store 不会订阅到 devtools 插件。可用于一个页面中有多个 store 的情况</span><br><span class="line">   var useDevtools = options.devtools !== undefined ? options.devtools : Vue.config.devtools;</span><br><span class="line">   if (useDevtools) &#123;</span><br><span class="line">     devtoolPlugin(this);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">function install (_Vue) &#123;</span><br><span class="line">  if (Vue &amp;&amp; _Vue === Vue) &#123;</span><br><span class="line">    //Vue.use(Vuex) should be called only once</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  Vue = _Vue;</span><br><span class="line">  applyMixin(Vue);</span><br><span class="line">&#125;</span><br><span class="line">function applyMixin (Vue) &#123;</span><br><span class="line">  var version = Number(Vue.version.split(&apos;.&apos;)[0]);</span><br><span class="line"></span><br><span class="line">  if (version &gt;= 2) &#123;</span><br><span class="line">    Vue.mixin(&#123; beforeCreate: vuexInit &#125;); //使用beforeCreate将$store绑定到每个VueComponent 上</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    //小于版本2的用_init初始化</span><br><span class="line">    var _init = Vue.prototype._init;</span><br><span class="line">    Vue.prototype._init = function (options) &#123;</span><br><span class="line">      if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">      options.init = options.init</span><br><span class="line">        ? [vuexInit].concat(options.init)</span><br><span class="line">        : vuexInit;</span><br><span class="line">      _init.call(this, options);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function vuexInit () &#123;</span><br><span class="line">    var options = this.$options;</span><br><span class="line">    // store injection</span><br><span class="line">    if (options.store) &#123;</span><br><span class="line">      this.$store = typeof options.store === &apos;function&apos;</span><br><span class="line">        ? options.store()</span><br><span class="line">        : options.store;</span><br><span class="line">    &#125; else if (options.parent &amp;&amp; options.parent.$store) &#123;</span><br><span class="line">      this.$store = options.parent.$store; //当前组件$store指向父组件$store，递归指向，从而保证唯一性</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ModuleCollection"><a href="#ModuleCollection" class="headerlink" title="ModuleCollection"></a>ModuleCollection</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var ModuleCollection = function ModuleCollection (rawRootModule) &#123;</span><br><span class="line">    // 根据new Store 传入的参数，注册根模块</span><br><span class="line">    this.register([], rawRootModule, false);</span><br><span class="line">  &#125;;</span><br><span class="line">  // new store 时传入的参数 [], rawRootModule, false</span><br><span class="line">  ModuleCollection.prototype.register = function register (path, rawModule, runtime) &#123;</span><br><span class="line">    var this$1 = this;</span><br><span class="line">    if ( runtime === void 0 ) runtime = true;</span><br><span class="line">    var newModule = new Module(rawModule, runtime);</span><br><span class="line">    //&#123;runtime:false,_children:&#123;&#125;,_rawModule:rawModule,state:rawModule上面的state,__proto__:一系列方法&#125;</span><br><span class="line">    if (path.length === 0) &#123;</span><br><span class="line">      this.root = newModule; //初始化根模块</span><br><span class="line">    &#125; else &#123; //初始化子模块</span><br><span class="line">      var parent = this.get(path.slice(0, -1)); //拿到父模块</span><br><span class="line">      parent.addChild(path[path.length - 1], newModule); //给父模块_children属性增加子模块</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 注册嵌套模块</span><br><span class="line">    if (rawModule.modules) &#123;</span><br><span class="line">      forEachValue(rawModule.modules, function (rawChildModule, key) &#123;</span><br><span class="line">        this$1.register(path.concat(key), rawChildModule, runtime); //递归注册</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var Module = function Module (rawModule, runtime) &#123;</span><br><span class="line">  this.runtime = runtime;</span><br><span class="line">  // Store some children item</span><br><span class="line">  this._children = Object.create(null);</span><br><span class="line">  // Store the origin module object which passed by programmer</span><br><span class="line">  this._rawModule = rawModule;</span><br><span class="line">  var rawState = rawModule.state;</span><br><span class="line"></span><br><span class="line">  // Store the origin module&apos;s state</span><br><span class="line">  this.state = (typeof rawState === &apos;function&apos; ? rawState() : rawState) || &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Module.prototype.addChild = function addChild (key, module) &#123;</span><br><span class="line">  this._children[key] = module;</span><br><span class="line">&#125;;</span><br><span class="line">Module.prototype.getChild = function getChild (key) &#123;</span><br><span class="line">  return this._children[key]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>  所以这一步结束后<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this._modules = new ModuleCollection(options);</span><br></pre></td></tr></table></figure></p>
<p>  this._modules为如下对象<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection &#123;</span><br><span class="line">  root: Module &#123;</span><br><span class="line">    runtime: false,</span><br><span class="line">    _children: &#123;a: Module, b: Module&#125;</span><br><span class="line">    _rawModule: &#123;state: &#123;…&#125;, mutations: &#123;…&#125;, modules: &#123;…&#125;&#125;</span><br><span class="line">    state: &#123;count: 0&#125;</span><br><span class="line">    __proto__: Object</span><br><span class="line">  &#125;</span><br><span class="line">  __proto__: Object</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  ModuleCollection对象上的其他方法<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection.prototype.get = function get (path) &#123;</span><br><span class="line">  return path.reduce(function (module, key) &#123;</span><br><span class="line">    return module.getChild(key)</span><br><span class="line">  &#125;, this.root)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ModuleCollection.prototype.getNamespace = function getNamespace (path) &#123;</span><br><span class="line">  var module = this.root;</span><br><span class="line">  //对设置了namespaced的模块进行拼接</span><br><span class="line">  return path.reduce(function (namespace, key) &#123;</span><br><span class="line">    module = module.getChild(key); //从_children取出子模块</span><br><span class="line">    return namespace + (module.namespaced ? key + &apos;/&apos; : &apos;&apos;)</span><br><span class="line">  &#125;, &apos;&apos;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ModuleCollection.prototype.update = function update$1 (rawRootModule) &#123;</span><br><span class="line">  update([], this.root, rawRootModule);</span><br><span class="line">&#125;;</span><br><span class="line">ModuleCollection.prototype.unregister = function unregister (path) &#123;</span><br><span class="line">  var parent = this.get(path.slice(0, -1));</span><br><span class="line">  var key = path[path.length - 1];</span><br><span class="line">  if (!parent.getChild(key).runtime) &#123; return &#125;</span><br><span class="line"></span><br><span class="line">  parent.removeChild(key);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1 id="installModule"><a href="#installModule" class="headerlink" title="installModule"></a>installModule</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">//初始化调用时传参 （this, state, [], this._modules.root)</span><br><span class="line">function installModule (store, rootState, path, module, hot) &#123;</span><br><span class="line">  //根模块时，参数分别为store本身，根模块state, [], 根模块，undefined</span><br><span class="line">  //递归子模块时，参数为 store本身，根模块state,子模块在modules对象中的路径key值</span><br><span class="line">  var isRoot = !path.length; //空数组即根模块</span><br><span class="line">  //ModuleCollection.prototype.getNamespace 根模块返回空字符串&apos;&apos;</span><br><span class="line">  var namespace = store._modules.getNamespace(path); </span><br><span class="line"></span><br><span class="line">  //如果模块设置了命名空间 在store._modulesNamespaceMap属性中注册</span><br><span class="line">  if (module.namespaced) &#123;</span><br><span class="line">    if (store._modulesNamespaceMap[namespace] &amp;&amp; &quot;development&quot; !== &apos;production&apos;) &#123;</span><br><span class="line">      console.error((&quot;[vuex] duplicate namespace &quot; + namespace + &quot; for the namespaced module &quot; + (path.join(&apos;/&apos;))));</span><br><span class="line">    &#125;</span><br><span class="line">    store._modulesNamespaceMap[namespace] = module;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //对子模块state进行数据劫持处理</span><br><span class="line">  if (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">    var parentState = getNestedState(rootState, path.slice(0, -1));</span><br><span class="line">    var moduleName = path[path.length - 1];</span><br><span class="line">    store._withCommit(function () &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        if (moduleName in parentState) &#123;</span><br><span class="line">          console.warn(</span><br><span class="line">            (&quot;[vuex] state field \&quot;&quot; + moduleName + &quot;\&quot; was overridden by a module with the same name at \&quot;&quot; + (path.join(&apos;.&apos;)) + &quot;\&quot;&quot;)</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      Vue.set(parentState, moduleName, module.state); //将子模块state按照模块名添加到父模块state中</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  //根据有无namespace</span><br><span class="line">  //截取state,getter的get,</span><br><span class="line">  //封装触发函数dispactch和commit,有namespace拼接后再触发</span><br><span class="line">  var local = module.context = makeLocalContext(store, namespace, path);</span><br><span class="line"></span><br><span class="line">  module.forEachMutation(function (mutation, key) &#123;</span><br><span class="line">    var namespacedType = namespace + key;</span><br><span class="line">    registerMutation(store, namespacedType, mutation, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  module.forEachAction(function (action, key) &#123;</span><br><span class="line">    var type = action.root ? key : namespace + key;</span><br><span class="line">    var handler = action.handler || action;</span><br><span class="line">    registerAction(store, type, handler, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  module.forEachGetter(function (getter, key) &#123;</span><br><span class="line">    var namespacedType = namespace + key;</span><br><span class="line">    registerGetter(store, namespacedType, getter, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  module.forEachChild(function (child, key) &#123;</span><br><span class="line">    installModule(store, rootState, path.concat(key), child, hot);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="forEachValue"><a href="#forEachValue" class="headerlink" title="forEachValue"></a>forEachValue</h2><p>公共方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function forEachValue (obj, fn) &#123;</span><br><span class="line">   Object.keys(obj).forEach(function (key) &#123; return fn(obj[key], key); &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="注册-Mutation"><a href="#注册-Mutation" class="headerlink" title="注册 Mutation"></a>注册 Mutation</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachMutation = function forEachMutation (fn) &#123;</span><br><span class="line">  if (this._rawModule.mutations) &#123;</span><br><span class="line">    forEachValue(this._rawModule.mutations, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">//参数：store本身，经过namespace拼接后的类型标记，具体对应的mutation,当前模块上封装好的state,getters,commit,dispatch</span><br><span class="line">function registerMutation (store, type, handler, local) &#123;</span><br><span class="line">  var entry = store._mutations[type] || (store._mutations[type] = []);</span><br><span class="line">  entry.push(function wrappedMutationHandler (payload) &#123;</span><br><span class="line">    handler.call(store, local.state, payload);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结：将当前模块的mutations上的各个mutations结合namespace存储到store._mutations属性上<br>可见，如果子模块没有namespace,同名的mutation会跟根模块的mutation存储在相同的type下面<br>所以当触发commit的时候会一起执行，<br>如果子模块设置了namespace，这时存储的type会包含该模块对应的名称，<br>即使同名的mutation也被存放在不同的type中，实现了隔离</p>
<h2 id="注册-Action"><a href="#注册-Action" class="headerlink" title="注册 Action"></a>注册 Action</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachAction = function forEachAction (fn) &#123;</span><br><span class="line">  if (this._rawModule.actions) &#123;</span><br><span class="line">    forEachValue(this._rawModule.actions, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function registerAction (store, type, handler, local) &#123;</span><br><span class="line">  var entry = store._actions[type] || (store._actions[type] = []);</span><br><span class="line">  entry.push(function wrappedActionHandler (payload) &#123;</span><br><span class="line">    var res = handler.call(store, &#123;</span><br><span class="line">      dispatch: local.dispatch,</span><br><span class="line">      commit: local.commit,</span><br><span class="line">      getters: local.getters,</span><br><span class="line">      state: local.state,</span><br><span class="line">      rootGetters: store.getters,</span><br><span class="line">      rootState: store.state</span><br><span class="line">    &#125;, payload);</span><br><span class="line">    if (!isPromise(res)) &#123;</span><br><span class="line">      res = Promise.resolve(res);</span><br><span class="line">    &#125;</span><br><span class="line">    if (store._devtoolHook) &#123;</span><br><span class="line">      return res.catch(function (err) &#123;</span><br><span class="line">        store._devtoolHook.emit(&apos;vuex:error&apos;, err);</span><br><span class="line">        throw err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结：将当前模块的actions上的各个action结合namespace存储到store._actions属性上</p>
<h2 id="注册-Getter"><a href="#注册-Getter" class="headerlink" title="注册 Getter"></a>注册 Getter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachGetter = function forEachGetter (fn) &#123;</span><br><span class="line">  if (this._rawModule.getters) &#123;</span><br><span class="line">    forEachValue(this._rawModule.getters, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function registerGetter (store, type, rawGetter, local) &#123;</span><br><span class="line">  if (store._wrappedGetters[type]) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      console.error((&quot;[vuex] duplicate getter key: &quot; + type));</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  store._wrappedGetters[type] = function wrappedGetter (store) &#123;</span><br><span class="line">    return rawGetter(</span><br><span class="line">      local.state, // 当前模块state</span><br><span class="line">      local.getters, // 当前模块 getters</span><br><span class="line">      store.state, // 根模块 state</span><br><span class="line">      store.getters // 根模块 getters</span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结：将当前模块的getters上的各个getter结合namespace存储到store._wrappedGetters属性上</p>
<h2 id="注册-Module"><a href="#注册-Module" class="headerlink" title="注册 Module"></a>注册 Module</h2><p>递归调用installModule注册子模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.forEachChild = function forEachChild (fn) &#123;</span><br><span class="line">  forEachValue(this._children, fn);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module.forEachChild(function (child, key) &#123;</span><br><span class="line">  installModule(store, rootState, path.concat(key), child, hot);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="makeLocalContext"><a href="#makeLocalContext" class="headerlink" title="makeLocalContext"></a>makeLocalContext</h2><p>优化 dispatch, commit, getters and state<br>如果没有设置namespace, 就使用根模块的名称<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">  function makeLocalContext (store, namespace, path) &#123;</span><br><span class="line">    var noNamespace = namespace === &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    var local = &#123;</span><br><span class="line">      dispatch: noNamespace ? store.dispatch : function (_type, _payload, _options) &#123;</span><br><span class="line">        var args = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">        var payload = args.payload;</span><br><span class="line">        var options = args.options;</span><br><span class="line">        var type = args.type;</span><br><span class="line"></span><br><span class="line">        if (!options || !options.root) &#123;</span><br><span class="line">          type = namespace + type;//有namespace拼接后再触发</span><br><span class="line">          if (!store._actions[type]) &#123;</span><br><span class="line">            console.error((&quot;[vuex] unknown local action type: &quot; + (args.type) + &quot;, global type: &quot; + type));</span><br><span class="line">            return</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return store.dispatch(type, payload)</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      commit: noNamespace ? store.commit : function (_type, _payload, _options) &#123;</span><br><span class="line">        var args = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">        var payload = args.payload;</span><br><span class="line">        var options = args.options;</span><br><span class="line">        var type = args.type;</span><br><span class="line"></span><br><span class="line">        if (!options || !options.root) &#123;</span><br><span class="line">          type = namespace + type; //有namespace拼接后再触发</span><br><span class="line">          if (!store._mutations[type]) &#123;</span><br><span class="line">            console.error((&quot;[vuex] unknown local mutation type: &quot; + (args.type) + &quot;, global type: &quot; + type));</span><br><span class="line">            return</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        store.commit(type, payload, options);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // getters and state object must be gotten lazily</span><br><span class="line">    // because they will be changed by vm update</span><br><span class="line">    Object.defineProperties(local, &#123;</span><br><span class="line">      getters: &#123;</span><br><span class="line">        get: noNamespace</span><br><span class="line">          ? function () &#123; return store.getters; &#125;</span><br><span class="line">          : function () &#123; return makeLocalGetters(store, namespace); &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      state: &#123;</span><br><span class="line">        get: function () &#123; return getNestedState(store.state, path); &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return local</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">function makeLocalGetters (store, namespace) &#123;</span><br><span class="line">  if (!store._makeLocalGettersCache[namespace]) &#123;</span><br><span class="line">    var gettersProxy = &#123;&#125;;</span><br><span class="line">    var splitPos = namespace.length;</span><br><span class="line">    Object.keys(store.getters).forEach(function (type) &#123;</span><br><span class="line">      // skip if the target getter is not match this namespace</span><br><span class="line">      if (type.slice(0, splitPos) !== namespace) &#123; return &#125;</span><br><span class="line"></span><br><span class="line">      // extract local getter type</span><br><span class="line">      var localType = type.slice(splitPos);</span><br><span class="line"></span><br><span class="line">      // Add a port to the getters proxy.</span><br><span class="line">      // Define as getter property because</span><br><span class="line">      // we do not want to evaluate the getters in this time.</span><br><span class="line">      Object.defineProperty(gettersProxy, localType, &#123;</span><br><span class="line">        get: function () &#123; return store.getters[type]; &#125;,</span><br><span class="line">        enumerable: true</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    store._makeLocalGettersCache[namespace] = gettersProxy;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return store._makeLocalGettersCache[namespace]</span><br><span class="line">&#125;</span><br><span class="line">function getNestedState (state, path) &#123;</span><br><span class="line">  return path.reduce(function (state, key) &#123; return state[key]; &#125;, state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>该步骤完成后</p>
<p>store对象长这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">commit: ƒ boundCommit(type, payload, options)</span><br><span class="line">dispatch: ƒ boundDispatch(type, payload)</span><br><span class="line">strict: false</span><br><span class="line">_actionSubscribers: []</span><br><span class="line">_actions: &#123;&#125; //存放所有模块的action</span><br><span class="line">_committing: false</span><br><span class="line">_makeLocalGettersCache: &#123;&#125;</span><br><span class="line">_modules: ModuleCollection &#123;</span><br><span class="line">  root: Module</span><br><span class="line">  context: //新增根据namespace处理后的触发函数</span><br><span class="line">    commit: ƒ boundCommit(type, payload, options)</span><br><span class="line">    dispatch: ƒ boundDispatch(type, payload)</span><br><span class="line">    getters: (...)</span><br><span class="line">    state: (...)</span><br><span class="line">    get getters: ƒ ()</span><br><span class="line">    get state: ƒ ()</span><br><span class="line">    __proto__: Object</span><br><span class="line">  runtime: false</span><br><span class="line">  state: //将子模块state集中到根模块state</span><br><span class="line">    a: &#123;counta: 2329&#125;</span><br><span class="line">    b:</span><br><span class="line">      aa: &#123;counta: 2329&#125;</span><br><span class="line">      countb: 0</span><br><span class="line">      __proto__: Object</span><br><span class="line">    count: 0</span><br><span class="line">    __proto__: Object</span><br><span class="line">  _children: //对子模块递归过程挂载context属性</span><br><span class="line">    a: Module &#123;runtime: false, _children: &#123;…&#125;, _rawModule: &#123;…&#125;, state: &#123;…&#125;, context: &#123;…&#125;&#125;</span><br><span class="line">    b: Module &#123;runtime: false, _children: &#123;…&#125;, _rawModule: &#123;…&#125;, state: &#123;…&#125;, context: &#123;…&#125;&#125;</span><br><span class="line">  _rawModule: &#123;state: &#123;…&#125;, mutations: &#123;…&#125;, modules: &#123;…&#125;&#125;</span><br><span class="line">  namespaced: (...)</span><br><span class="line">  __proto__: Object</span><br><span class="line">__proto__: Object</span><br><span class="line">&#125;</span><br><span class="line">_modulesNamespaceMap: &#123;b/: Module&#125; //存放设置了namespace的模块</span><br><span class="line">_mutations: &#123;increment: Array(1), incrementaaa: Array(1), b/increment: Array(1), b/incrementaaa: Array(1)&#125; //存放所有模块的mutation</span><br><span class="line">_subscribers: []</span><br><span class="line">_watcherVM: Vue &#123;_uid: 0, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: Vue, …&#125;</span><br><span class="line">_wrappedGetters: &#123;&#125; //存放所有模块的getters</span><br><span class="line">state: (...) //对局部变量做了处理，还没有挂到store上</span><br></pre></td></tr></table></figure>
<h1 id="resetStoreVM"><a href="#resetStoreVM" class="headerlink" title="resetStoreVM"></a>resetStoreVM</h1><p>利用vue的数据处理逻辑，解决getters和state之间订阅发布关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">function partial (fn, arg) &#123;</span><br><span class="line">  return function () &#123;</span><br><span class="line">    return fn(arg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function resetStoreVM (store, state, hot) &#123;</span><br><span class="line">    var oldVm = store._vm;</span><br><span class="line">    //绑定存储公共的getters</span><br><span class="line">    store.getters = &#123;&#125;;</span><br><span class="line">    // 重置内部getters缓存到_makeLocalGettersCache</span><br><span class="line">    store._makeLocalGettersCache = Object.create(null);</span><br><span class="line">    var wrappedGetters = store._wrappedGetters;</span><br><span class="line">    var computed = &#123;&#125;;</span><br><span class="line">    forEachValue(wrappedGetters, function (fn, key) &#123;</span><br><span class="line">      //如果直接使用，闭包里面会包含oldVm</span><br><span class="line">      computed[key] = partial(fn, store);</span><br><span class="line">      Object.defineProperty(store.getters, key, &#123;</span><br><span class="line">        get: function () &#123; return store._vm[key]; &#125;,//直接调用vue的compute属性</span><br><span class="line">        enumerable: true // for local getters</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //使用vue实例存放state和getters</span><br><span class="line">    var silent = Vue.config.silent;</span><br><span class="line">    /* Vue.config.silent暂时设置为true的目的是在new一个Vue实例的过程中不会报出一切警告 */</span><br><span class="line">    Vue.config.silent = true</span><br><span class="line">    store._vm = new Vue(&#123;</span><br><span class="line">      data: &#123;</span><br><span class="line">        $$state: state</span><br><span class="line">      &#125;,</span><br><span class="line">      computed: computed</span><br><span class="line">    &#125;);</span><br><span class="line">    Vue.config.silent = silent;</span><br><span class="line"></span><br><span class="line">     /* 使能严格模式，保证修改store只能通过mutation */</span><br><span class="line">    if (store.strict) &#123;</span><br><span class="line">      enableStrictMode(store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (oldVm) &#123;</span><br><span class="line">      if (hot) &#123;</span><br><span class="line">        // dispatch changes in all subscribed watchers</span><br><span class="line">        // to force getter re-evaluation for hot reloading.</span><br><span class="line">        store._withCommit(function () &#123;</span><br><span class="line">          oldVm._data.$$state = null;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      Vue.nextTick(function () &#123; return oldVm.$destroy(); &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="store上的其他方法"><a href="#store上的其他方法" class="headerlink" title="store上的其他方法"></a>store上的其他方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">Store.prototype.commit = function commit (_type, _payload, _options) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line"></span><br><span class="line">  // check object-style commit</span><br><span class="line">  var ref = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">  var type = ref.type;</span><br><span class="line">  var payload = ref.payload;</span><br><span class="line">  var options = ref.options;</span><br><span class="line"></span><br><span class="line">  var mutation = &#123; type: type, payload: payload &#125;;</span><br><span class="line">  var entry = this._mutations[type];</span><br><span class="line">  if (!entry) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      console.error((&quot;[vuex] unknown mutation type: &quot; + type));</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  this._withCommit(function () &#123;</span><br><span class="line">    entry.forEach(function commitIterator (handler) &#123;</span><br><span class="line">      handler(payload);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  this._subscribers</span><br><span class="line">    .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span><br><span class="line">    .forEach(function (sub) &#123; return sub(mutation, this$1.state); &#125;);</span><br><span class="line"></span><br><span class="line">  if (</span><br><span class="line">    options &amp;&amp; options.silent</span><br><span class="line">  ) &#123;</span><br><span class="line">    console.warn(</span><br><span class="line">      &quot;[vuex] mutation type: &quot; + type + &quot;. Silent option has been removed. &quot; +</span><br><span class="line">      &apos;Use the filter functionality in the vue-devtools&apos;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Store.prototype.dispatch = function dispatch (_type, _payload) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    // check object-style dispatch</span><br><span class="line">    var ref = unifyObjectStyle(_type, _payload);</span><br><span class="line">      var type = ref.type;</span><br><span class="line">      var payload = ref.payload;</span><br><span class="line"></span><br><span class="line">    var action = &#123; type: type, payload: payload &#125;;</span><br><span class="line">    var entry = this._actions[type];</span><br><span class="line">    if (!entry) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        console.error((&quot;[vuex] unknown action type: &quot; + type));</span><br><span class="line">      &#125;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      this._actionSubscribers</span><br><span class="line">        .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span><br><span class="line">        .filter(function (sub) &#123; return sub.before; &#125;)</span><br><span class="line">        .forEach(function (sub) &#123; return sub.before(action, this$1.state); &#125;);</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        console.warn(&quot;[vuex] error in before action subscribers: &quot;);</span><br><span class="line">        console.error(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var result = entry.length &gt; 1</span><br><span class="line">      ? Promise.all(entry.map(function (handler) &#123; return handler(payload); &#125;))</span><br><span class="line">      : entry[0](payload);</span><br><span class="line"></span><br><span class="line">    return result.then(function (res) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        this$1._actionSubscribers</span><br><span class="line">          .filter(function (sub) &#123; return sub.after; &#125;)</span><br><span class="line">          .forEach(function (sub) &#123; return sub.after(action, this$1.state); &#125;);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          console.warn(&quot;[vuex] error in after action subscribers: &quot;);</span><br><span class="line">          console.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return res</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.subscribe = function subscribe (fn) &#123;</span><br><span class="line">    return genericSubscribe(fn, this._subscribers)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.subscribeAction = function subscribeAction (fn) &#123;</span><br><span class="line">    var subs = typeof fn === &apos;function&apos; ? &#123; before: fn &#125; : fn;</span><br><span class="line">    return genericSubscribe(subs, this._actionSubscribers)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.watch = function watch (getter, cb, options) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      assert(typeof getter === &apos;function&apos;, &quot;store.watch only accepts a function.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return this._watcherVM.$watch(function () &#123; return getter(this$1.state, this$1.getters); &#125;, cb, options)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.replaceState = function replaceState (state) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    this._withCommit(function () &#123;</span><br><span class="line">      this$1._vm._data.$$state = state;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.registerModule = function registerModule (path, rawModule, options) &#123;</span><br><span class="line">      if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    if (typeof path === &apos;string&apos;) &#123; path = [path]; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      assert(Array.isArray(path), &quot;module path must be a string or an Array.&quot;);</span><br><span class="line">      assert(path.length &gt; 0, &apos;cannot register the root module by using registerModule.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this._modules.register(path, rawModule);</span><br><span class="line">    installModule(this, this.state, path, this._modules.get(path), options.preserveState);</span><br><span class="line">    // reset store to update getters...</span><br><span class="line">    resetStoreVM(this, this.state);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.unregisterModule = function unregisterModule (path) &#123;</span><br><span class="line">      var this$1 = this;</span><br><span class="line"></span><br><span class="line">    if (typeof path === &apos;string&apos;) &#123; path = [path]; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      assert(Array.isArray(path), &quot;module path must be a string or an Array.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this._modules.unregister(path);</span><br><span class="line">    this._withCommit(function () &#123;</span><br><span class="line">      var parentState = getNestedState(this$1.state, path.slice(0, -1));</span><br><span class="line">      Vue.delete(parentState, path[path.length - 1]);</span><br><span class="line">    &#125;);</span><br><span class="line">    resetStore(this);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype.hotUpdate = function hotUpdate (newOptions) &#123;</span><br><span class="line">    this._modules.update(newOptions);</span><br><span class="line">    resetStore(this, true);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Store.prototype._withCommit = function _withCommit (fn) &#123;</span><br><span class="line">    var committing = this._committing;</span><br><span class="line">    this._committing = true;</span><br><span class="line">    fn();</span><br><span class="line">    this._committing = committing;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  function genericSubscribe (fn, subs) &#123;</span><br><span class="line">    if (subs.indexOf(fn) &lt; 0) &#123;</span><br><span class="line">      subs.push(fn);</span><br><span class="line">    &#125;</span><br><span class="line">    return function () &#123;</span><br><span class="line">      var i = subs.indexOf(fn);</span><br><span class="line">      if (i &gt; -1) &#123;</span><br><span class="line">        subs.splice(i, 1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function resetStore (store, hot) &#123;</span><br><span class="line">    store._actions = Object.create(null);</span><br><span class="line">    store._mutations = Object.create(null);</span><br><span class="line">    store._wrappedGetters = Object.create(null);</span><br><span class="line">    store._modulesNamespaceMap = Object.create(null);</span><br><span class="line">    var state = store.state;</span><br><span class="line">    // init all modules</span><br><span class="line">    installModule(store, state, [], store._modules.root, true);</span><br><span class="line">    // reset vm</span><br><span class="line">    resetStoreVM(store, state, hot);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/src4.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/src4.html" itemprop="url">
                  vue 源码学习四【数据双向绑定】
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-11T22:58:15+08:00">
                2020-04-11
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vue双向绑定原理，依赖收集是<br>在created声明周期之前，<br>render生成虚拟dom的时候<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._init = function (options) &#123;</span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor),</span><br><span class="line">    options || &#123;&#125;,</span><br><span class="line">    vm</span><br><span class="line">  );</span><br><span class="line">  callHook(vm, &apos;beforeCreate&apos;);//运行订阅了beforecreate钩子的相关方法</span><br><span class="line">  initState(vm);//处理数据</span><br><span class="line">  callHook(vm, &apos;created&apos;);</span><br></pre></td></tr></table></figure></p>
<h1 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h1><p>转换成内置函数mergedInstanceDataFn<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">function mergeOptions (</span><br><span class="line">   parent,</span><br><span class="line">   child,</span><br><span class="line">   vm</span><br><span class="line"> ) &#123;</span><br><span class="line">   &#123;</span><br><span class="line">     checkComponents(child);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   if (typeof child === &apos;function&apos;) &#123;</span><br><span class="line">     child = child.options;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // ... normalizeProps, normalizeInject, normalizeDirectives</span><br><span class="line"></span><br><span class="line">   if (!child._base) &#123;</span><br><span class="line">     if (child.extends) &#123;</span><br><span class="line">       parent = mergeOptions(parent, child.extends, vm);</span><br><span class="line">     &#125;</span><br><span class="line">     if (child.mixins) &#123;</span><br><span class="line">       for (var i = 0, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">         parent = mergeOptions(parent, child.mixins[i], vm);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   var options = &#123;&#125;;</span><br><span class="line">   var key;</span><br><span class="line">   for (key in parent) &#123;</span><br><span class="line">     mergeField(key);</span><br><span class="line">   &#125;</span><br><span class="line">   for (key in child) &#123;</span><br><span class="line">     if (!hasOwn(parent, key)) &#123;</span><br><span class="line">       mergeField(key);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   //在上面的循环中会遍历到配置的options参数里的data属性，则会调用到strats.data</span><br><span class="line">   function mergeField (key) &#123; </span><br><span class="line">     var strat = strats[key] || defaultStrat;</span><br><span class="line">     options[key] = strat(parent[key], child[key], vm, key);</span><br><span class="line">   &#125;</span><br><span class="line">   return options</span><br><span class="line"> &#125;</span><br><span class="line"> //</span><br><span class="line"> strats.data = function (</span><br><span class="line">   parentVal,</span><br><span class="line">   childVal,</span><br><span class="line">   vm</span><br><span class="line"> ) &#123;</span><br><span class="line">   if (!vm) &#123;</span><br><span class="line">     //...vm就是VUE实例，所以不会走这里</span><br><span class="line">     return mergeDataOrFn(parentVal, childVal)</span><br><span class="line">   &#125;</span><br><span class="line">   return mergeDataOrFn(parentVal, childVal, vm)</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> function mergeDataOrFn (</span><br><span class="line">   parentVal,</span><br><span class="line">   childVal,</span><br><span class="line">   vm</span><br><span class="line"> ) &#123;</span><br><span class="line">   if (!vm) &#123;</span><br><span class="line">     ...</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     return function mergedInstanceDataFn () &#123;</span><br><span class="line">       // instance merge</span><br><span class="line">       var instanceData = typeof childVal === &apos;function&apos;</span><br><span class="line">         ? childVal.call(vm, vm)</span><br><span class="line">         : childVal;</span><br><span class="line">       var defaultData = typeof parentVal === &apos;function&apos;</span><br><span class="line">         ? parentVal.call(vm, vm)</span><br><span class="line">         : parentVal;</span><br><span class="line">       if (instanceData) &#123;</span><br><span class="line">         return mergeData(instanceData, defaultData)</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">         return defaultData</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这一步结束后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vm.$options.data = function mergedInstanceDataFn () &#123;</span><br><span class="line">  //声明时传递进来的data属性值,是函数则执行拿到对象</span><br><span class="line">  var instanceData = typeof childVal === &apos;function&apos; </span><br><span class="line">    ? childVal.call(vm, vm)</span><br><span class="line">    : childVal;</span><br><span class="line">  //内部属性没有data属性，所以 defaultData 为undefined</span><br><span class="line">  var defaultData = typeof parentVal === &apos;function&apos;</span><br><span class="line">    ? parentVal.call(vm, vm)</span><br><span class="line">    : parentVal;</span><br><span class="line">  if (instanceData) &#123;</span><br><span class="line">    return mergeData(instanceData, defaultData)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return defaultData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function mergeData (to, from) &#123;</span><br><span class="line">  if (!from) &#123; return to &#125;</span><br><span class="line">  ...//省略若干逻辑</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="数据劫持"><a href="#数据劫持" class="headerlink" title="数据劫持"></a>数据劫持</h1><p>开始进行真正初始化—数据劫持<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function initState (vm) &#123;</span><br><span class="line">  vm._watchers = [];</span><br><span class="line">  var opts = vm.$options;</span><br><span class="line">  if (opts.data) &#123;</span><br><span class="line">    initData(vm);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    observe(vm._data = &#123;&#125;, true /* asRootData */);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function initData (vm) &#123;</span><br><span class="line">    var data = vm.$options.data;</span><br><span class="line">    data = vm._data = typeof data === &apos;function&apos;</span><br><span class="line">      ? getData(data, vm)</span><br><span class="line">      : data || &#123;&#125;;</span><br><span class="line">    //得到的data不是object对象</span><br><span class="line">    if (!isPlainObject(data)) &#123;</span><br><span class="line">      data = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // proxy data on instance</span><br><span class="line">    var keys = Object.keys(data);</span><br><span class="line">    var props = vm.$options.props;</span><br><span class="line">    var methods = vm.$options.methods;</span><br><span class="line">    var i = keys.length;</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">      var key = keys[i];</span><br><span class="line">      &#123;if (methods &amp;&amp; hasOwn(methods, key)) &#123;...与method同名警告&#125;&#125;</span><br><span class="line">      if (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">       ...与prop同名警告</span><br><span class="line">      &#125; else if (!isReserved(key)) &#123; //不是以$或者_开头的key</span><br><span class="line">        proxy(vm, &quot;_data&quot;, key); //将key值存一份到vm的&apos;_data&apos;属性上</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // observe data</span><br><span class="line">    observe(data, true /* asRootData */);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getData (data, vm) &#123;</span><br><span class="line">    // #7573 disable dep collection when invoking(调用) data getters</span><br><span class="line">    pushTarget();</span><br><span class="line">    try &#123;</span><br><span class="line">      return data.call(vm, vm)</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      handleError(e, vm, &quot;data()&quot;);</span><br><span class="line">      return &#123;&#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      popTarget();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  var sharedPropertyDefinition = &#123;</span><br><span class="line">    enumerable: true,</span><br><span class="line">    configurable: true,</span><br><span class="line">    get: noop,</span><br><span class="line">    set: noop</span><br><span class="line">  &#125;;</span><br><span class="line">  function proxy (target, sourceKey, key) &#123;</span><br><span class="line">    sharedPropertyDefinition.get = function proxyGetter () &#123;</span><br><span class="line">      return this[sourceKey][key]</span><br><span class="line">    &#125;;</span><br><span class="line">    sharedPropertyDefinition.set = function proxySetter (val) &#123;</span><br><span class="line">      this[sourceKey][key] = val;</span><br><span class="line">    &#125;;</span><br><span class="line">    Object.defineProperty(target, key, sharedPropertyDefinition);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>给data创建观察者实例，挂载‘_ob_’属性，指向一个Observer对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function observe (value, asRootData) &#123;</span><br><span class="line">  if (!isObject(value) || value instanceof VNode) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  var ob;</span><br><span class="line">  if (hasOwn(value, &apos;__ob__&apos;) &amp;&amp; value.__ob__ instanceof Observer) &#123;</span><br><span class="line">    ob = value.__ob__;</span><br><span class="line">  &#125; else if (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !isServerRendering() &amp;&amp;</span><br><span class="line">    (Array.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    Object.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue</span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = new Observer(value);</span><br><span class="line">  &#125;</span><br><span class="line">  if (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++;</span><br><span class="line">  &#125;</span><br><span class="line">  return ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Observer对象有三个属性,‘<strong>ob</strong>’属性相同<br>{<br>  value:data,<br>  dep : new Dep();<br>  vmCount :0<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var Observer = function Observer (value) &#123;</span><br><span class="line">  this.value = value;</span><br><span class="line">  this.dep = new Dep();</span><br><span class="line">  this.vmCount = 0;</span><br><span class="line">  def(value, &apos;__ob__&apos;, this);</span><br><span class="line">  if (Array.isArray(value)) &#123;</span><br><span class="line">    if (hasProto) &#123;</span><br><span class="line">      protoAugment(value, arrayMethods);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      copyAugment(value, arrayMethods, arrayKeys);</span><br><span class="line">    &#125;</span><br><span class="line">    this.observeArray(value);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    this.walk(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">function def (obj, key, val, enumerable) &#123;</span><br><span class="line">  Object.defineProperty(obj, key, &#123;</span><br><span class="line">    value: val,</span><br><span class="line">    enumerable: !!enumerable,</span><br><span class="line">    writable: true,</span><br><span class="line">    configurable: true</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">//遍历所有属性并将它们转换为getter / setter。 </span><br><span class="line">//仅当值类型为Object时才应调用此方法。</span><br><span class="line">Observer.prototype.walk = function walk (obj) &#123;</span><br><span class="line">  var keys = Object.keys(obj);</span><br><span class="line">  for (var i = 0; i &lt; keys.length; i++) &#123;</span><br><span class="line">    defineReactive$$1(obj, keys[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>真正进行劫持的方法defineReactive$$1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">function defineReactive$$1 (</span><br><span class="line">    obj,</span><br><span class="line">    key,</span><br><span class="line">    val,</span><br><span class="line">    customSetter,</span><br><span class="line">    shallow</span><br><span class="line">  ) &#123;</span><br><span class="line">    var dep = new Dep();</span><br><span class="line"></span><br><span class="line">    var property = Object.getOwnPropertyDescriptor(obj, key);</span><br><span class="line">    if (property &amp;&amp; property.configurable === false) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // cater(迎合) for pre-defined getter/setters</span><br><span class="line">    var getter = property &amp;&amp; property.get;</span><br><span class="line">    var setter = property &amp;&amp; property.set;</span><br><span class="line">    if ((!getter || setter) &amp;&amp; arguments.length === 2) &#123;</span><br><span class="line">      val = obj[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var childOb = !shallow &amp;&amp; observe(val);//对值进行劫持处理 开始递归处理</span><br><span class="line">    Object.defineProperty(obj, key, &#123;</span><br><span class="line">      enumerable: true,</span><br><span class="line">      configurable: true,</span><br><span class="line">      get: function reactiveGetter () &#123;</span><br><span class="line">        var value = getter ? getter.call(obj) : val;</span><br><span class="line">        if (Dep.target) &#123; //new watch的时候，Dep.target指向Watcher对象,再运行render函数，访问具体变量就会调用这里</span><br><span class="line">          dep.depend();//对key的依赖进行依赖收集</span><br><span class="line">          if (childOb) &#123;//如果值是一个对象的情况下</span><br><span class="line">            childOb.dep.depend();//对对象值的依赖进行依赖收集 实现深度监听</span><br><span class="line">            if (Array.isArray(value)) &#123;</span><br><span class="line">              dependArray(value);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return value</span><br><span class="line">      &#125;,</span><br><span class="line">      set: function reactiveSetter (newVal) &#123;</span><br><span class="line">        var value = getter ? getter.call(obj) : val;</span><br><span class="line">        //相同值，不更新</span><br><span class="line">        if (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">          return</span><br><span class="line">        &#125;</span><br><span class="line">        //有setter方法直接用setter方法更新，没有直接赋值</span><br><span class="line">        if (getter &amp;&amp; !setter) &#123; return &#125;</span><br><span class="line">        if (setter) &#123;</span><br><span class="line">          setter.call(obj, newVal);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          val = newVal;</span><br><span class="line">        &#125;</span><br><span class="line">        //对新值进行劫持处理 更新childOb</span><br><span class="line">        //如果新值是对象对新赋的值在更新时进行依赖收集</span><br><span class="line">        childOb = !shallow &amp;&amp; observe(newVal); </span><br><span class="line">        dep.notify();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>每个被劫持过的数据的标识<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">var Dep = function Dep () &#123;</span><br><span class="line">  this.id = uid++;</span><br><span class="line">  this.subs = [];</span><br><span class="line">&#125;;</span><br><span class="line">Dep.prototype.addSub = function addSub (sub) &#123;</span><br><span class="line">  this.subs.push(sub);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Dep.prototype.depend = function depend () &#123;</span><br><span class="line">  if (Dep.target) &#123;</span><br><span class="line">    Dep.target.addDep(this); //调用Watcher.addDep方法，this指dep</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Dep.prototype.notify = function notify () &#123;</span><br><span class="line">  // stabilize the subscriber list first</span><br><span class="line">  var subs = this.subs.slice();</span><br><span class="line">  if (!config.async) &#123;</span><br><span class="line">    // subs aren&apos;t sorted in scheduler if not running async</span><br><span class="line">    // we need to sort them now to make sure they fire in correct</span><br><span class="line">    // order</span><br><span class="line">    subs.sort(function (a, b) &#123; return a.id - b.id; &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  for (var i = 0, l = subs.length; i &lt; l; i++) &#123;</span><br><span class="line">    subs[i].update(); //执行watcher的update函数</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Dep.target = null;</span><br><span class="line">var targetStack = [];</span><br></pre></td></tr></table></figure></p>
<h1 id="订阅发布"><a href="#订阅发布" class="headerlink" title="订阅发布"></a>订阅发布</h1><p>mountComponent函数会new Watcher一个对象,执行get方法【详见源码分析二】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">var _Set;</span><br><span class="line">/* istanbul ignore if */ // $flow-disable-line</span><br><span class="line">if (typeof Set !== &apos;undefined&apos; &amp;&amp; isNative(Set)) &#123;</span><br><span class="line">  // use native Set when available.</span><br><span class="line">  _Set = Set;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  // a non-standard Set polyfill that only works with primitive keys.</span><br><span class="line">  _Set = /*@__PURE__*/(function () &#123;</span><br><span class="line">    function Set () &#123;</span><br><span class="line">      this.set = Object.create(null);</span><br><span class="line">    &#125;</span><br><span class="line">    Set.prototype.has = function has (key) &#123;</span><br><span class="line">      return this.set[key] === true</span><br><span class="line">    &#125;;</span><br><span class="line">    Set.prototype.add = function add (key) &#123;</span><br><span class="line">      this.set[key] = true;</span><br><span class="line">    &#125;;</span><br><span class="line">    Set.prototype.clear = function clear () &#123;</span><br><span class="line">      this.set = Object.create(null);</span><br><span class="line">    &#125;;</span><br><span class="line">    return Set;</span><br><span class="line">  &#125;());</span><br><span class="line">&#125;</span><br><span class="line">var Watcher = function Watcher (...args)&#123;</span><br><span class="line">  this.deps = [];</span><br><span class="line">  this.newDeps = [];</span><br><span class="line">  this.depIds = new _Set();</span><br><span class="line">  this.newDepIds = new _Set();</span><br><span class="line">&#125;</span><br><span class="line">Watcher.prototype.get = function get () &#123;</span><br><span class="line">    pushTarget(this); //将当前Watcher挂到第三方Dep.target上</span><br><span class="line">    var value;</span><br><span class="line">    var vm = this.vm;</span><br><span class="line">    try &#123;</span><br><span class="line">      //this.getter会执行render,触发数据的get方法，进行相互订阅</span><br><span class="line">      value = this.getter.call(vm, vm); </span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      // &quot;touch&quot; every property so they are all tracked as</span><br><span class="line">      // dependencies for deep watching</span><br><span class="line">      if (this.deep) &#123;</span><br><span class="line">        traverse(value);</span><br><span class="line">      &#125;</span><br><span class="line">      popTarget();</span><br><span class="line">      this.cleanupDeps();</span><br><span class="line">    &#125;</span><br><span class="line">    return value</span><br><span class="line">  &#125;;</span><br><span class="line">function pushTarget (target) &#123;</span><br><span class="line">  targetStack.push(target);</span><br><span class="line">  Dep.target = target;</span><br><span class="line">&#125;</span><br><span class="line">//watcher和dep互相存id</span><br><span class="line">Watcher.prototype.addDep = function addDep (dep) &#123; </span><br><span class="line">  var id = dep.id;</span><br><span class="line">  if (!this.newDepIds.has(id)) &#123;</span><br><span class="line">    this.newDepIds.add(id);</span><br><span class="line">    this.newDeps.push(dep);</span><br><span class="line">    if (!this.depIds.has(id)) &#123;</span><br><span class="line">      dep.addSub(this); //将watcher加入到dep的sub属性中</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Watcher.prototype.update = function update () &#123;</span><br><span class="line">  /* istanbul ignore else */</span><br><span class="line">  if (this.lazy) &#123;</span><br><span class="line">    this.dirty = true;</span><br><span class="line">  &#125; else if (this.sync) &#123;</span><br><span class="line">    this.run();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    queueWatcher(this);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Watcher.prototype.run = function run () &#123;</span><br><span class="line">  if (this.active) &#123;</span><br><span class="line">    var value = this.get(); //重新调用render函数更新数据</span><br><span class="line">    if (</span><br><span class="line">      value !== this.value ||</span><br><span class="line">      //对于需要深度监听的数据类型，值没有变，也许值内容发生了变化 </span><br><span class="line">      isObject(value) ||</span><br><span class="line">      this.deep</span><br><span class="line">    ) &#123;</span><br><span class="line">      var oldValue = this.value;</span><br><span class="line">      this.value = value;</span><br><span class="line">      if (this.user) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          this.cb.call(this.vm, value, oldValue);</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">          handleError(e, this.vm, (&quot;callback for watcher \&quot;&quot; + (this.expression) + &quot;\&quot;&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this.cb.call(this.vm, value, oldValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://github.com/YooHannah/algorithm/blob/master/html/vuesrc/dataResponse.js" target="_blank" rel="noopener">vue3.0数据响应式原理</a></p>
<h1 id="vue3-0的改进"><a href="#vue3-0的改进" class="headerlink" title="vue3.0的改进"></a>vue3.0的改进</h1><p>1.对源码进行优化<br>使用monorepo和TS管理和开发源码，提升自身代码的可维护性<br>2.性能优化<br>减少源码体积<br>移除冷门的feature(如filter,inline-template)<br>引入tree-shaking,减小打包体积</p>
<p>数据劫持优化<br>原来缺点<br>无法判断对象属性删除新增<br>深度层次结点要递归遍历，也不知道会不会用到，都要劫持，不友好</p>
<p>解决<br>使用proxy API 可以检测到删除还是新增<br>在用到时才劫持，避免无脑递归</p>
<p>3.编译优化<br>判断更新的颗粒度变小，从原来的组件级，利用block tree的区块细化到动态节点级<br>引入 compositionAPI 优化逻辑关注点相关的代码，可以避免mixin的时候的命名冲突</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/sso.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/sso.html" itemprop="url">
                  sso单点登录实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-25T23:27:15+08:00">
                2020-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>多项目想要实现统一登录，即登录一个系统后，在打开其他相关系统页面后，是已经登录的状态，不再进行登录</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>多个系统使用统一的顶级域名，利用cookie的domain属性，将登录后cookie保存在浏览器中，只要是该cookie的domain所包含的域名的站点，都可以拿到这个cookie</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>选择原来多个站点中其中一个站点的登录页，作为公共跳转页<br>在登录之后将token塞到浏览器中<br>这里设置统一token在cookie中的key值为_a<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">根据运行环境设置domain,sit,dev均为测试环境</span><br><span class="line">function getDomain(name)&#123;</span><br><span class="line">  let testENVs = [&apos;localhost&apos;,&apos;sit&apos;,&apos;dev&apos;]</span><br><span class="line">  let testENV = &apos;&apos;</span><br><span class="line">  testENVs.forEach(env=&gt;&#123;</span><br><span class="line">    if(location.hostname.includes(env))&#123; //根据域名判断环境</span><br><span class="line">      testENV = env</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  let temp = testENV?testENV +&apos;.xxxx.com&apos;:&apos;xxxx.com&apos;</span><br><span class="line">  //本地开发不加domain,默认localhost,否则本地没办法进行开发</span><br><span class="line">  let domain = testENV === &apos;localhost&apos; ? &apos;&apos;: (name === &apos;_a&apos;? temp:location.hostname)//个别cookie字段仅用于本站点，所以domain设置为站点域名</span><br><span class="line">  return domain</span><br><span class="line">&#125;</span><br><span class="line">setCookie=(name,value) =&gt; &#123;</span><br><span class="line">    const Days = 0.5</span><br><span class="line">    const exp = new Date()</span><br><span class="line">    exp.setTime(exp.getTime() + Days*24*60*60*1000)</span><br><span class="line">    let str =  name + &apos;=&apos; + escape(value) + &apos;;expires=&apos; + exp.toGMTString()</span><br><span class="line">    let domain = getDomain(name)</span><br><span class="line">    if(domain)&#123;</span><br><span class="line">      str +=&apos;;domain=&apos; + domain</span><br><span class="line">    &#125;</span><br><span class="line">    document.cookie = str</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure></p>
<p>之所以要根据不同运行环境设置不同domain,是因为要在不同测试环境也要实现单点登录<br>比如测试环境在sit环境的a.sit.xxxx.com和b.sit.xxxx.com<br>a.sit.xxxx.com登录页作为公共登录页<br>在a.sit.xxxx.com登录后，token的cookie会被设置成<br>key是_a,domain是sit.xxxx.com(浏览器会自动在前面加一个点)，这样打开b.sit.xxxx.com的页面，浏览器中还会存在_a这个cookie,b.sit.xxxx.com就可以直接拿这个cookie向服务器发请求了</p>
<p>以此类推，在dev环境，这两个站点域名会变成<br>a.dev.xxxx.com和b.dev.xxxx.com<br>_a的domain会被设置成dev.xxxx.com<br>这时如果去b.dev.xxxx.com,_a是会有的<br>但去a.sit.xxxx.com,是不会有的，因为_a此时仅限于dev.xxxx.com域名及其子域名</p>
<p>等到了生产环境，二者域名变为<br>a.xxxx.com和b.xxxx.com<br>_a的domain会被设置成xxxx.com<br>此时就会出现一个问题，假如我先登录了线上环境<br>有了domain为xxxx.com的_a<br>再去测试环境登录，此时会加进去domain为sit/dev.xxx.com的_a<br>两个_a如何区分哪个才是当前环境的_a？</p>
<p>遇到的问题一 ：测试环境_a加不进去，出现一闪而过<br>开始以为是浏览器机制问题，后来才发现，是代码逻辑问题<br>其实cookie是有写进浏览器的，跟cookie本身处理机制无关，可以写进去，问题出在了取cookie _a再给后台发请求的时候，以前是保存token的只有一个特殊key名，直接取那个key名就行，现在有两个_a，逻辑还是按照第一个来取，结果取错了，后台给发过来401，前端代码处理http状态码的逻辑又是401清cookie跳登录，所以domain为. sit/dev. xxxx. com的cookie就又消失了😅</p>
<p>遇到问题二 ：两个_a如何区分哪个才是当前环境的_a？<br>因为后台实现分层，与前端直接对接的后台，无法访问后台的用户cookie表，能拿到cookie表的后台站在大局角度看问题，这个逻辑又觉得不是有必要加的，所以不能要求后台拿到报文中cookie后去表里面做判断<br>所以由前端通过读取document.cookie,整理拿到两个_a后，依次用每个_a去给后台发请求，如果成功了，说明当前_a是正确的，就可以用这个_a去发真正的请求，同时记录下这个_a,避免之后的重复探测</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>1.碰到问题一时，很无厘头，但分析出原因后，让人感觉很无语，正确的说是，让人很没面子，遇到问题应该善于分析，戒骄戒躁<br>2.问题二，有时候，你认为很恶心的做法，恰巧可能会被采纳</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>发版到线上后，发现部分同事登陆成功后又跳回登录页面，中间发起的请求报401</p>
<p>经过查看同事浏览器的cookie发现,存在设置了httponly的_a，即我们所有系统统一使用的token标识，<br>cookie设置了httponly意味着js没有权限进行获取更改甚至不能删除，所以新登录的token是没有写进去的，拿到的token也就是错的<br>解决办法就是让后台同事强制写一个没有httponly的_a进去，让后台覆盖后台，<br>说明浏览器优先级是先处理set-cookie的cookie逻辑，再看是否有httponly,决定js是否有权限处理cookie</p>
<p>相关链接<br><a href="https://www.cnblogs.com/zdz8207/p/vue-cookie-https-secure.html" target="_blank" rel="noopener">Cookie写不进去问题深入调查 https Secure Cookie</a><br><a href="https://blog.csdn.net/Paranoid99/article/details/101015172" target="_blank" rel="noopener">js创建cookie时获取一级域名设置domain解决跨域问题</a><br><a href="https://www.cnblogs.com/gg1234/p/5611086.html" target="_blank" rel="noopener">js与cookie的domain和path之间的关系</a><br><a href="https://www.cnblogs.com/Easty/p/7338940.html" target="_blank" rel="noopener">前端单点登录（SSO）实现方法（二级域名与主域名）</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuepress.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuepress.html" itemprop="url">
                  使用vuepress构建文档系统
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T13:18:15+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>面向普通用户的应用系统，包含很多产品的使用说明，属于静态页面<br>一方面占据整体项目的体积，打包时间用时长，打包结果体积大<br>另一方面，不断新增的不同产品的使用说明，对于前端开发人员来说，<br>相对开发真正的产品功能来说优先级较低，且占用开发时间</p>
<p>所以希望将产品使用说明与当前项目隔离，建立静态网站，存放使用说明<br>再由原系统进行跳转<br>将新增使用说明的任务交由相关产品负责人等非开发人员进行新增</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>1.对于非开发人员来说，选择何种文档格式，可以既方便编写，又可以轻松转成html<br>2.原有系统用vue编写的批量文件如何迁移到新的静态网站</p>
<h1 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h1><h2 id="vuepress"><a href="#vuepress" class="headerlink" title="vuepress"></a>vuepress</h2><p>vuepress是一款使用vue驱动的静态网站生成器<br>用户可以使用markdown格式文件编辑文本，然后转义成html<br>另外页面中功能还可以使用vue进行嵌入</p>
<h2 id="批量迁移"><a href="#批量迁移" class="headerlink" title="批量迁移"></a>批量迁移</h2><p>原系统vue编写的批量页面含有vue语法，不能直接迁移<br>所以需要将生成好的html爬下来转成md文件，应用到新系统<br>‘html-to-md’的npm 包可以帮助将html转换成md</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h2 id="vuepress搭建"><a href="#vuepress搭建" class="headerlink" title="vuepress搭建"></a>vuepress搭建</h2><p>因为要与原系统主题风格样式类似，故需要在原来主题代码上进行修改<br>安装好vuepress包之后<br>将包里面的默认主题@vuepress/theme-default复制粘贴到doc/.vuepress/theme文件夹下面<br>修改里面的代码就可以直接应用了</p>
<h3 id="配置config-js文件"><a href="#配置config-js文件" class="headerlink" title="配置config.js文件"></a>配置config.js文件</h3><p>在.vuepress文件夹下新增config.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">title:标签页名称</span><br><span class="line">head:在页面头部引入的文件</span><br><span class="line">base:当不在域名根目录下部署时，配置部署路径</span><br><span class="line">themeConfig:&#123; 主题配置</span><br><span class="line">  logo：标题栏左上角logo</span><br><span class="line">  nav:右上角搜索后面的按钮</span><br><span class="line">  sidebar:左侧侧边栏</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="enhanceApp-js"><a href="#enhanceApp-js" class="headerlink" title="enhanceApp.js"></a>enhanceApp.js</h3><p>在.vuepress文件夹下新增enhanceApp.js<br>该文件，可以添加对项目的额外处理<br>比如当前项目右上角三个按钮根据权限显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">export default (&#123;</span><br><span class="line">  Vue, // VUE构造函数对象</span><br><span class="line">  options, // vue实例选项</span><br><span class="line">  router, // 路由对象</span><br><span class="line">  siteData//配置的数据</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">  async function getAuthorization()&#123;</span><br><span class="line">    if(location.hostname.includes(&apos;localhost&apos;))&#123;</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line">    let cookie_str = document.cookie</span><br><span class="line">    let cookie_parts = cookie_str.split(&apos;;&apos;)</span><br><span class="line">    let auths = []</span><br><span class="line">    cookie_parts.forEach(c=&gt;&#123;</span><br><span class="line">      if (c)&#123;</span><br><span class="line">        let kv = c.split(&apos;=&apos;)</span><br><span class="line">        let k = kv[0].trim()</span><br><span class="line">        let v = kv[1].trim()</span><br><span class="line">        if (k == &apos;_a&apos;)&#123;</span><br><span class="line">          auths.push(v)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    if(auths.length&lt;1)&#123;</span><br><span class="line">      return false</span><br><span class="line">    &#125;</span><br><span class="line">    for (var c of auths)&#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        let response = await axios.get(location.origin + &apos;/api/v1/edit-user&apos;, &#123;headers: &#123;&apos;X-Auth-Token&apos;: c&#125;&#125;)</span><br><span class="line">        if(response.status &lt; 400)&#123;</span><br><span class="line">          return true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (err) &#123;</span><br><span class="line">        console.log(err)</span><br><span class="line">        return false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  getAuthorization().then(flag=&gt;&#123;</span><br><span class="line">    let divs = document.getElementsByClassName(&apos;nav-item&apos;)</span><br><span class="line">    if(flag)&#123;</span><br><span class="line">      divs[1].style.display = &apos;none&apos;</span><br><span class="line">      divs[2].style.display = &apos;none&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="更改页面呈现样式"><a href="#更改页面呈现样式" class="headerlink" title="更改页面呈现样式"></a>更改页面呈现样式</h3><p>增加悬浮锚点定位<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">page.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;main class=&quot;page&quot;&gt;</span><br><span class="line">    &lt;div v-show=&quot;$page.headers &amp;&amp; isShowAncher &amp;&amp; $page.frontmatter.ancherShow&quot; class=&apos;ancherSection&apos;&gt;</span><br><span class="line">      &lt;template v-for=&quot;(item,i) in headers&quot;&gt;</span><br><span class="line">        &lt;div :key=&quot;i&quot;&gt;</span><br><span class="line">          &lt;a  @click=&quot;gotoAncher(item.slug)&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;slot name=&quot;top&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Content class=&quot;theme-default-content&quot; /&gt;</span><br><span class="line">    &lt;PageEdit /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;PageNav v-bind=&quot;&#123; sidebarItems &#125;&quot; /&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;slot name=&quot;bottom&quot; /&gt;</span><br><span class="line">  &lt;/main&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123; PageEdit, PageNav&#125;,</span><br><span class="line">  props: [&apos;sidebarItems&apos;],</span><br><span class="line">  data () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      isShowAncher: false, //滚动过程控制悬浮锚点</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed:&#123;</span><br><span class="line">    headers:function()&#123;//计算锚点内容</span><br><span class="line">      let ancherLevel = this.$page.frontmatter.ancherLevel </span><br><span class="line">      let sidebarDepth = this.$page.frontmatter.sidebarDepth?this.$page.frontmatter.sidebarDepth:this.$themeConfig.sidebarDepth</span><br><span class="line">      let levelStr = ancherLevel?ancherLevel:(sidebarDepth&gt;1?&apos;h2,h3&apos;:&apos;h2&apos;)</span><br><span class="line">      if(ancherLevel &amp;&amp; !(/^(h2|h3|h2\,\s*\h3)$/ig.test(ancherLevel.trim())))&#123;</span><br><span class="line">        return []</span><br><span class="line">      &#125;</span><br><span class="line">      if(levelStr.includes(&apos;,&apos;))&#123;</span><br><span class="line">        return this.$page.headers &amp;&amp; groupHeaders(this.$page.headers).length&gt;0?this.$page.headers:[]</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">        let level = +levelStr[1]</span><br><span class="line">        return this.$page.headers.filter(h =&gt; h.level === level)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  updated()&#123;</span><br><span class="line">    this.setPictureZoom()</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    let  handleScroll= ()=&gt;&#123;</span><br><span class="line">      let scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop // 滚动条偏移量</span><br><span class="line">      this.isShowAncher = !!scrollTop</span><br><span class="line">    &#125;</span><br><span class="line">    window.addEventListener(&apos;scroll&apos;,handleScroll,false)</span><br><span class="line">    this.setPictureZoom()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    //锚点定位</span><br><span class="line">    gotoAncher(ancher)&#123;</span><br><span class="line">      let el = document.getElementById(ancher)</span><br><span class="line">      let anchersHeight = document.getElementsByClassName(&apos;ancherSection&apos;)[0].clientHeight</span><br><span class="line">      window.scrollTo(&#123; </span><br><span class="line">          top: el.offsetTop-anchersHeight, </span><br><span class="line">          behavior: &quot;smooth&quot; </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    //添加图片放大功能</span><br><span class="line">    setPictureZoom () &#123;</span><br><span class="line">      let img = document.querySelectorAll(&apos;p &gt; img&apos;)</span><br><span class="line">        for (let i = 0; i &lt; img.length; i++) &#123;</span><br><span class="line">            if (img[i]) &#123;</span><br><span class="line">                let a = document.createElement(&quot;a&quot;);</span><br><span class="line">                let parent = img[i].parentNode</span><br><span class="line">                parent.appendChild(a)</span><br><span class="line">                let src = img[i].getAttribute(&apos;src&apos;)</span><br><span class="line">                a.setAttribute(&apos;data-fancybox&apos;, &apos;&apos;)</span><br><span class="line">                a.setAttribute(&apos;href&apos;, src)</span><br><span class="line">                a.appendChild(img[i])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;stylus&quot;&gt;</span><br><span class="line">@require &apos;../styles/wrapper.styl&apos;</span><br><span class="line">.page</span><br><span class="line">  padding-bottom 2rem</span><br><span class="line">  display block</span><br><span class="line">.ancherSection</span><br><span class="line">  position: fixed</span><br><span class="line">  background-color: white</span><br><span class="line">  box-shadow: rgb(234, 229, 229) 0px 1px 2px;</span><br><span class="line">  top: 64px</span><br><span class="line">  min-height: 42px</span><br><span class="line">  width: calc(100% - 320px);</span><br><span class="line">  display flex</span><br><span class="line">  align-items center</span><br><span class="line">  justify-content left</span><br><span class="line">  flex-wrap: wrap;</span><br><span class="line">  padding: 10px 0px 0px;</span><br><span class="line">  z-index:2</span><br><span class="line">  div</span><br><span class="line">    margin-left 20px</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    a</span><br><span class="line">      color black</span><br><span class="line">      cursor pointer</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="更换图标"><a href="#更换图标" class="headerlink" title="更换图标"></a>更换图标</h3><p>在sidebarGroup.vue文件同级别新增arrow.svg图片，使用相对路径可插入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&apos;./arrow.svg&apos; v-if=&quot;collapsable&quot; :class=&quot;open ? &apos;down&apos; : &apos;&apos;&quot; style=&apos;width:20px&apos; /&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="批量迁移-1"><a href="#批量迁移-1" class="headerlink" title="批量迁移"></a>批量迁移</h2><h3 id="目录改造"><a href="#目录改造" class="headerlink" title="目录改造"></a>目录改造</h3><p>原有系统页面图片按照产品名命名文件夹，故先将整体文件结构进行改造<br>原来目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--content</span><br><span class="line">  --a</span><br><span class="line">    --a1.png</span><br><span class="line">    --a2.png</span><br><span class="line">    ......省略若干</span><br><span class="line">    --a13.png</span><br><span class="line">  --b</span><br><span class="line">    --b1.png</span><br><span class="line">    --b2.png</span><br><span class="line">    ......省略若干</span><br><span class="line">    --b13.png</span><br></pre></td></tr></table></figure></p>
<p>改造成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--content</span><br><span class="line">  --a</span><br><span class="line">    --images</span><br><span class="line">        --a1.png</span><br><span class="line">        --a2.png</span><br><span class="line">        ......省略若干</span><br><span class="line">        --a13.png</span><br><span class="line">  --b</span><br><span class="line">    --images</span><br><span class="line">      --b1.png</span><br><span class="line">      --b2.png</span><br><span class="line">      ......省略若干</span><br><span class="line">      --b13.png</span><br></pre></td></tr></table></figure></p>
<p>就是在当前父文件夹下新增images文件夹，然后把图片移进去<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);//引用文件系统模块</span><br><span class="line">function readFileList(path, filesList) &#123;</span><br><span class="line">  var files = fs.readdirSync(path);</span><br><span class="line">  files.forEach(function (itm) &#123;</span><br><span class="line">    var obj = &#123;&#125;;//定义一个对象存放文件的路径和名字</span><br><span class="line">    obj.path = path;//路径</span><br><span class="line">    obj.filename = itm//名字</span><br><span class="line">    filesList.push(obj);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">var getFiles = &#123;</span><br><span class="line">  //获取文件夹下的所有文件</span><br><span class="line">  getFileList: function (path) &#123;</span><br><span class="line">      var filesList = [];</span><br><span class="line">      readFileList(path, filesList);</span><br><span class="line">      return filesList;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">let files = getFiles.getFileList(&quot;./content/&quot;)  //拿到a,b这一级别文件</span><br><span class="line">for(let i=0;i&lt;files.length;i++)&#123;</span><br><span class="line">  let filepath = files[i].path+files[i].filename+&apos;/&apos; //拼接a,b路径</span><br><span class="line">  let images = getFiles.getFileList(filepath)  //拿到a,b下一级的文件，即所有图片</span><br><span class="line">  let imgpath = filepath+&apos;images&apos;</span><br><span class="line">  fs.mkdirSync(imgpath);//新建文件夹</span><br><span class="line">  for(let j = 0;j&lt;images.length;j++)&#123; //将图片移到新文件夹中</span><br><span class="line">    let oldpath = images[j].path+images[j].filename</span><br><span class="line">    let newpath = imgpath+&apos;/&apos;+images[j].filename</span><br><span class="line">    fs.rename(oldpath,newpath,function(err)&#123;</span><br><span class="line">      console.log(err)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="转义文件"><a href="#转义文件" class="headerlink" title="转义文件"></a>转义文件</h3><p>因为原项目为单页面文件，无法进行爬虫批量获取<br>最终实现也还是手动copy页面中dom,一个页面一个页面的copy<br>然后处理</p>
<p>安装转义包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install html-to-md</span><br></pre></td></tr></table></figure></p>
<p>开始使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const html2md=require(&apos;html-to-md&apos;)</span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">//在页面中找到使用说明的dom,copy之后存放到temp.txt中</span><br><span class="line">//当做字符串被读取</span><br><span class="line">var contentText = fs.readFileSync(&apos;temp.txt&apos;,&apos;utf-8&apos;);</span><br><span class="line">let res = html2md(contentText)</span><br><span class="line">//匹配md的‘[]()’书写形式</span><br><span class="line">let reg1=/\[([\S ]*?)]\s?()\( *&lt;?([^\s&apos;&quot;]*?(?:\([\S]*?\)[\S]*?)?)&gt;?\s*(?:()([&apos;&quot;])(.*?)\5)? *\)/g</span><br><span class="line">//匹配md的‘![]()’书写形式</span><br><span class="line">let reg2 = /!\[([^\]]*?)][ \t]*()\([ \t]?&lt;?([\S]+?(?:\([\S]*?\)[\S]*?)?)&gt;?(?: =([*\d]+[A-Za-z%]&#123;0,4&#125;)x([*\d]+[A-Za-z%]&#123;0,4&#125;))?[ \t]*(?:([&quot;&apos;])([^&quot;]*?)\6)?[ \t]?\)/g</span><br><span class="line">//在每篇开头注入转义规则front matter</span><br><span class="line">res = &apos;---\nsidebarDepth: 2 \nancherShow: true \nancherLevel: h3 \n--- \n&apos; + res.replace(reg1,function(group,text)&#123; //html-to-md包转义结果将标题转移成没有连接但有连接名的书写形式[xxx](),所以这里将其替换成 md写法</span><br><span class="line">  return text?&apos;## &apos;+text:group</span><br><span class="line">&#125;).replace(reg2,function(...res)&#123; //将图片引用路径做统一处理</span><br><span class="line">  let arr =  res[3].slice(res[3].lastIndexOf(&apos;/&apos;)+1).split(&apos;.&apos;)</span><br><span class="line">  return &apos;![](./images/&apos;+arr[0]+&apos;.&apos;+arr[2]+&apos;)&apos;</span><br><span class="line">&#125;)</span><br><span class="line">//将处理后的文件写入相应的文件夹中的manual.md文件中，即生成md文件</span><br><span class="line">fs.writeFile(&quot;./content/xxxx/manual.md&quot;, res, function(err) &#123; </span><br><span class="line">  if(err) &#123;</span><br><span class="line">      return console.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(&quot;The file was saved!&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>所以最终文件夹目录为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--content</span><br><span class="line">  --a</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br><span class="line">  --b</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br></pre></td></tr></table></figure></p>
<p>现在将content目录下文件全都粘贴到docs文件夹下面，与.vuepres平级<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--docs</span><br><span class="line">  --.vuepress</span><br><span class="line">  --a</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br><span class="line">  --b</span><br><span class="line">    --images</span><br><span class="line">    --manual.md</span><br></pre></td></tr></table></figure></p>
<p>就可以在.vuepress文件夹下面的config.js中配置sidebar了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> sidebar: [</span><br><span class="line">      &#123;</span><br><span class="line">        title: &apos;产品a&apos;,</span><br><span class="line">        collapsable: true,</span><br><span class="line">        children:[</span><br><span class="line">            [&apos;/a/manual.md&apos;, &apos;a操作手册&apos;],</span><br><span class="line">          ]</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>1.如何将公共开源的项目更契合的应用到公司级项目，对原项目的破坏是避免不了的，比如替换主题颜色，替换相关图标，以及为了新增一些原来项目中没有的功能，而去更改原有处理逻辑，所谓二次开发，实质上，可能应该叫破坏性开发，不遵循原来的使用规则，在原来基础上，造自己的规则</p>
<p>2.对于大批量重复性工作的处理，要学会使用工具，<br>比如局部大量替换，借助vscode的局部锁定（先选取范围再点击下图1，锁定按钮）<br>再比如规则类似的替换，又要善于利用vscode的正则匹配去替换，如下图2<br><img src="/image/vscode.png" alt="vscode"><br>如果属于大规模处理，还要学会自己造工具<br>比如上述批量处理目录结构，改造md文件<br>人之所以为人，学会使用工具才能算是进入了文明社会</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/editionproblem.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/editionproblem.html" itemprop="url">
                  一个发版问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-19T16:17:37+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>用户正在使用某个页面期间，后台发布新的版本，用户再切换其他页面，<br>浏览器会报一个资源找不到的error,导致页面崩溃</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>最终发布的版本会经过打包处理，每次打包的产物，文件名会不同<br>新发布的版本是最新打包的结果，上个版本发布的是上次发版前的结果<br>后台发布到服务器的项目新版本不再包含上个版本发布的文件<br>即服务器仅有新版本的文件<br>如果触发切换页面，此时浏览器向服务器发起请求上个版本的文件<br>服务器仅有最新版本文件，不再包含上个版本文件<br>故返回404，浏览器崩溃</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>使用vue框架编写项目，使用vue-router进行路由切换</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h2 id="利用路由"><a href="#利用路由" class="headerlink" title="利用路由"></a>利用路由</h2><p>在路由生命钩子函数中添加onerror的处理，<br>让当前页面重新load一下，把资源拉回来，再让用户自己去点击要切换的页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.onError((error) =&gt; &#123;</span><br><span class="line">  const pattern = /Loading chunk (\d)+ failed/g</span><br><span class="line">  const isChunkLoadFailed = error.message.match(pattern)</span><br><span class="line">  if (isChunkLoadFailed) &#123;</span><br><span class="line">    $Message(&apos;系统更新，页面将进行刷新操作！&apos;)</span><br><span class="line">    window.location.reload()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h2><p>使用webpack打包的时候生成一个hash.json的文件，然后前端轮询，<br>发现hash改变，就弹窗提示用户进行更新</p>
<h2 id="借助CDN缓存策略"><a href="#借助CDN缓存策略" class="headerlink" title="借助CDN缓存策略"></a>借助CDN缓存策略</h2><p>发版代码放到cdn上，用户未进行任何刷新操作则仍使用老代码，<br>用户进行了手动刷新，则拿到最新版本，进入新页面</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vueroutersrc.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vueroutersrc.html" itemprop="url">
                  vueRouter 源码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-19T10:48:15+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id = &apos;app&apos; class=&apos;hello&apos;&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">      &lt;router-link to=&quot;/foo&quot;&gt;Go to Foo&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link to=&quot;/bar/user&quot;&gt;Go to Bar&lt;/router-link&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;vue-router.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    const Foo = &#123; template: &apos;&lt;div&gt;foo&lt;/div&gt;&apos;,mounted()&#123;&#125;&#125;//路由foo组件</span><br><span class="line">    const Bar = &#123; </span><br><span class="line">      template: &apos;&lt;div&gt;bar&lt;div&gt;&#123;&#123;id&#125;&#125;&lt;/div&gt;&lt;a @click=&quot;aa&quot;&gt;go to foo&lt;/a&gt;&lt;/div&gt;&apos;,//路由bar组件</span><br><span class="line">      data()&#123;</span><br><span class="line">        return &#123;</span><br><span class="line">          id:&apos;&apos;,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      methods:&#123;</span><br><span class="line">        aa()&#123;</span><br><span class="line">          console.log(this.$router)</span><br><span class="line">          this.$router.push(&#123;name:&apos;foo&apos;,params:&#123;name:&apos;jck&apos;&#125;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      mounted()&#123;</span><br><span class="line">        console.log(this.$route,this.$router)</span><br><span class="line">        this.id = this.$route.params.id</span><br><span class="line">      &#125; </span><br><span class="line">      &#125;</span><br><span class="line">    const routes = [</span><br><span class="line">        &#123; path: &apos;/foo/:name&apos;,name:&apos;foo&apos;, component: Foo &#125;,</span><br><span class="line">        &#123; path: &apos;/bar/:id?&apos;,name:&apos;bar&apos;, component: Bar &#125;</span><br><span class="line">      ]</span><br><span class="line">    const router = new VueRouter(&#123;routes&#125;)</span><br><span class="line">    let app = new Vue(&#123;</span><br><span class="line">      el:&apos;#app&apos;,</span><br><span class="line">      data:&#123;&#125;,</span><br><span class="line">      method:&#123;&#125;,</span><br><span class="line">      router,</span><br><span class="line">    &#125;)</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<h1 id="执行vue-Router-js文件"><a href="#执行vue-Router-js文件" class="headerlink" title="执行vue-Router.js文件"></a>执行vue-Router.js文件</h1><p>引入vue-router之前会先引入vue.js文件，执行会生成vue构造函数,<br>因为vue-router的执行过程会用到vue构造函数这个对象上的方法<br>当代码引入vue-router.js时，里面相应的代码会执行一遍，<br>此时vue构造函数已经生成<br>所以vue-router.js运行后，<br>不仅会生成vue-router的构造对象<br>还会调用vue构造函数上的use方法将与router相关的信息挂到vue构造函数对象上<br>即做一些注册挂载的初始化工作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">(function (global, factory) &#123;</span><br><span class="line">  global.VueRouter = factory());</span><br><span class="line">&#125;(this, function () &#123; &apos;use strict&apos;;</span><br><span class="line">  //vue-router的构造对象</span><br><span class="line">  var VueRouter = function VueRouter (options) &#123; </span><br><span class="line">    if ( options === void 0 ) options = &#123;&#125;;</span><br><span class="line">    //options即new vueRouter时传进来的参数对象，这里只有一个属性即路由配置对象routes</span><br><span class="line">    this.app = null;</span><br><span class="line">    this.apps = [];</span><br><span class="line">    this.options = options;</span><br><span class="line">    this.beforeHooks = [];</span><br><span class="line">    this.resolveHooks = [];</span><br><span class="line">    this.afterHooks = [];</span><br><span class="line">    //该函数会根据路由配合生成路由表，返回两个函数，一个match函数用来匹配路由，另一个addRoutes用来动态增加路由，详见下文具体分析</span><br><span class="line">    this.matcher = createMatcher(options.routes || [], this);</span><br><span class="line">    var mode = options.mode || &apos;hash&apos;;//路由对象模式，没有配置的话默认初始化为&apos;hash&apos;</span><br><span class="line">    //fallback参数用于配置当浏览器不支持 history.pushState 控制路由是否应该回退到 hash 模式</span><br><span class="line">    //默认值为 true 官文：https://router.vuejs.org/zh/api/#fallback</span><br><span class="line">    this.fallback = mode === &apos;history&apos; &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false;</span><br><span class="line">    if (this.fallback) &#123; //history模式下在不支持pushstate方法且配置允许回退hash的情况下回退hash模式</span><br><span class="line">      mode = &apos;hash&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!inBrowser) &#123; //没有在浏览器中，那应该是在nodejs中，模式重置为abstract</span><br><span class="line">      mode = &apos;abstract&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    this.mode = mode;//模式确定</span><br><span class="line"></span><br><span class="line">    switch (mode) &#123; //初始化history对象，三种类型的history构造函数继承自同一父类构造函数History</span><br><span class="line">      case &apos;history&apos;:</span><br><span class="line">        this.history = new HTML5History(this, options.base);</span><br><span class="line">        break</span><br><span class="line">      case &apos;hash&apos;:</span><br><span class="line">        this.history = new HashHistory(this, options.base, this.fallback);</span><br><span class="line">        break</span><br><span class="line">      case &apos;abstract&apos;:</span><br><span class="line">        this.history = new AbstractHistory(this, options.base);</span><br><span class="line">        break</span><br><span class="line">      default:</span><br><span class="line">        &#123;</span><br><span class="line">          assert(false, (&quot;invalid mode: &quot; + mode));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  VueRouter.install = install;</span><br><span class="line">  VueRouter.version = &apos;3.1.5&apos;;</span><br><span class="line"></span><br><span class="line">  function install (Vue) &#123; &#125; //挂到VueRouter上，被vue.use函数调用</span><br><span class="line"></span><br><span class="line">  if (inBrowser &amp;&amp; window.Vue) &#123; //只在浏览器环境自动挂载，说明在node.js中需要自己调用Vue.use手动挂载</span><br><span class="line">    window.Vue.use(VueRouter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return VueRouter;</span><br><span class="line"></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<h2 id="vue-use-与-VueRouter-install"><a href="#vue-use-与-VueRouter-install" class="headerlink" title="vue.use 与 VueRouter.install"></a>vue.use 与 VueRouter.install</h2><p>vue的use方法会调用插件的install方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//在运行initGlobalAPI(Vue)函数时调用initUse挂载到VUE上</span><br><span class="line">Vue.use = function (plugin) &#123;</span><br><span class="line">  var installedPlugins = (this._installedPlugins || (this._installedPlugins = []));//this是指Vue哦</span><br><span class="line">  if (installedPlugins.indexOf(plugin) &gt; -1) &#123; //避免重复挂载</span><br><span class="line">    return this</span><br><span class="line">  &#125;</span><br><span class="line">  //这个方法会从arguments中取出从第一个数以后的所有参数，这里返回空数组===&gt;[]</span><br><span class="line">  var args = toArray(arguments, 1);</span><br><span class="line">  args.unshift(this);//this是vue,将vue传给组件进行初始化 ==&gt;[vue]</span><br><span class="line">  if (typeof plugin.install === &apos;function&apos;) &#123;  //组件定义了plugin.install方法，执行组件plugin.install方法</span><br><span class="line">    plugin.install.apply(plugin, args);</span><br><span class="line">  &#125; else if (typeof plugin === &apos;function&apos;) &#123; //没定义定义plugin.install方法且组件本身是函数，则调用自身</span><br><span class="line">    plugin.apply(null, args);</span><br><span class="line">  &#125;</span><br><span class="line">  installedPlugins.push(plugin);//将插件推入vue对象上的installedPlugins集合中</span><br><span class="line">  return this</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>VueRouter.install方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">function install (Vue) &#123; //挂到VueRouter上，被vue.use函数调用</span><br><span class="line">    if (install.installed &amp;&amp; _Vue === Vue) &#123; return &#125;//避免重复挂载</span><br><span class="line">    install.installed = true;</span><br><span class="line"></span><br><span class="line">    _Vue = Vue;</span><br><span class="line"></span><br><span class="line">    var isDef = function (v) &#123; return v !== undefined; &#125;;</span><br><span class="line"></span><br><span class="line">    var registerInstance = function (vm, callVal) &#123;</span><br><span class="line">      var i = vm.$options._parentVnode;</span><br><span class="line">      if (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) &#123;</span><br><span class="line">        i(vm, callVal);//如果定义了registerRouteInstance就执行</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    //调用vue.mixin方法 将beforeCreate 和 destroyed，两个生命周期函数存到到对应的钩子函数的集合中</span><br><span class="line">    //在执行new vue时会调用callHook执行 beforeCreate相关的钩子函数</span><br><span class="line">    //在vue中执行destroyed钩子函数时，同样也会调用这里定义好的生命周期函数</span><br><span class="line">    Vue.mixin(&#123; </span><br><span class="line">      beforeCreate: function beforeCreate () &#123; //这里this指向vue</span><br><span class="line">        if (isDef(this.$options.router)) &#123;</span><br><span class="line">          this._routerRoot = this;</span><br><span class="line">          this._router = this.$options.router;</span><br><span class="line">          //调用vueRouter对象上的init方法,主要功能是初始化当前路由，设置监听 详见下文</span><br><span class="line">          this._router.init(this);</span><br><span class="line">          Vue.util.defineReactive(this, &apos;_route&apos;, this._router.history.current);</span><br><span class="line">          //defineReactive会对数据进行劫持，进行依赖收集，方便之后页面切换进行监听</span><br><span class="line">        &#125; else &#123;//如果没有在new vue时传进vuerouter对象</span><br><span class="line">          this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this;</span><br><span class="line">        &#125;</span><br><span class="line">        registerInstance(this, this);</span><br><span class="line">      &#125;,</span><br><span class="line">      destroyed: function destroyed () &#123;</span><br><span class="line">        registerInstance(this);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //访问this.$router,返回new vueRouter生成的对象</span><br><span class="line">    Object.defineProperty(Vue.prototype, &apos;$router&apos;, &#123; </span><br><span class="line">      get: function get () &#123; return this._routerRoot._router &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //访问this.$route,当前页面路由对象 this._router.history.current</span><br><span class="line">    Object.defineProperty(Vue.prototype, &apos;$route&apos;, &#123;</span><br><span class="line">      get: function get () &#123; return this._routerRoot._route &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //挂载RouterView，RouterLink两个组件</span><br><span class="line">    Vue.component(&apos;RouterView&apos;, View); </span><br><span class="line">    Vue.component(&apos;RouterLink&apos;, Link);</span><br><span class="line">    //使用vue生命钩子函数合并策略定义路由生命周期钩子函数合并策略 其实就是mergeHook函数</span><br><span class="line">    var strats = Vue.config.optionMergeStrategies;</span><br><span class="line">    // use the same hook merging strategy for route hooks</span><br><span class="line">    strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>vueRouter在执行阶段会做以下两件事<br>1.生成vue-router的构造对象<br>2.挂载vuerouter相关信息到vue对象</p>
<p>挂载到vue对象时会做以下几件事<br>1.注入两个生命周期函数：beforeCreate和 destroyed<br>2.指定vue的$router和$route分别指向传进去的vueRouter对象的本身和history.current属性<br>3.挂载RouterView,RouterLink两个组件<br>4.指定路由生命周期函数合并策略使用vue中生命周期函数的合并策略</p>
<p>beforeCreate会在new vue时被调用，主要做以下几件事<br>1.在vue对象上指定与router相关的属性<br>2.调用vuerouter的init方法，初始化当前路由，设置监听<br>3.对当前路由进行数据劫持，进行监听</p>
<p>在new vueRouter时，会做以下几件事<br>1.根据路由配置数组生成路由表，匹配函数以及动态增加路由的函数<br>2.确定路由模式<br>3。根据路由模式创建history属性</p>
<h1 id="一个疑惑"><a href="#一个疑惑" class="headerlink" title="一个疑惑"></a>一个疑惑</h1><p>当跳转的路由带有query或者params时，将其中的值插入到页面中为什么不会引起XSS攻击？<br>因为拿到的值类型都是原始js类型，vue在替换值时只是当做字符串替换，不会进行innerHTML</p>
<h2 id="使用js跳转路由"><a href="#使用js跳转路由" class="headerlink" title="使用js跳转路由"></a>使用js跳转路由</h2><p>比如this.$router.push({name:foo,query:{id:1}})方法跳转路由<br>目的页面拿到的query/params数据，就是调用push函数传入的数据<br>当我们调用push函数时，就是在调用这段代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VueRouter.prototype.push = function push (location, onComplete, onAbort) &#123;</span><br><span class="line">    var this$1 = this;</span><br><span class="line">    if (!onComplete &amp;&amp; !onAbort &amp;&amp; typeof Promise !== &apos;undefined&apos;) &#123;</span><br><span class="line">      return new Promise(function (resolve, reject) &#123;//进行异步跳转</span><br><span class="line">        this$1.history.push(location, resolve, reject);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; else &#123;//进行同步跳转</span><br><span class="line">      this.history.push(location, onComplete, onAbort);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>location就是我们传入的参数，没有传入 onComplete, onAbort，所以会进入if分支<br>可见无论进入哪个分支都会调用history对象的push方法<br>由于在new VueRouter对象时，在构造函数中history是根据传入的选项生成的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">var mode = options.mode || &apos;hash&apos;;</span><br><span class="line">  this.fallback = mode === &apos;history&apos; &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false;</span><br><span class="line">  if (this.fallback) &#123;</span><br><span class="line">    mode = &apos;hash&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">  if (!inBrowser) &#123;</span><br><span class="line">    mode = &apos;abstract&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">  this.mode = mode;</span><br><span class="line"></span><br><span class="line">  switch (mode) &#123;</span><br><span class="line">    case &apos;history&apos;:</span><br><span class="line">      this.history = new HTML5History(this, options.base);</span><br><span class="line">      break</span><br><span class="line">    case &apos;hash&apos;:</span><br><span class="line">      this.history = new HashHistory(this, options.base, this.fallback);</span><br><span class="line">      break</span><br><span class="line">    case &apos;abstract&apos;:</span><br><span class="line">      this.history = new AbstractHistory(this, options.base);</span><br><span class="line">      break</span><br><span class="line">    default:</span><br><span class="line">      &#123;</span><br><span class="line">        assert(false, (&quot;invalid mode: &quot; + mode));</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>所以push方法的实现可能为以下三种情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">HTML5History.prototype.push = function push (location, onComplete, onAbort) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line"></span><br><span class="line">  var ref = this;</span><br><span class="line">  var fromRoute = ref.current;</span><br><span class="line">  this.transitionTo(location, function (route) &#123;</span><br><span class="line">    pushState(cleanPath(this$1.base + route.fullPath));</span><br><span class="line">    handleScroll(this$1.router, route, fromRoute, false);</span><br><span class="line">    onComplete &amp;&amp; onComplete(route);</span><br><span class="line">  &#125;, onAbort);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">HashHistory.prototype.push = function push (location, onComplete, onAbort) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line">  var ref = this;</span><br><span class="line">  var fromRoute = ref.current;</span><br><span class="line">  this.transitionTo(</span><br><span class="line">    location,</span><br><span class="line">    function (route) &#123;</span><br><span class="line">      pushHash(route.fullPath);//更改url</span><br><span class="line">      handleScroll(this$1.router, route, fromRoute, false);</span><br><span class="line">      onComplete &amp;&amp; onComplete(route);</span><br><span class="line">    &#125;,</span><br><span class="line">    onAbort</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line">AbstractHistory.prototype.push = function push (location, onComplete, onAbort) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line">  this.transitionTo(</span><br><span class="line">    location,</span><br><span class="line">    function (route) &#123;</span><br><span class="line">      this$1.stack = this$1.stack.slice(0, this$1.index + 1).concat(route);</span><br><span class="line">      this$1.index++;</span><br><span class="line">      onComplete &amp;&amp; onComplete(route);</span><br><span class="line">    &#125;,</span><br><span class="line">    onAbort</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可见三种模式下都会调用共同的父类History上的transitionTo方法<br>接下来以HashHistory为基础分析接下来的流程</p>
<p>在HashHistory push调用transitionTo时，<br>传入三个参数：<br>location 即我们调用push时传入的参数<br>onAbort 调用push时没有传入，故该值为undefined<br>第三个参数是一个匿名函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function (route) &#123;</span><br><span class="line">  pushHash(route.fullPath);//更改url</span><br><span class="line">  handleScroll(this$1.router, route, fromRoute, false);//处理页面滚动相关功能</span><br><span class="line">  onComplete &amp;&amp; onComplete(route);//调用push时没有传入onComplete,故onComplete=&gt;undefined,不会被执行</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>可见匿名函数内将来要执行pushHash函数</p>
<h3 id="pushHash函数更改浏览器url"><a href="#pushHash函数更改浏览器url" class="headerlink" title="pushHash函数更改浏览器url"></a>pushHash函数更改浏览器url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">function pushHash (path) &#123;</span><br><span class="line">  if (supportsPushState) &#123; 使用history.pushState更改URl</span><br><span class="line">    pushState(getUrl(path));</span><br><span class="line">  &#125; else &#123;//如果不支持history.pushState则直接更改hash值</span><br><span class="line">    window.location.hash = path;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function getUrl (path) &#123;</span><br><span class="line">  var href = window.location.href;</span><br><span class="line">  var i = href.indexOf(&apos;#&apos;);</span><br><span class="line">  var base = i &gt;= 0 ? href.slice(0, i) : href;</span><br><span class="line">  return (base + &quot;#&quot; + path)</span><br><span class="line">&#125;</span><br><span class="line">function pushState (url, replace) &#123;</span><br><span class="line">  saveScrollPosition();</span><br><span class="line">  // try...catch the pushState call to get around Safari</span><br><span class="line">  // DOM Exception 18 where it limits to 100 pushState calls</span><br><span class="line">  var history = window.history;</span><br><span class="line">  try &#123;</span><br><span class="line">    if (replace) &#123; //在使用replace函数跳转路由会走该分支，由replaceState函数调用，replace传入为true</span><br><span class="line">      // 保留现有的历史记录状态，因为用户可能会覆盖它</span><br><span class="line">      var stateCopy = extend(&#123;&#125;, history.state);</span><br><span class="line">      stateCopy.key = getStateKey();</span><br><span class="line">      history.replaceState(stateCopy, &apos;&apos;, url); //使用window的history上的方法</span><br><span class="line">    &#125; else &#123; //没有传入replace，故进入该分支</span><br><span class="line">      history.pushState(&#123; key: setStateKey(genStateKey()) &#125;, &apos;&apos;, url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    window.location[replace ? &apos;replace&apos; : &apos;assign&apos;](url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以pushHash函数最终的目的是更改浏览器中的url<br>handleScroll函数处理页面滚动状态，这里暂不做深入<br>onComplete 值为undefined,故不执行</p>
<h3 id="transitionTo"><a href="#transitionTo" class="headerlink" title="transitionTo"></a>transitionTo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">History.prototype.transitionTo = function transitionTo (</span><br><span class="line">    location,</span><br><span class="line">    onComplete,</span><br><span class="line">    onAbort</span><br><span class="line">  ) &#123;</span><br><span class="line">    var this$1 = this;</span><br><span class="line">    var route = this.router.match(location, this.current);//得到目的路由的route对象</span><br><span class="line">    this.confirmTransition(...暂时省略));</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>transitionTo函数中第一步就是根据根据当前路由信息和传入的目的路由信息生成目的路由对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var route = this.router.match(location, this.current);</span><br></pre></td></tr></table></figure></p>
<p>location 是我们调用push函数传入的参数，<br>this.current即当前页面路由信息对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">VueRouter.prototype.match = function match (</span><br><span class="line">  raw,</span><br><span class="line">  current,</span><br><span class="line">  redirectedFrom</span><br><span class="line">) &#123;</span><br><span class="line">  return this.matcher.match(raw, current, redirectedFrom)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">this.matcher = createMatcher(options.routes || [], this); //new vuerouter时在构造函数中生成</span><br></pre></td></tr></table></figure>
<h3 id="createMatcher"><a href="#createMatcher" class="headerlink" title="createMatcher"></a>createMatcher</h3><p>createMatcher函数即创造匹配器的函数，主要做三件事<br>1.生成路由表<br>2.生成匹配器，用于将当然路由对象和目的路由信息对象合成目的路由对象<br>3.生成动态添加路由的函数，因这里可以直接使用路由表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">function createMatcher (</span><br><span class="line">  routes,</span><br><span class="line">  router</span><br><span class="line">) &#123;</span><br><span class="line">  var ref = createRouteMap(routes);//根据路由配置生成路由表</span><br><span class="line">  var pathList = ref.pathList;</span><br><span class="line">  var pathMap = ref.pathMap;</span><br><span class="line">  var nameMap = ref.nameMap;</span><br><span class="line"></span><br><span class="line">  function addRoutes (routes) &#123; //动态增加路由</span><br><span class="line">    createRouteMap(routes, pathList, pathMap, nameMap);</span><br><span class="line">  &#125;</span><br><span class="line">  //根据当前路由对象和目的路由信息以及是否重定向等条件合成目的路由对象返回</span><br><span class="line">  function match ( </span><br><span class="line">    raw,</span><br><span class="line">    currentRoute,</span><br><span class="line">    redirectedFrom</span><br><span class="line">  ) &#123;</span><br><span class="line">    //统一路由参数，合并params给到目的路由</span><br><span class="line">    var location = normalizeLocation(raw, currentRoute, false, router);</span><br><span class="line">    var name = location.name;</span><br><span class="line">    if (name) &#123;//走这条分支</span><br><span class="line">      var record = nameMap[name];</span><br><span class="line">      &#123;</span><br><span class="line">        warn(record, (&quot;Route with name &apos;&quot; + name + &quot;&apos; does not exist&quot;));</span><br><span class="line">      &#125;</span><br><span class="line">      if (!record) &#123; return _createRoute(null, location) &#125;</span><br><span class="line">      var paramNames = record.regex.keys //没有在路由path中配置动态参数，keys数组为空</span><br><span class="line">        .filter(function (key) &#123; return !key.optional; &#125;)</span><br><span class="line">        .map(function (key) &#123; return key.name; &#125;);</span><br><span class="line"></span><br><span class="line">      if (typeof location.params !== &apos;object&apos;) &#123;</span><br><span class="line">        location.params = &#123;&#125;; //给location 挂上params</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (currentRoute &amp;&amp; typeof currentRoute.params === &apos;object&apos;) &#123;</span><br><span class="line">        for (var key in currentRoute.params) &#123;//params中有相同key值时，从当前路由将值给到目的路由</span><br><span class="line">          if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) &gt; -1) &#123;</span><br><span class="line">            location.params[key] = currentRoute.params[key];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      //如果path有动态参数，使用params将path补全，//以name发起的跳转，挂上了path</span><br><span class="line">      location.path = fillParams(record.path, location.params, (&quot;named route \&quot;&quot; + name + &quot;\&quot;&quot;));</span><br><span class="line">      return _createRoute(record, location, redirectedFrom) 可知返回一route对象</span><br><span class="line">    &#125; else if (location.path) &#123; //详见link跳转分析</span><br><span class="line">      location.params = &#123;&#125;;</span><br><span class="line">      for (var i = 0; i &lt; pathList.length; i++) &#123;</span><br><span class="line">        var path = pathList[i];</span><br><span class="line">        var record$1 = pathMap[path];</span><br><span class="line">        if (matchRoute(record$1.regex, location.path, location.params)) &#123;</span><br><span class="line">          console.log(location)</span><br><span class="line">          return _createRoute(record$1, location, redirectedFrom)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // no match</span><br><span class="line">    return _createRoute(null, location)</span><br><span class="line">  &#125;</span><br><span class="line">  function redirect () &#123;...对重定向一系列的处理，会返回createRoute()&#125;</span><br><span class="line">  function alias () &#123;...对路由配置中的别名进行处理，会返回createRoute()&#125;</span><br><span class="line">  function _createRoute ( //会生成fullpath</span><br><span class="line">    record,</span><br><span class="line">    location,</span><br><span class="line">    redirectedFrom</span><br><span class="line">  ) &#123;</span><br><span class="line">    if (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">      return redirect(record, redirectedFrom || location)</span><br><span class="line">    &#125;</span><br><span class="line">    if (record &amp;&amp; record.matchAs) &#123;</span><br><span class="line">      return alias(record, location, record.matchAs)</span><br><span class="line">    &#125;</span><br><span class="line">    return createRoute(record, location, redirectedFrom, router)</span><br><span class="line">  &#125;</span><br><span class="line">  return &#123;</span><br><span class="line">    match: match,</span><br><span class="line">    addRoutes: addRoutes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="路由表生成"><a href="#路由表生成" class="headerlink" title="路由表生成"></a>路由表生成</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">function createRouteMap ( //生成路由表</span><br><span class="line">  routes,</span><br><span class="line">  oldPathList,</span><br><span class="line">  oldPathMap,</span><br><span class="line">  oldNameMap</span><br><span class="line">) &#123;</span><br><span class="line">  // the path list is used to control path matching priority</span><br><span class="line">  var pathList = oldPathList || [];</span><br><span class="line">  // $flow-disable-line</span><br><span class="line">  var pathMap = oldPathMap || Object.create(null);</span><br><span class="line">  // $flow-disable-line</span><br><span class="line">  var nameMap = oldNameMap || Object.create(null);</span><br><span class="line"></span><br><span class="line">  routes.forEach(function (route) &#123;</span><br><span class="line">    addRouteRecord(pathList, pathMap, nameMap, route);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // ensure wildcard(通配符) routes are always at the end</span><br><span class="line">  for (var i = 0, l = pathList.length; i &lt; l; i++) &#123;</span><br><span class="line">    if (pathList[i] === &apos;*&apos;) &#123;</span><br><span class="line">      pathList.push(pathList.splice(i, 1)[0]);</span><br><span class="line">      l--;</span><br><span class="line">      i--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    // warn if routes do not include leading slashes(斜线)</span><br><span class="line">    var found = pathList</span><br><span class="line">    // check for missing leading slash</span><br><span class="line">      .filter(function (path) &#123; return path &amp;&amp; path.charAt(0) !== &apos;*&apos; &amp;&amp; path.charAt(0) !== &apos;/&apos;; &#125;);</span><br><span class="line"></span><br><span class="line">    if (found.length &gt; 0) &#123;</span><br><span class="line">      var pathNames = found.map(function (path) &#123; return (&quot;- &quot; + path); &#125;).join(&apos;\n&apos;);</span><br><span class="line">      warn(false, (&quot;Non-nested routes must include a leading slash character. Fix the following routes: \n&quot; + pathNames));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    pathList: pathList,//数组，存放path值的集合</span><br><span class="line">    pathMap: pathMap,//对象，有配置path的路由record集合</span><br><span class="line">    nameMap: nameMap//对象，有配置name的路由record的集合</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//根据配置的路由将其转换成内部使用的路由对象record,并根据配置情况放到不同路由集合(前三个参数)中，</span><br><span class="line">function addRouteRecord ( </span><br><span class="line">  pathList,</span><br><span class="line">  pathMap,</span><br><span class="line">  nameMap,</span><br><span class="line">  route,//具体配置的route</span><br><span class="line">  parent,//用于处理配置了children，被递归调用时传入，</span><br><span class="line">  matchAs</span><br><span class="line">) &#123;</span><br><span class="line">  var path = route.path;</span><br><span class="line">  var name = route.name;</span><br><span class="line"> </span><br><span class="line">  var pathToRegexpOptions =</span><br><span class="line">    route.pathToRegexpOptions || &#123;&#125;;</span><br><span class="line">  var normalizedPath = normalizePath(path, parent, pathToRegexpOptions.strict);</span><br><span class="line"></span><br><span class="line">  if (typeof route.caseSensitive === &apos;boolean&apos;) &#123;</span><br><span class="line">    pathToRegexpOptions.sensitive = route.caseSensitive;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var record = &#123;</span><br><span class="line">    path: normalizedPath,</span><br><span class="line">    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),</span><br><span class="line">    components: route.components || &#123; default: route.component &#125;,</span><br><span class="line">    instances: &#123;&#125;,</span><br><span class="line">    name: name,</span><br><span class="line">    parent: parent,</span><br><span class="line">    matchAs: matchAs,</span><br><span class="line">    redirect: route.redirect,</span><br><span class="line">    beforeEnter: route.beforeEnter,</span><br><span class="line">    meta: route.meta || &#123;&#125;,</span><br><span class="line">    props:</span><br><span class="line">      route.props == null</span><br><span class="line">        ? &#123;&#125;</span><br><span class="line">        : route.components</span><br><span class="line">          ? route.props</span><br><span class="line">          : &#123; default: route.props &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  if (route.children) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  if (!pathMap[record.path]) &#123;</span><br><span class="line">    pathList.push(record.path);</span><br><span class="line">    pathMap[record.path] = record;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (route.alias !== undefined) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  if (name) &#123;</span><br><span class="line">    if (!nameMap[name]) &#123;</span><br><span class="line">      nameMap[name] = record;</span><br><span class="line">    &#125; else if ( !matchAs) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        false,</span><br><span class="line">        &quot;Duplicate named routes definition: &quot; +</span><br><span class="line">          &quot;&#123; name: \&quot;&quot; + name + &quot;\&quot;, path: \&quot;&quot; + (record.path) + &quot;\&quot; &#125;&quot;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并params"><a href="#合并params" class="headerlink" title="合并params"></a>合并params</h3><p>在match函数中首先会整理参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">function normalizeLocation (</span><br><span class="line">   raw,</span><br><span class="line">   current,</span><br><span class="line">   append,</span><br><span class="line">   router</span><br><span class="line"> ) &#123;</span><br><span class="line">   //link标签点击传入的raw是to标签指令的值， 为字符串</span><br><span class="line">   var next = typeof raw === &apos;string&apos; ? &#123; path: raw &#125; : raw;</span><br><span class="line">   // named target</span><br><span class="line">   if (next._normalized) &#123;//已经处理过</span><br><span class="line">     return next</span><br><span class="line">   &#125; else if (next.name) &#123; //当前调用push使用name标记路由，只会走这个分支</span><br><span class="line">     next = extend(&#123;&#125;, raw);</span><br><span class="line">     var params = next.params;</span><br><span class="line">     if (params &amp;&amp; typeof params === &apos;object&apos;) &#123;</span><br><span class="line">       next.params = extend(&#123;&#125;, params);</span><br><span class="line">     &#125;</span><br><span class="line">     return next</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // relative params</span><br><span class="line">   if (!next.path &amp;&amp; next.params &amp;&amp; current) &#123;</span><br><span class="line">     next = extend(&#123;&#125;, next);</span><br><span class="line">     next._normalized = true;</span><br><span class="line">     var params$1 = extend(extend(&#123;&#125;, current.params), next.params);</span><br><span class="line">     if (current.name) &#123;</span><br><span class="line">       next.name = current.name;</span><br><span class="line">       next.params = params$1;</span><br><span class="line">     &#125; else if (current.matched.length) &#123;</span><br><span class="line">       var rawPath = current.matched[current.matched.length - 1].path;</span><br><span class="line">       next.path = fillParams(rawPath, params$1, (&quot;path &quot; + (current.path)));</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">       warn(false, &quot;relative params navigation requires a current route.&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">     return next</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   var parsedPath = parsePath(next.path || &apos;&apos;);</span><br><span class="line">   var basePath = (current &amp;&amp; current.path) || &apos;/&apos;;</span><br><span class="line">   var path = parsedPath.path</span><br><span class="line">     ? resolvePath(parsedPath.path, basePath, append || next.append)</span><br><span class="line">     : basePath;</span><br><span class="line"></span><br><span class="line">   var query = resolveQuery(</span><br><span class="line">     parsedPath.query,</span><br><span class="line">     next.query,</span><br><span class="line">     router &amp;&amp; router.options.parseQuery</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">   var hash = next.hash || parsedPath.hash;</span><br><span class="line">   if (hash &amp;&amp; hash.charAt(0) !== &apos;#&apos;) &#123;</span><br><span class="line">     hash = &quot;#&quot; + hash;</span><br><span class="line">   &#125;</span><br><span class="line">   return &#123;</span><br><span class="line">     _normalized: true,</span><br><span class="line">     path: path,</span><br><span class="line">     query: query,</span><br><span class="line">     hash: hash</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="创建路由route对象"><a href="#创建路由route对象" class="headerlink" title="创建路由route对象"></a>创建路由route对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">function createRoute (</span><br><span class="line">  record,</span><br><span class="line">  location,</span><br><span class="line">  redirectedFrom,</span><br><span class="line">  router</span><br><span class="line">) &#123;</span><br><span class="line">  var stringifyQuery = router &amp;&amp; router.options.stringifyQuery;</span><br><span class="line"></span><br><span class="line">  var query = location.query || &#123;&#125;;</span><br><span class="line">  try &#123;</span><br><span class="line">    query = clone(query);</span><br><span class="line">  &#125; catch (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  var route = &#123;</span><br><span class="line">    name: location.name || (record &amp;&amp; record.name),</span><br><span class="line">    meta: (record &amp;&amp; record.meta) || &#123;&#125;,</span><br><span class="line">    path: location.path || &apos;/&apos;,</span><br><span class="line">    hash: location.hash || &apos;&apos;,</span><br><span class="line">    query: query,//调用push函数传递进来的query，赋值时只能赋值js数据类型，拿到的也是js数据类型</span><br><span class="line">    params: location.params || &#123;&#125;,</span><br><span class="line">    fullPath: getFullPath(location, stringifyQuery),//生成fullPath</span><br><span class="line">    matched: record ? formatMatch(record) : []</span><br><span class="line">  &#125;;</span><br><span class="line">  if (redirectedFrom) &#123;</span><br><span class="line">    route.redirectedFrom = getFullPath(redirectedFrom, stringifyQuery);</span><br><span class="line">  &#125;</span><br><span class="line">  return Object.freeze(route) //禁止改动route对象</span><br><span class="line">&#125;</span><br><span class="line">function getFullPath ( //根据query生成fullPath</span><br><span class="line">    ref,</span><br><span class="line">    _stringifyQuery</span><br><span class="line">  ) &#123;</span><br><span class="line">    var path = ref.path;</span><br><span class="line">    var query = ref.query; if ( query === void 0 ) query = &#123;&#125;;</span><br><span class="line">    var hash = ref.hash; if ( hash === void 0 ) hash = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    var stringify = _stringifyQuery || stringifyQuery;</span><br><span class="line">    return (path || &apos;/&apos;) + stringify(query) + hash</span><br><span class="line">  &#125;</span><br><span class="line">//组装url上参数的部分</span><br><span class="line">function stringifyQuery (obj) &#123;</span><br><span class="line">  var res = obj ? Object.keys(obj).map(function (key) &#123;</span><br><span class="line">    var val = obj[key];</span><br><span class="line"></span><br><span class="line">    if (val === undefined) &#123;</span><br><span class="line">      return &apos;&apos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (val === null) &#123;</span><br><span class="line">      return encode(key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (Array.isArray(val)) &#123;</span><br><span class="line">      var result = [];</span><br><span class="line">      val.forEach(function (val2) &#123;</span><br><span class="line">        if (val2 === undefined) &#123;</span><br><span class="line">          return</span><br><span class="line">        &#125;</span><br><span class="line">        if (val2 === null) &#123;</span><br><span class="line">          result.push(encode(key));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          result.push(encode(key) + &apos;=&apos; + encode(val2));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      return result.join(&apos;&amp;&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return encode(key) + &apos;=&apos; + encode(val)</span><br><span class="line">  &#125;).filter(function (x) &#123; return x.length &gt; 0; &#125;).join(&apos;&amp;&apos;) : null;</span><br><span class="line">  return res ? (&quot;?&quot; + res) : &apos;&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以在调用完match之后会得到route,接着会调用confirmTransition</p>
<h3 id="confirmTransition"><a href="#confirmTransition" class="headerlink" title="confirmTransition"></a>confirmTransition</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">在transitionTo调用时</span><br><span class="line">this.confirmTransition(</span><br><span class="line">  route,</span><br><span class="line">  function () &#123;</span><br><span class="line">    this$1.updateRoute(route);//更新router对象</span><br><span class="line">    onComplete &amp;&amp; onComplete(route);//调用transitionTo时传入的第二个参数函数，里面有pushHash来更改url</span><br><span class="line">    this$1.ensureURL();</span><br><span class="line"></span><br><span class="line">    // fire ready cbs once</span><br><span class="line">    if (!this$1.ready) &#123;</span><br><span class="line">      this$1.ready = true;</span><br><span class="line">      this$1.readyCbs.forEach(function (cb) &#123;</span><br><span class="line">        cb(route);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  function (err) &#123;</span><br><span class="line">    if (onAbort) &#123;</span><br><span class="line">      onAbort(err);</span><br><span class="line">    &#125;</span><br><span class="line">    if (err &amp;&amp; !this$1.ready) &#123;</span><br><span class="line">      this$1.ready = true;</span><br><span class="line">      this$1.readyErrorCbs.forEach(function (cb) &#123;</span><br><span class="line">        cb(err);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">History.prototype.confirmTransition = function confirmTransition (route, onComplete, onAbort) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line"></span><br><span class="line">  var current = this.current;</span><br><span class="line">  var abort = function (err) &#123;</span><br><span class="line">    // after merging https://github.com/vuejs/vue-router/pull/2771 we</span><br><span class="line">    // When the user navigates through history through back/forward buttons</span><br><span class="line">    // we do not want to throw the error. We only throw it if directly calling</span><br><span class="line">    // push/replace. That&apos;s why it&apos;s not included in isError</span><br><span class="line">    if (!isExtendedError(NavigationDuplicated, err) &amp;&amp; isError(err)) &#123;</span><br><span class="line">      if (this$1.errorCbs.length) &#123;</span><br><span class="line">        this$1.errorCbs.forEach(function (cb) &#123;</span><br><span class="line">          cb(err);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        warn(false, &apos;uncaught error during route navigation:&apos;);</span><br><span class="line">        console.error(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    onAbort &amp;&amp; onAbort(err);</span><br><span class="line">  &#125;;</span><br><span class="line">  if (</span><br><span class="line">    isSameRoute(route, current) &amp;&amp;</span><br><span class="line">    // in the case the route map has been dynamically appended to</span><br><span class="line">    route.matched.length === current.matched.length</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.ensureURL();</span><br><span class="line">    return abort(new NavigationDuplicated(route))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var ref = resolveQueue(</span><br><span class="line">    this.current.matched,</span><br><span class="line">    route.matched</span><br><span class="line">  );</span><br><span class="line">    var updated = ref.updated;</span><br><span class="line">    var deactivated = ref.deactivated;</span><br><span class="line">    var activated = ref.activated;</span><br><span class="line"></span><br><span class="line">  var queue = [].concat(</span><br><span class="line">    // in-component leave guards</span><br><span class="line">    extractLeaveGuards(deactivated),</span><br><span class="line">    // global before hooks</span><br><span class="line">    this.router.beforeHooks,</span><br><span class="line">    // in-component update hooks</span><br><span class="line">    extractUpdateHooks(updated),</span><br><span class="line">    // in-config enter guards</span><br><span class="line">    activated.map(function (m) &#123; return m.beforeEnter; &#125;),</span><br><span class="line">    // async components</span><br><span class="line">    resolveAsyncComponents(activated)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  this.pending = route;</span><br><span class="line">  var iterator = function (hook, next) &#123;</span><br><span class="line">    if (this$1.pending !== route) &#123;</span><br><span class="line">      return abort()</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">      hook(route, current, function (to) &#123;</span><br><span class="line">        if (to === false || isError(to)) &#123;</span><br><span class="line">          // next(false) -&gt; abort navigation, ensure current URL</span><br><span class="line">          this$1.ensureURL(true);</span><br><span class="line">          abort(to);</span><br><span class="line">        &#125; else if (</span><br><span class="line">          typeof to === &apos;string&apos; ||</span><br><span class="line">          (typeof to === &apos;object&apos; &amp;&amp;</span><br><span class="line">            (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</span><br><span class="line">        ) &#123;</span><br><span class="line">          // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</span><br><span class="line">          abort();</span><br><span class="line">          if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123;</span><br><span class="line">            this$1.replace(to);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            this$1.push(to);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // confirm transition and pass on the value</span><br><span class="line">          next(to);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      abort(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  runQueue(queue, iterator, function () &#123;</span><br><span class="line">    var postEnterCbs = [];</span><br><span class="line">    var isValid = function () &#123; return this$1.current === route; &#125;;</span><br><span class="line">    // wait until async components are resolved before</span><br><span class="line">    // extracting in-component enter guards</span><br><span class="line">    var enterGuards = extractEnterGuards(activated, postEnterCbs, isValid);</span><br><span class="line">    var queue = enterGuards.concat(this$1.router.resolveHooks);</span><br><span class="line">    runQueue(queue, iterator, function () &#123;</span><br><span class="line">      if (this$1.pending !== route) &#123;</span><br><span class="line">        return abort()</span><br><span class="line">      &#125;</span><br><span class="line">      this$1.pending = null;</span><br><span class="line">      onComplete(route);//所有需要运行的钩子函数运行完执行更改url,更新current,处理页面滚动</span><br><span class="line">      if (this$1.router.app) &#123;</span><br><span class="line">        this$1.router.app.$nextTick(function () &#123;</span><br><span class="line">          postEnterCbs.forEach(function (cb) &#123;</span><br><span class="line">            cb();</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"> function runQueue (queue, fn, cb) &#123;</span><br><span class="line">  var step = function (index) &#123;</span><br><span class="line">    if (index &gt;= queue.length) &#123;</span><br><span class="line">      cb();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (queue[index]) &#123;</span><br><span class="line">        fn(queue[index], function () &#123;</span><br><span class="line">          step(index + 1);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        step(index + 1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  step(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">History.prototype.updateRoute = function updateRoute (route) &#123;</span><br><span class="line">  var prev = this.current;</span><br><span class="line">  this.current = route;</span><br><span class="line">  this.cb &amp;&amp; this.cb(route); //通知app更改_route属性值，即更改$route值</span><br><span class="line">  this.router.afterHooks.forEach(function (hook) &#123;</span><br><span class="line">    hook &amp;&amp; hook(route, prev);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">this.cb在install的时候被定义如果获取</span><br><span class="line">History.prototype.listen = function listen (cb) &#123;</span><br><span class="line">  this.cb = cb;</span><br><span class="line">&#125;;</span><br><span class="line">//在new vue时被定义</span><br><span class="line">VueRouter.prototype.init = function init (app ) &#123;</span><br><span class="line">  history.listen(function (route) &#123;</span><br><span class="line">    this$1.apps.forEach(function (app) &#123;</span><br><span class="line">      app._route = route;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">//install的时候</span><br><span class="line">function install (Vue) &#123;</span><br><span class="line">  Object.defineProperty(Vue.prototype, &apos;$route&apos;, &#123;</span><br><span class="line">    get: function get () &#123; return this._routerRoot._route &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="link标签跳转路由"><a href="#link标签跳转路由" class="headerlink" title="link标签跳转路由"></a>link标签跳转路由</h2><p>点击link标签时，根据绑定函数即可知道，同样会调用router.push<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var router = this.$router;</span><br><span class="line">var current = this.$route;</span><br><span class="line">var ref = router.resolve(</span><br><span class="line">  this.to,</span><br><span class="line">  current,</span><br><span class="line">  this.append</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">var location = ref.location;</span><br><span class="line">var route = ref.route;</span><br><span class="line">var href = ref.href;</span><br><span class="line"></span><br><span class="line">var handler = function (e) &#123;</span><br><span class="line">  if (guardEvent(e)) &#123;</span><br><span class="line">    if (this$1.replace) &#123;</span><br><span class="line">      router.replace(location, noop);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      router.push(location, noop);//push,直接走同步流程</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var on = &#123; click: guardEvent &#125;;</span><br><span class="line">if (Array.isArray(this.event)) &#123;</span><br><span class="line">  this.event.forEach(function (e) &#123;</span><br><span class="line">    on[e] = handler;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  on[this.event] = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中，经过resolve处理过的to标签属性的值，会生成统一规范的后续需要使用的location,route<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">VueRouter.prototype.resolve = function resolve (</span><br><span class="line">  to,</span><br><span class="line">  current,</span><br><span class="line">  append</span><br><span class="line">) &#123;</span><br><span class="line">  current = current || this.history.current;</span><br><span class="line">  var location = normalizeLocation(</span><br><span class="line">    to,</span><br><span class="line">    current,</span><br><span class="line">    append,</span><br><span class="line">    this</span><br><span class="line">  );</span><br><span class="line">  var route = this.match(location, current);</span><br><span class="line">  var fullPath = route.redirectedFrom || route.fullPath;</span><br><span class="line">  var base = this.history.base;</span><br><span class="line">  var href = createHref(base, fullPath, this.mode);</span><br><span class="line">  return &#123;</span><br><span class="line">    location: location,</span><br><span class="line">    route: route,</span><br><span class="line">    href: href,</span><br><span class="line">    // for backwards compat</span><br><span class="line">    normalizedTo: location,</span><br><span class="line">    resolved: route</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>location 会在normalizeLocation中以第三个return的位置返回如下结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  _normalized: true,</span><br><span class="line">  path: path,</span><br><span class="line">  query: query,</span><br><span class="line">  hash: hash</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样相当于提前normalizeLocation调用，所以在match再调用的时候直接返回自身<br>在接下来的match流程中,会进入以path为依据的流程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">else if (location.path) &#123;</span><br><span class="line">  location.params = &#123;&#125;;</span><br><span class="line">  for (var i = 0; i &lt; pathList.length; i++) &#123;</span><br><span class="line">    var path = pathList[i];</span><br><span class="line">    var record$1 = pathMap[path];//根据path拿到record对象</span><br><span class="line">    if (matchRoute(record$1.regex, location.path, location.params)) &#123;</span><br><span class="line">      return _createRoute(record$1, location, redirectedFrom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据标签to赋予的path值，和生成路由表时拿到的path配置值，根据正则表达式解析params对象，<br>也说明了，为什么跳转路包含动态参数的path时，要跟params配对使用</p>
<h3 id="matchRoute"><a href="#matchRoute" class="headerlink" title="matchRoute"></a>matchRoute</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">function matchRoute (</span><br><span class="line">    regex,</span><br><span class="line">    path,</span><br><span class="line">    params</span><br><span class="line">  ) &#123;</span><br><span class="line">    var m = path.match(regex);</span><br><span class="line">    if (!m) &#123;//当前路由不符合route定义时格式</span><br><span class="line">      return false</span><br><span class="line">    &#125; else if (!params) &#123;</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line">    //匹配路由组装params</span><br><span class="line">    for (var i = 1, len = m.length; i &lt; len; ++i) &#123;</span><br><span class="line">      var key = regex.keys[i - 1];</span><br><span class="line">      var val = typeof m[i] === &apos;string&apos; ? decodeURIComponent(m[i]) : m[i];//始终为子字符串</span><br><span class="line">      if (key) &#123;</span><br><span class="line">        // Fix #1994: using * with props: true generates a param named 0</span><br><span class="line">        params[key.name || &apos;pathMatch&apos;] = val;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return true</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="直接更改url跳转"><a href="#直接更改url跳转" class="headerlink" title="直接更改url跳转"></a>直接更改url跳转</h2><p>在浏览器直接更改含有动态路由的的url，回车跳转，会根据事先绑定的监听事件进行解析处理<br>在new vue时初始化完当前路由，以执行回调的方式绑定监听<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  VueRouter.prototype.init = function init (app /* Vue component instance */) &#123;</span><br><span class="line">  var this$1 = this;</span><br><span class="line"></span><br><span class="line">  this.app = app;</span><br><span class="line"></span><br><span class="line">  var history = this.history;</span><br><span class="line"></span><br><span class="line">  if (history instanceof HTML5History) &#123; //h5history在new h5history时，在构造函数中设置popstate事件监听</span><br><span class="line">    history.transitionTo(history.getCurrentLocation());</span><br><span class="line">  &#125; else if (history instanceof HashHistory) &#123;</span><br><span class="line">    var setupHashListener = function () &#123;</span><br><span class="line">      history.setupListeners();//设置监听</span><br><span class="line">    &#125;;</span><br><span class="line">    history.transitionTo( //无论成功与否都绑定</span><br><span class="line">      history.getCurrentLocation(),</span><br><span class="line">      setupHashListener, </span><br><span class="line">      setupHashListener</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  history.listen(function (route) &#123; //route改变时调用，this.cb</span><br><span class="line">    this$1.apps.forEach(function (app) &#123;</span><br><span class="line">      app._route = route;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>设置监听具体内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">HashHistory.prototype.setupListeners = function setupListeners () &#123;</span><br><span class="line">    var this$1 = this;</span><br><span class="line"></span><br><span class="line">    var router = this.router;</span><br><span class="line">    var expectScroll = router.options.scrollBehavior;</span><br><span class="line">    var supportsScroll = supportsPushState &amp;&amp; expectScroll;</span><br><span class="line"></span><br><span class="line">    if (supportsScroll) &#123;</span><br><span class="line">      setupScroll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    window.addEventListener(</span><br><span class="line">      supportsPushState ? &apos;popstate&apos; : &apos;hashchange&apos;,</span><br><span class="line">      function () &#123;</span><br><span class="line">        var current = this$1.current;</span><br><span class="line">        if (!ensureSlash()) &#123;</span><br><span class="line">          return</span><br><span class="line">      &#125;</span><br><span class="line">       //直接调用transitionTo进行路由更新</span><br><span class="line">      this$1.transitionTo(getHash(), function (route) &#123; //成功回调不用pushHash更新url</span><br><span class="line">        if (supportsScroll) &#123;</span><br><span class="line">          handleScroll(this$1.router, route, current, true);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!supportsPushState) &#123;</span><br><span class="line">          replaceHash(route.fullPath);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可见通过监听事件触发的路由改变会直接调用transitionTo函数进行跳转</p>
<h1 id="两个收获"><a href="#两个收获" class="headerlink" title="两个收获"></a>两个收获</h1><p>1.normalizeLocation函数发挥的作用，根据第一参数location对象不同的属性状态进行不同的处理，用于在上游的不同情境(不同方式导致跳转)使用中统一调用<br>2.在transitionTo函数中调用comfirmTransition,为什么不直接在transitionTo函数中书写confirmTransition函数内容呢，为什么要单独摘出来呢？同样，comfirmTransition函数不止会在transition中调用,<br>还会在AbstractHistory的go函数中被直接调用，HashHistory和HTML5History的go方法会直接使用window.history.go(n);nodejs全局对象是global,不是windows,所以需要特殊处理</p>
<p><img src="/image/vuerouter.jpg" alt="vuerouter"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuex1.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuex1.html" itemprop="url">
                  vuex 一些api使用规则
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-05T12:41:15+08:00">
                2020-02-05
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">官网地址</a><br>基本思想：<br>通过定义和隔离状态管理中的各种概念并通过强制规则维持视图和状态间的独立性<br>以一个全局单例模式管理抽取出来的组件共享状态<br><img src="/image/vuex.png" alt="思路图"></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Vue.use(Vuex) //会调用install，在beforeMount声明周期进行初始化工作</span><br><span class="line"></span><br><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const app = new Vue(&#123;</span><br><span class="line">  el: &apos;#app&apos;,</span><br><span class="line">  // 把 store 对象提供给 “store” 选项，这可以把 store 的实例注入所有的子组件</span><br><span class="line">  store,</span><br><span class="line">  components: &#123; Counter &#125;,</span><br><span class="line">  template: `</span><br><span class="line">    &lt;div class=&quot;app&quot;&gt;</span><br><span class="line">      &lt;counter&gt;&lt;/counter&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  `</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const Counter = &#123;</span><br><span class="line">  template: `&lt;div&gt;&#123;&#123; count &#125;&#125;&lt;/div&gt;`,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    count () &#123;</span><br><span class="line">      return this.$store.state.count</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="state"><a href="#state" class="headerlink" title="state"></a>state</h1><p>具体变量声明对象，存放每个具体的公共变量</p>
<p>声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: 0</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>在vue中使用—访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.$store.state.count</span><br></pre></td></tr></table></figure></p>
<p><a href="https://vuex.vuejs.org/zh/guide/state.html#mapstate-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0" target="_blank" rel="noopener">辅助函数mapstate</a></p>
<h1 id="getter"><a href="#getter" class="headerlink" title="getter"></a>getter</h1><p>相当与vue的计算属性<br>访问声明的属性时，执行对应的函数，拿到的值为函数返回的值<br>如果函数返回另一个函数，则可以调用返回的函数去实现相应的功能<br>适用于多个组件共享一个同样处理逻辑的函数</p>
<p>getter 的返回值会根据它的依赖被缓存起来<br>且只有当它的依赖值发生了改变才会被重新计算<br>Getter 接受 state 作为其第一个参数</p>
<p>声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    todos: [</span><br><span class="line">      &#123; id: 1, text: &apos;...&apos;, done: true &#125;,</span><br><span class="line">      &#123; id: 2, text: &apos;...&apos;, done: false &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    doneTodos: state =&gt; &#123;</span><br><span class="line">      return state.todos.filter(todo =&gt; todo.done)</span><br><span class="line">    &#125;,</span><br><span class="line">    // 受其他 getter 作为第二个参数,调用其他getter方法</span><br><span class="line">    doneTodosCount: (state, getters) =&gt; &#123;</span><br><span class="line">      return getters.doneTodos.length</span><br><span class="line">    &#125;</span><br><span class="line">    getTodoById: (state) =&gt; (id) =&gt; &#123;</span><br><span class="line">      return state.todos.find(todo =&gt; todo.id === id)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在vue中使用—访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">this.$store.getters.doneTodos // -&gt; [&#123; id: 1, text: &apos;...&apos;, done: true &#125;]</span><br><span class="line">this.$store.getters.doneTodosCount // -&gt; 1</span><br><span class="line">this.$store.getters.getTodoById(2) // -&gt; &#123; id: 2, text: &apos;...&apos;, done: false &#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://vuex.vuejs.org/zh/guide/getters.html#mapgetters-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0" target="_blank" rel="noopener">映射辅助函数mapGetters</a></p>
<h1 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h1><p>存储同步改变state保存值的方法</p>
<p>声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state, payload) &#123; //payload即调用时传递进来的参数</span><br><span class="line">      state.count += payload.amount</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在vue中使用—调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">this.$store.commit(&apos;increment&apos;, &#123;</span><br><span class="line">  amount: 10</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>注意事项<br>1.提前在 store 中初始化好所有所需属性。<br>2.当需要在对象上添加新属性时，应该使用 Vue.set或者以新对象替换老对象<br><a href="https://vuex.vuejs.org/zh/guide/mutations.html#%E5%9C%A8%E7%BB%84%E4%BB%B6%E4%B8%AD%E6%8F%90%E4%BA%A4-mutation" target="_blank" rel="noopener">映射辅助函数mapMutations</a></p>
<h1 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h1><p>存储异步改变state保存值的方法<br>Action 函数接受一个与 store 实例具有相同方法和属性的 context 对象，因此你可以调用 context.commit 提交一个 mutation，或者通过 context.state 和 context.getters 来获取 state 和 getters。但他不是 store 实例本身<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment (context) &#123;</span><br><span class="line">      context.commit(&apos;increment&apos;)</span><br><span class="line">    &#125;,</span><br><span class="line">    incrementAsync (&#123; commit &#125;) &#123; //结构仅拿到contex里面的commit</span><br><span class="line">      setTimeout(() =&gt; &#123;</span><br><span class="line">        commit(&apos;increment&apos;)</span><br><span class="line">      &#125;, 1000)</span><br><span class="line">    &#125;,</span><br><span class="line">    actionA (&#123; commit &#125;) &#123;</span><br><span class="line">      return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">          commit(&apos;someMutation&apos;)</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;, 1000)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    actionB (&#123; dispatch, commit &#125;) &#123;</span><br><span class="line">      return dispatch(&apos;actionA&apos;).then(() =&gt; &#123;</span><br><span class="line">        commit(&apos;someOtherMutation&apos;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    async actionA (&#123; commit &#125;) &#123;</span><br><span class="line">      commit(&apos;gotData&apos;, await getData())</span><br><span class="line">    &#125;,</span><br><span class="line">    async actionB (&#123; dispatch, commit &#125;) &#123;</span><br><span class="line">      await dispatch(&apos;actionA&apos;) // 等待 actionA 完成</span><br><span class="line">      commit(&apos;gotOtherData&apos;, await getOtherData())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在VUE中使用—调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">this.$store.dispatch(&apos;incrementAsync&apos;, &#123; //作为第二个参数传递action</span><br><span class="line">  amount: 10</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">this.$store.dispatch(&apos;actionA&apos;).then(() =&gt; &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">this.$store.dispatch(&apos;actionB&apos;).then(() =&gt; &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h1 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h1><p>声明多个store配置对象，每个作为一个模块<br>每个模块拥有自己的 state、mutation、action、getter、甚至是嵌套子模块<br>套嵌条件下,state 会处理成树状结构进行访问，但要进行更改操作时，<br>如果有子模块没有进行命名空间设置，但又包含跟全局状态相同处理名称的 mutation 或 action<br>则在调用时，都会执行</p>
<p>默认情况下，模块内部的 action、mutation 和 getter 是注册在全局命名空间的——这样使得多个模块能够对同一 mutation 或 action 作出响应。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">let moduleA = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state()&#123; </span><br><span class="line">    return&#123;</span><br><span class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;,</span><br><span class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let moduleB = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state: &#123; </span><br><span class="line">    countb: 0,//this.$store.state.b.countb</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</span><br><span class="line">      state.countb++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</span><br><span class="line">    aa: moduleA,//this.$store.state.b.aa.counta</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// vuex相关代码</span><br><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123; </span><br><span class="line">    count: 0, //this.$store.state.count</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    a: moduleA, //this.$store.state.a.counta</span><br><span class="line">    b: moduleB //this.$store.state.b.countb</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>小结<br>namespaced: true相当于子模块的隔离层，<br>如果设置了，外界不能直接通过mutations里面的函数名进行commit调用，<br>即当调用相同函数名时，可以防止一起被调用<br>如果没有设置，则当调用相同类型commit时，会一起被调用</p>
<p>1.对于模块内部的 mutation 和 getter，接收的第一个参数是模块的局部状态对象。<br>2.带命名空间的模块。当模块被注册后，它的所有 getter、action 及 mutation 都会自动根据模块注册的路径调整命名<br>3.对于模块内部的 action，局部状态通过 context.state 暴露出来，根节点状态则为 context.rootState<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">const moduleA = &#123;</span><br><span class="line">  </span><br><span class="line">  namespaced: true,</span><br><span class="line"></span><br><span class="line">  state: &#123; count: 0 &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      // 这里的 `state` 对象是模块的局部状态</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  getters: &#123;</span><br><span class="line">    doubleCount (state) &#123;</span><br><span class="line">      return state.count * 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  actions: &#123;</span><br><span class="line">    incrementIfOddOnRootSum (&#123; state, commit, rootState &#125;) &#123;</span><br><span class="line">      if ((state.count + rootState.count) % 2 === 1) &#123;</span><br><span class="line">        commit(&apos;increment&apos;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更新补充<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">let moduleA = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state()&#123; </span><br><span class="line">    return&#123;</span><br><span class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/aa/getCount&apos;] 作为b子模块时</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter~~~~~&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;,</span><br><span class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</span><br><span class="line">      state.counta++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let moduleB = &#123;</span><br><span class="line">  namespaced: true,</span><br><span class="line">  state: &#123; </span><br><span class="line">    countb: 0,//this.$store.state.b.countb</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/getCount&apos;] 因为设置了namespaced所以可以重名</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter~~~~~&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</span><br><span class="line">      state.countb++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</span><br><span class="line">    aa: moduleA,//this.$store.state.b.aa.counta</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// vuex相关代码</span><br><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123; </span><br><span class="line">    count: 0, //this.$store.state.count</span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    getCount(...args)&#123; //this.$store.getters.getCount</span><br><span class="line">      console.log(args)</span><br><span class="line">      return  &apos;this is a getter&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    a: moduleA, //this.$store.state.a.counta</span><br><span class="line">    b: moduleB //this.$store.state.b.countb</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/src2.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/src2.html" itemprop="url">
                  vue 源码学习二【编译器】
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-05T12:41:15+08:00">
                2020-02-05
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/image/lifecycle.png" alt="Vue声明周期"><br>分析官网的流程图可知<br>new Vue时，进行一系列initxxx初始化工作后会根据选项el和template配置情况去做编译<br>即<br>情况1：挂载了el和template情况下直接去将template编译成渲染函数<br>情况2：挂载了el而没有挂载template情况下，将以el外部的html为template进行编译<br>情况3：没有挂载el的情况下，需要手动调用$mount函数挂载，这时再去判断有没有挂载template，在进行依据template有无继续接下来的编译工作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._init = function (options) &#123;</span><br><span class="line">    var vm = this;</span><br><span class="line">    vm._uid = uid$3++;</span><br><span class="line">    var startTag, endTag;</span><br><span class="line">    vm._isVue = true;  // 防止被监听的标识</span><br><span class="line">    //合并内置选项与传进来的选项</span><br><span class="line">    if (options &amp;&amp; options._isComponent) &#123;</span><br><span class="line">      initInternalComponent(vm, options);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      vm.$options = mergeOptions(</span><br><span class="line">        resolveConstructorOptions(vm.constructor),</span><br><span class="line">        options || &#123;&#125;,</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    /* istanbul ignore else */</span><br><span class="line">    &#123;</span><br><span class="line">      initProxy(vm);</span><br><span class="line">    &#125;</span><br><span class="line">    //进行一系列初始化</span><br><span class="line">    vm._self = vm;</span><br><span class="line">    initLifecycle(vm);</span><br><span class="line">    initEvents(vm);</span><br><span class="line">    initRender(vm);</span><br><span class="line">    callHook(vm, &apos;beforeCreate&apos;);</span><br><span class="line">    initInjections(vm); </span><br><span class="line">    initState(vm);//对数据进行劫持</span><br><span class="line">    initProvide(vm); </span><br><span class="line">    callHook(vm, &apos;created&apos;);</span><br><span class="line"></span><br><span class="line">    if (vm.$options.el) &#123; //判断有没有配置el,有则调用vm.$mount进入情况1和2，没有则进入情况3，等待手动调用vm.$mount</span><br><span class="line">      vm.$mount(vm.$options.el);//生成渲染函数后，给option挂上render，staticRenderFns属性</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="mount挂载函数的巧妙设计"><a href="#mount挂载函数的巧妙设计" class="headerlink" title="$mount挂载函数的巧妙设计"></a>$mount挂载函数的巧妙设计</h1><p>一开始定义的$mount仅用于运行时，功能是将编译好的渲染函数运行实现挂载组件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$mount = function ( </span><br><span class="line">  el,</span><br><span class="line">  hydrating</span><br><span class="line">) &#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : undefined;</span><br><span class="line">  return mountComponent(this, el, hydrating)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>之后会将运行时定义存放到另一个变量<br>方便定义之后包含编译步骤的挂载函数，<br>同时编译运行方案还会调用这个函数<br>这样在打包时，就可以方便的去掉进行编译过程的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var mount = Vue.prototype.$mount;</span><br></pre></td></tr></table></figure></p>
<p>在定义含有编译过程的挂载函数，将template编译成渲染函数<br>再调用运行时$mount(这时依托在mount变量上)，进行挂载组件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$mount = function (</span><br><span class="line">  el,</span><br><span class="line">  hydrating</span><br><span class="line">) &#123;</span><br><span class="line">  el = el &amp;&amp; query(el);//query检查挂载点dom是否存在</span><br><span class="line">  //不要挂载到&lt;body&gt;元素或者&lt;html&gt;元素,</span><br><span class="line">  //因为挂载点的本意是组件挂载的占位，它将会被组件自身的模板替换掉，而&lt;body&gt;元素和&lt;html&gt;元素是不能被替换掉的。</span><br><span class="line">  if (el === document.body || el === document.documentElement) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      &quot;Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.&quot;</span><br><span class="line">    );</span><br><span class="line">    return this</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var options = this.$options;</span><br><span class="line">  // 解析 template/el 转换成render函数</span><br><span class="line">  if (!options.render) &#123;</span><br><span class="line">    var template = options.template;</span><br><span class="line">    if (template) &#123; //配置了template</span><br><span class="line">      if (typeof template === &apos;string&apos;) &#123;</span><br><span class="line">        //如果第一个字符是 #，那么会把该字符串作为 css 选择符</span><br><span class="line">        //去选中对应的元素，并把该元素的 innerHTML 作为模板</span><br><span class="line">        if (template.charAt(0) === &apos;#&apos;) &#123;</span><br><span class="line">          template = idToTemplate(template);</span><br><span class="line">          if (!template) &#123;</span><br><span class="line">            warn((&quot;Template element not found or is empty: &quot; + (options.template)),this);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else if (template.nodeType) &#123; </span><br><span class="line">        //如果第一个字符不是 #，且template的类型是元素节点,</span><br><span class="line">        //那就用 template 自身的字符串值作为模板</span><br><span class="line">        template = template.innerHTML;</span><br><span class="line">      &#125; else &#123;&#123; warn(&apos;invalid template option:&apos; + template, this);&#125;</span><br><span class="line">        //否则报错不存在配置的template</span><br><span class="line">        return this</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (el) &#123; //如果template选项不存在，那么使用el元素的outerHTML作为模板内容</span><br><span class="line">      template = getOuterHTML(el);</span><br><span class="line">    &#125;</span><br><span class="line">    if (template) &#123;</span><br><span class="line">      //编译生成静态结点渲染函数和动态结点渲染函数</span><br><span class="line">      var ref = compileToFunctions(template, &#123;...参数下文有说明&#125;, this);</span><br><span class="line">      var render = ref.render;</span><br><span class="line">      var staticRenderFns = ref.staticRenderFns;</span><br><span class="line">      //生成渲染函数后，给option挂上render，staticRenderFns渲染函数属性</span><br><span class="line">      options.render = render;</span><br><span class="line">      options.staticRenderFns = staticRenderFns;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return mount.call(this, el, hydrating) //调用运行时挂载函数</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1 id="compileToFunctions"><a href="#compileToFunctions" class="headerlink" title="compileToFunctions"></a>compileToFunctions</h1><p>compileToFunctions 作用就两个<br>1.调用compile编译生成渲染函数字符串<br>2.将渲染函数字符串生成渲染函数返回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">function createCompileToFunctionFn (compile) &#123;</span><br><span class="line">  var cache = Object.create(null);</span><br><span class="line">  return function compileToFunctions (template, options,vm) &#123;</span><br><span class="line">    options = extend(&#123;&#125;, options);</span><br><span class="line">    var warn$$1 = options.warn || warn;</span><br><span class="line">    delete options.warn;</span><br><span class="line">      &#123;  //检测 new Function() 是否可用，</span><br><span class="line">         //在某些极端情况下(如CSP限制)给一个有用的提示</span><br><span class="line">        try &#123;new Function(&apos;return 1&apos;);&#125; catch (e) &#123;</span><br><span class="line">          if (e.toString().match(/unsafe-eval|CSP/)) &#123;</span><br><span class="line">            warn$$1(...警告内容);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    // 有缓存直接返回缓存，不用再进行编译一次，</span><br><span class="line">    // cache在闭包父域定义，相当于全局，</span><br><span class="line">    // 所以每次编译的结果都可以缓存起来</span><br><span class="line">    //options.delimiters这个选项是配置纯文本插入分隔符</span><br><span class="line">    //这里用来拼接做缓存key值</span><br><span class="line">    var key = options.delimiters </span><br><span class="line">      ? String(options.delimiters) + template</span><br><span class="line">      : template;</span><br><span class="line">    if (cache[key]) &#123;</span><br><span class="line">      return cache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //调用 baseCompile编译模板并返回其生成的值 </span><br><span class="line">    var compiled = compile(template, options);</span><br><span class="line"></span><br><span class="line">    //将字符串代码转换成函数</span><br><span class="line">    var res = &#123;&#125;;</span><br><span class="line">    var fnGenErrors = [];</span><br><span class="line">    res.render = createFunction(compiled.render, fnGenErrors);</span><br><span class="line">    res.staticRenderFns = compiled.staticRenderFns.map(function (code) &#123;</span><br><span class="line">      return createFunction(code, fnGenErrors)</span><br><span class="line">    &#125;);</span><br><span class="line">    return (cache[key] = res)//缓存字符串模板的编译结果，防止重复编译，提升性能</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>try-catch语句如果有错误发生且错误的内容中<br>包含如 ‘unsafe-eval’ 或者 ‘CSP’ 这些字样的信息时就会给出一个警告</p>
<p>CSP全称Content Security Policy ,可以直接翻译为内容安全策略<br>就是为了页面内容安全而制定的一系列防护策略<br>通过CSP所约束的的规责指定可信的内容来源<br>（这里的内容可以指脚本、图片、iframe、fton、style等等可能的远程的资源）。<br>通过CSP协定，让WEB处于一个安全的运行环境中</p>
<p>如果你的策略比较严格，那么 new Function() 将会受到影响，从而不能够使用<br>但是将模板字符串编译成渲染函数又依赖 new Function()，所以解决方案有两个：<br>1、放宽你的CSP策略<br>2、预编译</p>
<h1 id="一些变量参数说明"><a href="#一些变量参数说明" class="headerlink" title="一些变量参数说明"></a>一些变量参数说明</h1><p>因为之后分析会用到，事先了解一下</p>
<h2 id="变量之间关系"><a href="#变量之间关系" class="headerlink" title="变量之间关系"></a>变量之间关系</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">var modules$1 = [</span><br><span class="line">	klass$1,</span><br><span class="line">	style$1,</span><br><span class="line">	model$1</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var klass$1 = &#123;</span><br><span class="line">	staticKeys: [&apos;staticClass&apos;],</span><br><span class="line">	transformNode: transformNode,</span><br><span class="line">	genData: genData</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var style$1 = &#123;</span><br><span class="line">	staticKeys: [&apos;staticStyle&apos;],</span><br><span class="line">	transformNode: transformNode$1,</span><br><span class="line">	genData: genData$1</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var model$1 = &#123;</span><br><span class="line">	preTransformNode: preTransformNode</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="baseOptions"><a href="#baseOptions" class="headerlink" title="baseOptions"></a>baseOptions</h2><p>baseOptions包含编译器在运作的时候所需的基本配置选项。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var baseOptions = &#123;</span><br><span class="line">  expectHTML: true,</span><br><span class="line">  modules: modules$1,</span><br><span class="line">  directives: directives$1,</span><br><span class="line">  isPreTag: isPreTag,</span><br><span class="line">  isUnaryTag: isUnaryTag,</span><br><span class="line">  mustUseProp: mustUseProp,</span><br><span class="line">  canBeLeftOpenTag: canBeLeftOpenTag,</span><br><span class="line">  isReservedTag: isReservedTag,</span><br><span class="line">  getTagNamespace: getTagNamespace,</span><br><span class="line">  staticKeys: genStaticKeys(modules$1)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>第三个属性：directives 值是三个属性 (model、text、html) 的对象，且属性的值都是函数。<br>第四个属性：isPreTag 它是一个函数，其作用是通过给定的标签名字检查标签是否是 ‘pre’ 标签。<br>第五个属性：isUnaryTag 是一个通过makeMap生成的函数，该函数的作用是检测给定的标签是否是一元标签。<br>第六个属性：mustUseProp 它是一个函数，其作用是用来检测一个属性在标签中是否要使用props进行绑定。<br>第七个属性：canBeLeftOpenTag 一个使用makeMap生成的函数，它的作用是检测非一元标签，但却可以自己补全并闭合的标签。比如 div 标签是一个双标签，你需要这样使用&lt;div&gt; text &lt;/div&gt;，但是你依然可以省略闭合标签，直接这样写：&lt;div&gt; text ，且浏览器会自动补全。但是有些标签你不可以这样用，它们是严格的双标签。<br>第八个属性：isReservedTag 它是一个函数，其作用是检查给定的标签是否是保留的标签。<br>第九个属性：getTagNamespace 它也是一个函数，其作用是获取元素(标签)的命名空间。<br>第十个属性：staticKeys 它的值是通过以 modules 为参数调用 genStaticKeys 函数的返回值得到的。 其作用是根据编译器选项的 modules 选项生成一个静态键字符串。</p>
<h2 id="compileToFunctions传入的参数"><a href="#compileToFunctions传入的参数" class="headerlink" title="compileToFunctions传入的参数"></a>compileToFunctions传入的参数</h2><p>实际调用时<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var ref = compileToFunctions(template, &#123;</span><br><span class="line">  outputSourceRange: &quot;development&quot; !== &apos;production&apos;,</span><br><span class="line">  shouldDecodeNewlines: shouldDecodeNewlines,</span><br><span class="line">  shouldDecodeNewlinesForHref: shouldDecodeNewlinesForHref,</span><br><span class="line">  delimiters: options.delimiters,//更改纯文本插入符</span><br><span class="line">  comments: options.comments//设置为true时，保留且渲染模板HTML注释，false时舍弃注释</span><br><span class="line">&#125;, this);</span><br></pre></td></tr></table></figure></p>
<p>参数说明<br>在我们innerHTML获取内容时，换行符和制表符分别被转换成了&amp;#10和&amp;#9。<br>在IE中，不仅仅是 a 标签的 href 属性值，任何属性值都存在这个问题<br>这就会影响Vue的编译器在对模板进行编译后的结果，为了避免这些问题Vue需要知道什么时候要做兼容工作，<br>如果 shouldDecodeNewlines 为 true，意味着 Vue 在编译模板的时候，要对属性值中的换行符或制表符做兼容处理。<br>而shouldDecodeNewlinesForHref为true 意味着Vue在编译模板的时候，要对a标签的 href 属性值中的换行符或制表符做兼容处理。<br>delimiters和comments都是 Vue 提供的选项，Vue实例的$options属性<br>delimiters代表纯文本插入分隔符<br>comments代表编译时是否保留注释，会在parse阶段进行判断</p>
<h1 id="compiler编译器生成"><a href="#compiler编译器生成" class="headerlink" title="compiler编译器生成"></a>compiler编译器生成</h1><p>compiler的爷爷createCompilerCreator，<br>会生成compiler的爸爸createCompiler<br>createCompiler会生成compiler<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">function createCompilerCreator (baseCompile) &#123;</span><br><span class="line">  return function createCompiler (baseOptions) &#123;</span><br><span class="line">    function compile (</span><br><span class="line">      template,</span><br><span class="line">      options</span><br><span class="line">    ) &#123;</span><br><span class="line">      //所有的配置选项最终都会挂载在这个finalOptions 对象上</span><br><span class="line">      var finalOptions = Object.create(baseOptions);</span><br><span class="line">      var errors = [];</span><br><span class="line">      var tips = [];</span><br><span class="line">      var warn = function (msg, range, tip) &#123; (tip ? tips : errors).push(msg) &#125;;</span><br><span class="line">      //options为调用 compileToFunctions 函数时传递的选项参数。</span><br><span class="line">      //baseOptions理解为编译器的默认选项或者基本选项，options 是用来提供定制能力的扩展选项</span><br><span class="line">      if (options) &#123;</span><br><span class="line">        // merge custom modules</span><br><span class="line">        //如果 options.modules 存在，就在 finalOptions 对象上添加 modules 属性，</span><br><span class="line">        //其值为 baseOptions.modules 和 options.modules 这两个数组合并后的新数组</span><br><span class="line">        if (options.modules) &#123;</span><br><span class="line">          finalOptions.modules =</span><br><span class="line">            (baseOptions.modules || []).concat(options.modules);</span><br><span class="line">        &#125;</span><br><span class="line">        // merge custom directives</span><br><span class="line">        //对于directives 采用原型链的原理实现扩展属性对基本属性的覆盖</span><br><span class="line">        if (options.directives) &#123;</span><br><span class="line">          finalOptions.directives = extend(</span><br><span class="line">            Object.create(baseOptions.directives || null),</span><br><span class="line">            options.directives</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">        // copy other options</span><br><span class="line">        for (var key in options) &#123;</span><br><span class="line">          if (key !== &apos;modules&apos; &amp;&amp; key !== &apos;directives&apos;) &#123;</span><br><span class="line">            finalOptions[key] = options[key];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      finalOptions.warn = warn;</span><br><span class="line"></span><br><span class="line">      var compiled = baseCompile(template.trim(), finalOptions);//调用 baseCompile并返回其生成的值</span><br><span class="line">      &#123;</span><br><span class="line">        detectErrors(compiled.ast, warn);</span><br><span class="line">      &#125;</span><br><span class="line">      compiled.errors = errors;</span><br><span class="line">      compiled.tips = tips;</span><br><span class="line">      return compiled</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      compile: compile,</span><br><span class="line">      compileToFunctions: createCompileToFunctionFn(compile)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>传入实际编译器生成createCompiler<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var createCompiler = createCompilerCreator(function baseCompile (</span><br><span class="line">  template,</span><br><span class="line">  options</span><br><span class="line">) &#123;</span><br><span class="line">  var ast = parse(template.trim(), options);</span><br><span class="line">  if (options.optimize !== false) &#123;</span><br><span class="line">    optimize(ast, options);</span><br><span class="line">  &#125;</span><br><span class="line">  var code = generate(ast, options);</span><br><span class="line">  return &#123;</span><br><span class="line">    ast: ast,</span><br><span class="line">    render: code.render,</span><br><span class="line">    staticRenderFns: code.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">var ref$1 = createCompiler(baseOptions);</span><br><span class="line">var compile = ref$1.compile;</span><br><span class="line">var compileToFunctions = ref$1.compileToFunctions;</span><br></pre></td></tr></table></figure></p>
<p>可见compileToFunctions也由createCompiler函数生成</p>
<p>createCompiler函数 由 createCompilerCreator函数在传入函数 baseCompile 条件下生成</p>
<p>在createCompiler函数中会声明compile函数,在compile中会调用 baseCompile并返回其生成的值</p>
<p>然后对 createCompileToFunctionFn 函数传入compile函数，返回一个函数即compileToFunctions</p>
<p>在compileToFunctions 函数中会调用compile函数并处理其返回值<br>最终生成render和staticRenderFns属性</p>
<p>所以可见在compileToFunctions还是在调用baseCompile来生成render和staticRenderFns属性，<br>现在摘出来主要逻辑<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//base函数</span><br><span class="line">function baseCompile (</span><br><span class="line">  template,</span><br><span class="line">  options</span><br><span class="line">) &#123;</span><br><span class="line">  var ast = parse(template.trim(), options);</span><br><span class="line">  if (options.optimize !== false) &#123;</span><br><span class="line">    optimize(ast, options);</span><br><span class="line">  &#125;</span><br><span class="line">  var code = generate(ast, options);</span><br><span class="line">  return &#123;</span><br><span class="line">    ast: ast,</span><br><span class="line">    render: code.render,</span><br><span class="line">    staticRenderFns: code.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// compileToFunctions调用compile</span><br><span class="line">// 实际调用 baseCompile得到其生成的值</span><br><span class="line">var compiled = compile(template, options);</span><br><span class="line"></span><br><span class="line">// 调用后处理</span><br><span class="line">//将字符串转成函数</span><br><span class="line">var res = &#123;&#125;;</span><br><span class="line">var fnGenErrors = [];</span><br><span class="line">res.render = createFunction(compiled.render, fnGenErrors);</span><br><span class="line">res.staticRenderFns = compiled.staticRenderFns.map(function (code) &#123;</span><br><span class="line">  return createFunction(code, fnGenErrors)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>baseCompile 的主要核心代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var ast =parse(template.trim(), options);</span><br></pre></td></tr></table></figure></p>
<p>parse 会用正则等方式解析 template 模板中的指令、class、style等数据，形成AST。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optimize(ast, options);</span><br></pre></td></tr></table></figure></p>
<p>optimize 的主要作用是标记 static 静态节点，<br>这是 Vue 在编译过程中的一处优化，后面当 update 更新界面时<br>会有一个 patch 的过程， diff 算法会直接跳过静态节点<br>从而减少了比较的过程，优化了 patch 的性能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var code =generate(ast, options);</span><br></pre></td></tr></table></figure></p>
<p>生成目标平台所需的代码，将 AST 转化成 render function 字符串的过程<br>得到结果是 render 的字符串以及 staticRenderFns 字符串。</p>
<h1 id="编译器的基本知识"><a href="#编译器的基本知识" class="headerlink" title="编译器的基本知识"></a>编译器的基本知识</h1><p>编译器的技术分为词法分析、语法分析和语义分析三个部分<br>通常编译器的第一项工作叫做词法分析<br>就像阅读文章一样，文章是由一个个的中文单词组成的<br>程序处理也一样，只不过这里不叫单词，而是叫做“词法记号”，英文叫 Token<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;app&quot; v-if=&quot;ret&quot;&gt;&#123;&#123; message &#125;&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>其实，我们可以手写程序制定一些规则来区分每个不同的 Token，<br>这些规则用“正则文法”表达，符合正则文法的表达式称为“正则表达式”<br>通过他们来完成具体的词法分析工作</p>
<p>编译器下一个阶段的工作是语法分析<br>词法分析是识别一个个的单词，而语法分析就是在词法分析的基础上识别出程序的语法结构<br>这个结构是一个树状结构，是计算机容易理解和执行的<br>程序也要定义良好的语法结构，它的语法分析过程，就是构造这么一棵树<br>一个程序就是一棵树，这棵树叫做抽象语法树（Abstract Syntax Tree，AST)<br>树的每个节点（子树）是一个语法单元，这个单元的构成规则就叫“语法”。</p>
<p>而我们这里要讲的 parser 就是在编译器对源代码处理的第一步<br>parser 把某种特定格式的文本（字符串）转换成某种数据结构的程序(对象)<br>并且这个数据结构是编译器能够理解的<br>因为编译器的后续步骤<br>比如上面提到的 句法分析，类型检查/推导，代码优化，代码生成 等等都依赖于该数据结构</p>
<p><b>注：parse &amp; parser 这两个单词，不要混淆，parse 是动词，代表“解析”的过程，parser 是名词，代表“解析器”。</b><br>Vue 的编译器也不例外, 在词法分析阶段 Vue 会把字符串模板解析成一个个的令牌(token)<br>该令牌将用于句法分析阶段，在句法分析阶段会根据令牌生成一棵 AST<br>最后再根据该 AST生成最终的渲染函数，这样就完成了代码的生成</p>
<h1 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h1><p>进入baseCompile第一步就是调用parse,将HTML转成AST</p>
<h2 id="标签配对原理"><a href="#标签配对原理" class="headerlink" title="标签配对原理"></a>标签配对原理</h2><p>在parse函数和parseHTML函数中都会声明一个stack数组用来存放开始标签<br>parse函数中的stack在传给parseHTML函数中的回调函数中被调用<br>parseHTML函数中的stack在解析开始结束标签时被调用<br>其实两个stack装的结点相同<br>只是parse函数中stack存放的虚拟节点对象是对parseHTML函数中存放的对象做了进一步处理的结果<br>配对原理就是<br>每遇到一个开始标签就push进stack中<br>每遇到一个结尾标签就在stack中找到与该结尾标签tag相同的最近一次push进去的开始标签的位置<br>如果该位置不是在stack最后一位，说明之前解析到的开始标签中存在未闭合的标签，<br>则先将与结束标签相同的开始标签之后的包括开始标签调用parseHTML传入的回调进行闭合，<br>然后通过更改stack长度，直接将开始标签及以后的标签全部pop出stack<br>parseHTML传入的回调会处理parse函数中声明的stack数组</p>
<h2 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h2><p>parse函数中会声明一系列变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">warn$2 = options.warn || baseWarn; //打印警告信息</span><br><span class="line">//一个编译器选项，其作用是通过给定的标签名字判断该标签是否是 pre 标签</span><br><span class="line">platformIsPreTag = options.isPreTag || no;</span><br><span class="line">//一个编译器选项，其作用是用来检测一个属性在标签中是否要使用元素对象原生的 prop 进行绑定</span><br><span class="line">platformMustUseProp = options.mustUseProp || no;</span><br><span class="line">//一个编译器选项，其作用是用来获取元素(标签)的命名空间</span><br><span class="line">platformGetTagNamespace = options.getTagNamespace || no;</span><br><span class="line"></span><br><span class="line">transforms = pluckModuleFunction(options.modules, &apos;transformNode&apos;);</span><br><span class="line">preTransforms = pluckModuleFunction(options.modules, &apos;preTransformNode&apos;);</span><br><span class="line">postTransforms = pluckModuleFunction(options.modules, &apos;postTransformNode&apos;);</span><br><span class="line"></span><br><span class="line">delimiters = options.delimiters;//在创建 Vue 实例对象时所传递的 delimiters 选项</span><br><span class="line">/**存储开始标签，与解析到的闭合标签对比，进行一元标签处理和双标签判断处理**/</span><br><span class="line">var stack = [];</span><br><span class="line">//options.preserveWhitespace 选项用来告诉编译器在编译 html 字符串时是否放弃标签之间的空格</span><br><span class="line">//如果为 true 则代表放弃。</span><br><span class="line">var preserveWhitespace = options.preserveWhitespace !== false;</span><br><span class="line">var whitespaceOption = options.whitespace;</span><br><span class="line">var currentParent;/**维护元素描述对象之间的父子关系，当前节点父元素**/</span><br><span class="line">var inVPre = false;//标识当前解析的标签是否在拥有 v-pre 的标签之内</span><br><span class="line">var inPre = false;//标识当前正在解析的标签是否在 &lt;pre&gt;&lt;/pre&gt; 标签之内</span><br><span class="line">var root;/**存储最终生成的AST**/</span><br></pre></td></tr></table></figure></p>
<h2 id="parseHTML"><a href="#parseHTML" class="headerlink" title="parseHTML"></a>parseHTML</h2><p>parse 函数中会执行parseHTML函数，然后返回root,即AST<br>parseHTML 函数的作用就是用来做词法分析的<br>parse函数的作用则是在词法分析的基础上传入回调，做句法分析从而生成一棵AST<br>被调用时传入参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">  warn: warn$2,</span><br><span class="line">  expectHTML: options.expectHTML,</span><br><span class="line">  isUnaryTag: options.isUnaryTag,</span><br><span class="line">  canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">  shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">  shouldDecodeNewlinesForHref: options.shouldDecodeNewlinesForHref,</span><br><span class="line">  shouldKeepComment: options.comments,//对应配置项comments,true为保留模板中注释语句</span><br><span class="line">  outputSourceRange: options.outputSourceRange,</span><br></pre></td></tr></table></figure></p>
<h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><p> 解析完一段模板的开始标签后的回调<br> 例如：&lt;div id=’jk’ class=’menu’ v-if=’isShow’&gt;&lt;span&gt;123&lt;/span&gt;&lt;/div&gt;<br> 解析完&lt;div id=’jk’ class=’menu’ v-if=’isShow’&gt;的回调函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start: function start (tag, attrs, unary, start$1, end) &#123;</span><br><span class="line">  // check namespace.</span><br><span class="line">  // inherit parent ns if there is one</span><br><span class="line">  var ns = (currentParent &amp;&amp; currentParent.ns) || platformGetTagNamespace(tag);</span><br></pre></td></tr></table></figure></p>
<p>ns 变量，代表标签的命名空间<br>platformGetTagNamespace 函数只会获取 svg 和 math 这两个标签的命名空间<br>但这两个标签的所有子标签都会继承它们两个的命名空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// handle IE svg bug</span><br><span class="line">/* istanbul ignore if */</span><br><span class="line">if (isIE &amp;&amp; ns === &apos;svg&apos;) &#123;</span><br><span class="line">  attrs = guardIESVGBug(attrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里通过isIE来判断宿主环境是不是IE浏览器，并且前元素的命名空间为svg<br>如果是通过guardIESVGBug处理当前元素的属性数组attrs，并使用处理后的结果重新赋值给attrs变量<br>该问题是svg标签中渲染多余的属性，如下svg标签：<br>&lt;svg xmlns:feature=”<a href="http://www.openplans.org/topp&quot;&gt;&lt;/svg" target="_blank" rel="noopener">http://www.openplans.org/topp&quot;&gt;&lt;/svg</a>&gt;<br>被渲染为:<br>&lt;svg xmlns:NS1=”” NS1:xmlns:feature=”<a href="http://www.openplans.org/topp&quot;&quot;&gt;&lt;/svg" target="_blank" rel="noopener">http://www.openplans.org/topp&quot;&quot;&gt;&lt;/svg</a>&gt;<br>标签中多了 ‘xmlns:NS1=”” NS1:’ 这段字符串，解决办法也很简单，将整个多余的字符串去掉即可<br>而 guardIESVGBug 函数就是用来修改NS1:xmlns:feature属性并移除xmlns:NS1=”” 属性的</p>
<p>接着start函数会创建虚拟结点，返回一个描述该标签的对象结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var element = createASTElement(tag, attrs, currentParent); //下文有代码</span><br><span class="line">if (ns) &#123;</span><br><span class="line">  element.ns = ns;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  if (options.outputSourceRange) &#123; //处理虚拟节点占用原模板源码范围</span><br><span class="line">    element.start = start$1;</span><br><span class="line">    element.end = end;</span><br><span class="line">    element.rawAttrsMap = element.attrsList.reduce(function (cumulated, attr) &#123;</span><br><span class="line">      cumulated[attr.name] = attr;</span><br><span class="line">      return cumulated</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  //检查每个属性名是否符合规则</span><br><span class="line">  attrs.forEach(function (attr) &#123;</span><br><span class="line">    if (invalidAttributeRE.test(attr.name)) &#123; </span><br><span class="line">      warn$2(&apos;属性名不能包含空格引号&lt;, &gt;, / 或者 =&apos;,</span><br><span class="line">        &#123;start: attr.start + attr.name.indexOf(&quot;[&quot;),end: attr.start + attr.name.length&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">//是否是不允许的style或者script标签，而且不是在服务端渲染的情况下 isForbiddenTag下文有</span><br><span class="line">if (isForbiddenTag(element) &amp;&amp; !isServerRendering()) &#123; </span><br><span class="line">  element.forbidden = true;</span><br><span class="line">  warn$2(...警告内容，&#123; start: element.start &#125;);</span><br><span class="line">&#125;</span><br><span class="line">for (var i = 0; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">  element = preTransforms[i](element, options) || element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>preTransforms 是通过pluckModuleFunction 函数从options.modules 选项中筛选出名字为preTransformNode 函数所组成的数组<br>实际上 preTransforms 数组中只有一个 preTransformNode 函数该函数只用来处理 input 标签</p>
<p>inVpre 定义在parse函数中，一开始为false<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">if (!inVPre) &#123;</span><br><span class="line">  //解析是否有配置v-pre指令，有的话删除</span><br><span class="line">  //v-pre指令可以跳过这个元素和它的子元素的编译过程。可以用来显示原始 Mustache 标签。</span><br><span class="line">  //跳过大量没有指令的节点会加快编译。</span><br><span class="line">  processPre(element); </span><br><span class="line">  if (element.pre) &#123;</span><br><span class="line">    inVPre = true;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">  inPre = true;</span><br><span class="line">&#125;</span><br><span class="line">if (inVPre) &#123;</span><br><span class="line">  processRawAttrs(element);</span><br><span class="line">&#125; else if (!element.processed) &#123;  // 处理结构指令v-for,v-if,v-once</span><br><span class="line">  //processFor会将解析的结果挂到element上</span><br><span class="line">  //&#123;for:in后面的数组表达式，alias:in前的表达式&#125;</span><br><span class="line">  //解析结果只是对表达式进行解析,in/of前后配置的啥，解析出来</span><br><span class="line">  processFor(element);</span><br><span class="line">  processIf(element);//处理v-if,v-else,v-else-if的表达式</span><br><span class="line">  processOnce(element);//处理v-once指令</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所有process<em> 系列函数的作用都会先拿到解析的配置的值，<br>然后将v-</em>属性从attrsList列表里面移除，只剩下纯html支持的属性<br>将针对v-*属性的解析结果挂到虚拟节点对象上<br>使这个对象能更加详细地描述一个元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (!root) &#123;</span><br><span class="line">  root = element;//root节点没有挂载东西时，挂上，即找到了根节点</span><br><span class="line">  &#123;</span><br><span class="line">    checkRootConstraints(root);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在编写 Vue 模板的时候会受到两种约束<br>首先模板必须有且仅有一个被渲染的根元素<br>第二不能使用 slot 标签和 template 标签作为模板的根元素<br>checkRootConstraints 函数内部首先通过判断el.tag === ‘slot’ || el.tag === ‘template’<br>来判断根元素是否是slot 标签或 template 标签<br>如果是则打印警告信息<br>接着会判断当前元素是否使用了 v-for 指令<br>因为v-for 指令会渲染多个节点所以根元素是不允许使用 v-for 指令的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  //这里的stack是parse函数中定义的stack</span><br><span class="line">  if (!unary) &#123;//非一元标签</span><br><span class="line">    currentParent = element;//确定当前节点即接下来标签的父节点</span><br><span class="line">    stack.push(element);//存入栈中，到时供结束标签判断，前一个标签是一元标签还是最近的开始标签</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    //如果是一元的话，解析结束，调用结束标签函数，该函数在parseHTML函数调用前，parse函数中定义</span><br><span class="line">    closeElement(element);//会建立父子结点关系</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>在解析完开始标签后，回调函数会做以下几件事<br>1.针对ie浏览器对svg和math标签属性做一个兼容性处理<br>2.生成虚拟dom对象<br>3.标识开始标签在原始代码所在的位置<br>4.检查属性命名是否规则<br>5.检查是不是不允许的script和style标签<br>6.处理配置的v-for,v-if,v-once属性<br>7.如果根结点还没有被挂载，则挂载到根结点root上，然后检查是否允许挂到根结点(template,slot,v-for)<br>8.如果是一元标签,解析结束;如果不是，更新当前父元素结点为该虚拟dom,并存入stack,用于配对结束标签</p>
<h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><p>解析完一个结束标签时调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">end: function end (tag, start, end$1) &#123;</span><br><span class="line">  var element = stack[stack.length - 1];</span><br><span class="line">  //每当遇到一个非一元标签的结束标签时，</span><br><span class="line">  //都会回退 currentParent 变量的值为之前的值</span><br><span class="line">  //这样我们就修正了当前正在解析的元素的父级元素</span><br><span class="line">  //在解析兄弟节点时是必须要这样做的</span><br><span class="line">  stack.length -= 1;</span><br><span class="line">  currentParent = stack[stack.length - 1];</span><br><span class="line">  if (options.outputSourceRange) &#123;</span><br><span class="line">    element.end = end$1;</span><br><span class="line">  &#125;</span><br><span class="line">  closeElement(element);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="chars"><a href="#chars" class="headerlink" title="chars"></a>chars</h3><p>解析到一段非标签内容后调用<br>比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>拿到’hello‘这一段后调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">chars: function chars (text, start, end) &#123; </span><br><span class="line">  if (!currentParent) &#123; //一些边界情况处理</span><br><span class="line">    &#123;//没有根元素，只有文本。</span><br><span class="line">      if (text === template) &#123; </span><br><span class="line">        warnOnce(&apos;Component template requires a root element, rather than just text.&apos;,&#123; start: start &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125; else if ((text = text.trim())) &#123; //文本在根元素之外</span><br><span class="line">        warnOnce((&quot;text \&quot;&quot; + text + &quot;\&quot; outside root element will be ignored.&quot;),&#123; start: start &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  //来解决 IE 浏览器中渲染 &lt;textarea&gt; 标签的 placeholder 属性时存在的 bug 的</span><br><span class="line">  if (isIE &amp;&amp; currentParent.tag === &apos;textarea&apos; &amp;&amp; currentParent.attrsMap.placeholder === text</span><br><span class="line">  ) &#123;return&#125;</span><br><span class="line"></span><br><span class="line">  var children = currentParent.children;</span><br><span class="line">  //对空格空行进行删除,编译器只会保留那些 不存在于开始标签之后的空格。</span><br><span class="line">  if (inPre || text.trim()) &#123; </span><br><span class="line">    //isTextTag判断是不是style或者script标签</span><br><span class="line">    //decodeHTMLCached 函数对文本进行解码。</span><br><span class="line">    text = isTextTag(currentParent) ? text : decodeHTMLCached(text);</span><br><span class="line">  &#125; else if (!children.length) &#123;</span><br><span class="line">    text = &apos;&apos;;</span><br><span class="line">  &#125; else if (whitespaceOption) &#123;</span><br><span class="line">    if (whitespaceOption === &apos;condense&apos;) &#123;</span><br><span class="line">      //代码压缩模式下，如果包含换行符，删除这样的空白结点，否则压缩成空格</span><br><span class="line">      text = lineBreakRE.test(text) ? &apos;&apos; : &apos; &apos;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      text = &apos; &apos;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    //preserveWhitespace 是一个布尔值代表着是否保留空格，只有它为真的情况下才会保留空格。</span><br><span class="line">    //但即使preserveWhitespace 常量的值为真，如果当前节点的父节点没有子元素则也不会保留空格，</span><br><span class="line">    text = preserveWhitespace ? &apos; &apos; : &apos;&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">  if (text) &#123;</span><br><span class="line">    if (!inPre &amp;&amp; whitespaceOption === &apos;condense&apos;) &#123;</span><br><span class="line">      //将连续的空格压缩为单个空格</span><br><span class="line">      text = text.replace(whitespaceRE$1, &apos; &apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    var res;</span><br><span class="line">    var child;</span><br><span class="line">    //模板中存在的文本节点包含了 Vue 语法中的字面量表达式，</span><br><span class="line">    //而 parseText 函数的作用就是用来解析这段包含了字面量表达式的文本的</span><br><span class="line">    if (!inVPre &amp;&amp; text !== &apos; &apos; &amp;&amp; (res = parseText(text, delimiters))) &#123;</span><br><span class="line">      //含有表达式或者变量的情况</span><br><span class="line">      //res返回动态变量的描述</span><br><span class="line">      //例&#123;&#123;a&#125;&#125;,返回:&#123;expression: &quot;_s(a)&quot;,tokens: [&#123;@binding: &quot;a&quot;&#125;]</span><br><span class="line">      child = &#123;</span><br><span class="line">        type: 2,</span><br><span class="line">        expression: res.expression,</span><br><span class="line">        tokens: res.tokens,</span><br><span class="line">        text: text</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; else if (text !== &apos; &apos; || !children.length || children[children.length - 1].text !== &apos; &apos;) &#123;</span><br><span class="line">      //纯常量字符串的情况</span><br><span class="line">      child = &#123;</span><br><span class="line">        type: 3,</span><br><span class="line">        text: text</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (child) &#123;</span><br><span class="line">      if (options.outputSourceRange) &#123;</span><br><span class="line">        child.start = start;</span><br><span class="line">        child.end = end;</span><br><span class="line">      &#125;</span><br><span class="line">      children.push(child);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>主要作用就是处理换行符，空格符，<br>然后按照常量字符串和动态字符串分别创建虚拟dom,<br>因为动态字符串需要进行一下解析<br>对虚拟dom挂载在源码中起止位置信息<br>将虚拟dom推入父节点children属性</p>
<h3 id="comments"><a href="#comments" class="headerlink" title="comments"></a>comments</h3><p>针对解析到的注释进行处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  comment: function comment (text, start, end) &#123;</span><br><span class="line">    //只会处理被标签包裹的注释，因为根节点不允许有兄弟结点</span><br><span class="line">    if (currentParent) &#123;</span><br><span class="line">      //普通文本节点与注释节点的元素描述对象的类型是一样的都是 3 ，</span><br><span class="line">      //不同的是注释节点的元素描述对象拥有 isComment 属性，并且该属性的值为 true，</span><br><span class="line">      //目的就是用来与普通文本节点作区分的。</span><br><span class="line">      var child = &#123;</span><br><span class="line">        type: 3,</span><br><span class="line">        text: text,</span><br><span class="line">        isComment: true</span><br><span class="line">      &#125;;</span><br><span class="line">      if (options.outputSourceRange) &#123;</span><br><span class="line">        child.start = start;</span><br><span class="line">        child.end = end;</span><br><span class="line">      &#125;</span><br><span class="line">      currentParent.children.push(child);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="真正的parseHTML"><a href="#真正的parseHTML" class="headerlink" title="真正的parseHTML"></a>真正的parseHTML</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">//解析HTML</span><br><span class="line">function parseHTML (html, options) &#123;</span><br><span class="line">  var stack = [];//在 while 循环中处理 html 字符流的时候每当遇到一个非单标签，都会将该开始标签 push 到该数组。它的作用模板中 DOM 结构规范性的检测</span><br><span class="line">  var expectHTML = options.expectHTML;</span><br><span class="line">  var isUnaryTag$$1 = options.isUnaryTag || no; //用来检测一个标签是否是一元标签</span><br><span class="line">  var canBeLeftOpenTag$$1 = options.canBeLeftOpenTag || no;//用来检测一个标签是否是可以省略闭合标签的非一元标签</span><br><span class="line">  var index = 0; //标识着当前字符流的读入位置</span><br><span class="line">  //last 存储剩余还未编译的 html 字符串</span><br><span class="line">  //lastTag 始终存储着位于 stack 栈顶的元素</span><br><span class="line">  var last, lastTag;</span><br><span class="line">  while (html) &#123;</span><br><span class="line">    last = html; //HTML为待解析的HTML片段，last 保留最原始的片段，advance会在解析过程中切割html</span><br><span class="line">    // 确保没有在script/style纯文本标签里面</span><br><span class="line">    //var isPlainTextElement = makeMap(&apos;script,style,textarea&apos;, true);</span><br><span class="line">    if (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">      var textEnd = html.indexOf(&apos;&lt;&apos;);</span><br><span class="line">      if (textEnd === 0) &#123; //如果以&lt;开头</span><br><span class="line">        // comment = /^&lt;!\--/;如果是以注释开头的</span><br><span class="line">        if (comment.test(html)) &#123; </span><br><span class="line">          var commentEnd = html.indexOf(&apos;--&gt;&apos;); //拿到注释结尾的位置</span><br><span class="line">          if (commentEnd &gt;= 0) &#123; //如果有完整注释</span><br><span class="line">            //根据new vue时传递进来的comments选项值判断是否保留模板中注释</span><br><span class="line">            if (options.shouldKeepComment) &#123;</span><br><span class="line">              //options.comment在parse函数调用parseHTML时传递进来，即回调</span><br><span class="line">              //该函数会将html.substring拿到注释的内容包装成 type:3的节点，</span><br><span class="line">              //然后push进其父节点的children属性</span><br><span class="line">              options.comment(html.substring(4, commentEnd), index, index + commentEnd + 3);</span><br><span class="line">            &#125;</span><br><span class="line">            advance(commentEnd + 3);//裁剪html模板，位移index的值</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 不处理条件注释,直接略过</span><br><span class="line">        if (conditionalComment.test(html)) &#123;</span><br><span class="line">          var conditionalEnd = html.indexOf(&apos;]&gt;&apos;);</span><br><span class="line"></span><br><span class="line">          if (conditionalEnd &gt;= 0) &#123;</span><br><span class="line">            advance(conditionalEnd + 2);</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // var doctype = /^&lt;!DOCTYPE [^&gt;]+&gt;/i;</span><br><span class="line">        //不处理&lt;!DOCTYPE&gt;标签</span><br><span class="line">        var doctypeMatch = html.match(doctype);</span><br><span class="line">        if (doctypeMatch) &#123;</span><br><span class="line">          advance(doctypeMatch[0].length);</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //var endTag = new RegExp((&quot;^&lt;\\/&quot; + qnameCapture + &quot;[^&gt;]*&gt;&quot;)); </span><br><span class="line">        //qnameCapture详见parseStartTag函数</span><br><span class="line">        var endTagMatch = html.match(endTag);</span><br><span class="line">        if (endTagMatch) &#123;</span><br><span class="line">          var curIndex = index;</span><br><span class="line">          advance(endTagMatch[0].length);</span><br><span class="line">          parseEndTag(endTagMatch[1], curIndex, index);//处理stack中开标签/一元标签</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //如果是正常编写的标签(由&lt;&gt;包裹)返回一个描述开始标签的对象</span><br><span class="line">        var startTagMatch = parseStartTag();</span><br><span class="line">        if (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch);</span><br><span class="line">          if (shouldIgnoreFirstNewline(startTagMatch.tagName, html)) &#123;</span><br><span class="line">            advance(1);</span><br><span class="line">          &#125;</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      //处理html非尖括号开头情况,即解析到文本内容的时候</span><br><span class="line">      var text = (void 0), rest = (void 0), next = (void 0);</span><br><span class="line">      if (textEnd &gt;= 0) &#123; //此时html非尖括号开头，但剩下的里面还含有尖括号</span><br><span class="line">        rest = html.slice(textEnd);//截断尖括号以前的内容，拿到剩下的内容</span><br><span class="line">        while ( 第一个尖括号不是开始标签也不是结束或者评论标签</span><br><span class="line">          !endTag.test(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.test(rest) &amp;&amp;</span><br><span class="line">          !comment.test(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.test(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          // 处理文本里的尖括号，直到找到是标签的尖括号的位置，即文本结束的位置</span><br><span class="line">          next = rest.indexOf(&apos;&lt;&apos;, 1);//从第二个字符开始找剩下html里面的第一个尖括号</span><br><span class="line">          if (next &lt; 0) &#123; break &#125; //如果没有，直接结束</span><br><span class="line">          textEnd += next;//如果有的话，重制text结束位置为该尖括号位置</span><br><span class="line">          rest = html.slice(textEnd);//截取html，在判断尖括号是否是标签或者注释</span><br><span class="line">        &#125;//while循环的作用是找出非标签内容</span><br><span class="line">        text = html.substring(0, textEnd);//最终得到非标签内容</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (textEnd &lt; 0) &#123; //html里面没尖括号了</span><br><span class="line">        text = html;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (text) &#123;</span><br><span class="line">        advance(text.length);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (options.chars &amp;&amp; text) &#123;</span><br><span class="line">        options.chars(text, index - text.length, index);//调用回调，处理文本结点</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      //处理textarea内容和结束标签</span><br><span class="line">      var endTagLength = 0;</span><br><span class="line">      var stackedTag = lastTag.toLowerCase();</span><br><span class="line">      var reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = new RegExp(&apos;([\\s\\S]*?)(&lt;/&apos; + stackedTag + &apos;[^&gt;]*&gt;)&apos;, &apos;i&apos;));</span><br><span class="line">      //直接通过end标签拿到标签之间的文本内容，从避免分析中间的尖括号内容，直接保留</span><br><span class="line">      var rest$1 = html.replace(reStackedTag, function (all, text, endTag) &#123;</span><br><span class="line">        endTagLength = endTag.length;</span><br><span class="line">        if (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !== &apos;noscript&apos;) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .replace(/&lt;!\--([\s\S]*?)--&gt;/g, &apos;$1&apos;) // #7298</span><br><span class="line">            .replace(/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g, &apos;$1&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (shouldIgnoreFirstNewline(stackedTag, text)) &#123;</span><br><span class="line">          text = text.slice(1);</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.chars) &#123;</span><br><span class="line">          options.chars(text);</span><br><span class="line">        &#125;</span><br><span class="line">        return &apos;&apos;</span><br><span class="line">      &#125;);</span><br><span class="line">      index += html.length - rest$1.length;</span><br><span class="line">      html = rest$1;</span><br><span class="line">      parseEndTag(stackedTag, index - endTagLength, index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (html === last) &#123;</span><br><span class="line">      options.chars &amp;&amp; options.chars(html);</span><br><span class="line">      if (!stack.length &amp;&amp; options.warn) &#123;</span><br><span class="line">        options.warn((&quot;Mal-formatted tag at end of template: \&quot;&quot; + html + &quot;\&quot;&quot;), &#123; start: index + html.length &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      break</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Clean up any remaining tags</span><br><span class="line">  parseEndTag();</span><br><span class="line"></span><br><span class="line">  function advance (n) &#123;</span><br><span class="line">    index += n;</span><br><span class="line">    html = html.substring(n);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="parseStartTag"><a href="#parseStartTag" class="headerlink" title="parseStartTag"></a>parseStartTag</h4><p>解析开始标签<br>使用unicode为基础的正则startTagOpen匹配html tag<br>unicode会用于比较标签名，组件名以及属性路径<br>var unicodeRegExp = /a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD/;<br>var ncname = “[a-zA-Z_][\-\.0-9_a-zA-Z” + (unicodeRegExp.source) + “]*”;<br>var qnameCapture = “((?:” + ncname + “\:)?” + ncname + “)”;<br>var startTagOpen = new RegExp((“^&lt;” + qnameCapture)); 标签开头正则<br>【正则表达式的source属性是其表达式的字符串形式】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function parseStartTag () &#123;</span><br><span class="line">  var start = html.match(startTagOpen);</span><br><span class="line">  if (start) &#123;</span><br><span class="line">    var match = &#123;</span><br><span class="line">      tagName: start[1],</span><br><span class="line">      attrs: [],//用来存储将来被匹配到的属性</span><br><span class="line">      start: index //初始值为 index，是当前字符流读入位置在整个 html 字符串中的相对位置</span><br><span class="line">    &#125;;</span><br><span class="line">    advance(start[0].length);</span><br><span class="line">    var end, attr;</span><br><span class="line">    //startTagClose = /^\s*(\/?)&gt;/;标签结束正则,只可以匹配&gt;或者/&gt;，或者之前有n个空格</span><br><span class="line">    //attribute = /^\s*([^\s&quot;&apos;&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&apos;([^&apos;]*)&apos;+|([^\s&quot;&apos;=&lt;&gt;`]+)))?/;</span><br><span class="line">    //dynamicArgAttribute = /^\s*((?:v-[\w-]+:|@|:|#)\[[^=]+\][^\s&quot;&apos;&lt;&gt;\/=]*)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&apos;([^&apos;]*)&apos;+|([^\s&quot;&apos;=&lt;&gt;`]+)))?/;</span><br><span class="line">    //dynamicArgAttribute捕获标签上配置的属性push到节点的attr属性里面</span><br><span class="line">    //得到的结果是[&apos;key=val&apos;,&apos;key&apos;,&apos;=&apos;,&apos;val&apos;,]</span><br><span class="line">    //while条件是没有匹配到开始标签的结束部分，并且匹配到了开始标签中的属性，这个时候循环体将被执行，直到遇到开始标签的结束部分为止</span><br><span class="line">    while (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(dynamicArgAttribute) || html.match(attribute))) &#123;</span><br><span class="line">      attr.start = index;</span><br><span class="line">      advance(attr[0].length);</span><br><span class="line">      attr.end = index;</span><br><span class="line">      match.attrs.push(attr);</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;!-- 即使匹配到了开始标签的开始部分以及属性部分但是却没有匹配到开始标签的结束部分，这说明这根本就不是一个开始标签。所以只有当变量end存在，即匹配到了开始标签的结束部分时，才能说明这是一个完整的开始标签 --&gt;</span><br><span class="line">    if (end) &#123;</span><br><span class="line">      match.unarySlash = end[1];//是否是单标签，双标签该值为空字符串，单标签该值为&apos;/&apos;</span><br><span class="line">      advance(end[0].length);//位移一个标签结束符&apos;&gt;&apos;或者&apos;/&gt;&apos;加前面n个空格的距离</span><br><span class="line">      match.end = index;</span><br><span class="line">      return match//一个html双标签的开头标签或者单标签解析完毕</span><br><span class="line">    &#125;</span><br><span class="line">     &lt;!-- 只有当变量end存在时，即能够确定确实解析到了一个开始标签的时候parseStartTag函数才会有返回值，并且返回值是match对象，其他情况下parseStartTag全部返回undefined --&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要作用是<br>1.正则拿到开始标签名<br>2.while循环拿到属性的key-value对象集合，对象中包含该属性在源码中所占的起止位置<br>3.标识是否为一元标签，返回解析结果</p>
<h4 id="handleStartTag"><a href="#handleStartTag" class="headerlink" title="handleStartTag"></a>handleStartTag</h4><p>处理开始标签的解析结果，对上一步结果做进一步处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function handleStartTag (match) &#123;</span><br><span class="line">  var tagName = match.tagName;</span><br><span class="line">  var unarySlash = match.unarySlash;</span><br><span class="line">  //baseOptions中默认设置为true</span><br><span class="line">  if (expectHTML) &#123;</span><br></pre></td></tr></table></figure></p>
<p>如果最近一次遇到的开始标签是 p 标签<br>并且当前正在解析的开始标签必须不能是段落式内容(Phrasing content)模型<br>每一个 html 元素都拥有一个或多个内容模型(content model)<br>其中p 标签本身的内容模型是流式内容(Flow content)<br>并且 p 标签的特性是只允许包含段落式内容(Phrasing content)<br>所以条件成立的情况如下：&lt;p&gt;&lt;h1&gt;&lt;/h1&gt;&lt;/p&gt;<br>在解析上面这段 html 字符串的时候，首先遇到p标签的开始标签，此时lastTag被设置为 p<br>紧接着会遇到 h1 标签的开始标签，由于 h2 标签的内容模型属于非段落式内容(Phrasing content)模型<br>所以会立即调用 parseEndTag(lastTag) 函数闭合 p 标签，此时由于强行插入了&lt;/p&gt; 标签<br>所以解析后的字符串将变为如下内容：&lt;p&gt;&lt;/p&gt;&lt;h2&gt;&lt;/h2&gt;&lt;/p&gt;<br>继续解析该字符串，会遇到 &lt;h2&gt;&lt;/h2&gt;标签并正常解析之<br>最后解析器会遇到一个单独的p 标签的结束标签，即：&lt;/p&gt;<br>这个时候就回到了我们前面讲过的，当解析器遇到 p 标签或者 br 标签的结束标签时会补全他们<br>最终&lt;p&gt;&lt;h2&gt;&lt;/h2&gt;&lt;/p&gt;<br>这段 html 字符串将被解析为：&lt;p&gt;&lt;/p&gt;&lt;h2&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    if (lastTag === &apos;p&apos; &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span><br><span class="line">      parseEndTag(lastTag);//处理结束标签</span><br><span class="line">    &#125;</span><br><span class="line">    //当前正在解析的标签是一个可以省略结束标签的标签，并且与上一次解析到的开始标签相同</span><br><span class="line">    //例&lt;p&gt;max&lt;p&gt;kaixin</span><br><span class="line">    //当解析到一个p标签的开始标签并且下一次遇到的标签也是p标签的开始标签时，会立即关闭第二个p标签。</span><br><span class="line">    //即调用：parseEndTag(tagName) 函数，然后由于第一个p标签缺少闭合标签所以会Vue会给你一个警告。</span><br><span class="line">    if (canBeLeftOpenTag$$1(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">      parseEndTag(tagName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  var unary = isUnaryTag$$1(tagName) || !!unarySlash;//是否是一元标签</span><br><span class="line"></span><br><span class="line">  var l = match.attrs.length;</span><br><span class="line">  var attrs = new Array(l);//整理属性</span><br><span class="line">  for (var i = 0; i &lt; l; i++) &#123; </span><br><span class="line">    var args = match.attrs[i];</span><br><span class="line">    var value = args[3] || args[4] || args[5] || &apos;&apos;;</span><br><span class="line">    //对于a标签是否插入换行编码</span><br><span class="line">    var shouldDecodeNewlines = tagName === &apos;a&apos; &amp;&amp; args[1] === &apos;href&apos; </span><br><span class="line">      ? options.shouldDecodeNewlinesForHref</span><br><span class="line">      : options.shouldDecodeNewlines;</span><br><span class="line">    attrs[i] = &#123;</span><br><span class="line">      name: args[1],</span><br><span class="line">      //decodeAttr 用是对属性值中所包含的 html 实体进行解码，将其转换为实体对应的字符。</span><br><span class="line">      value: decodeAttr(value, shouldDecodeNewlines)</span><br><span class="line">    &#125;;</span><br><span class="line">    if (options.outputSourceRange) &#123;</span><br><span class="line">      attrs[i].start = args.start + args[0].match(/^\s*/).length;</span><br><span class="line">      attrs[i].end = args.end;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //如果开始标签是非一元标签，则将该开始标签的信息入栈，</span><br><span class="line">  //即push到stack数组中，并将lastTag的值设置为该标签名。</span><br><span class="line">  if (!unary) &#123;//这里的stack是parseHTML中定义的stack</span><br><span class="line">    stack.push(&#123; tag: tagName, lowerCasedTag: tagName.toLowerCase(), attrs: attrs, start: match.start, end: match.end &#125;);</span><br><span class="line">    lastTag = tagName;//lastTag 所存储的标签名字始终保存着 stack 栈顶的元素</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (options.start) &#123; 调用配置的开头标签处理函数，是parse函数中传输parseHTML函数的参数</span><br><span class="line">    options.start(tagName, attrs, unary, match.start, match.end);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>作用如下：<br>1.处理p标签闭合情况，以及a标签属性值是否插入换行的处理<br>2.进一步处理属性值结合，将正则得到的数组转成key-value对象<br>3.将节点push到stack中，进行闭合标签配对，设置lastTag为最近一次的开始标签<br>4.调用开始标签回调start</p>
<h4 id="createASTElement"><a href="#createASTElement" class="headerlink" title="createASTElement"></a>createASTElement</h4><p>创建虚拟节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function createASTElement (</span><br><span class="line">  tag,</span><br><span class="line">  attrs,</span><br><span class="line">  parent</span><br><span class="line">) &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    type: 1,</span><br><span class="line">    tag: tag,</span><br><span class="line">    attrsList: attrs,</span><br><span class="line">    attrsMap: makeAttrsMap(attrs),</span><br><span class="line">    rawAttrsMap: &#123;&#125;,</span><br><span class="line">    parent: parent,</span><br><span class="line">    children: []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="parseEndTag"><a href="#parseEndTag" class="headerlink" title="parseEndTag"></a>parseEndTag</h4><p>处理结束标签<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">  function parseEndTag (tagName, start, end) &#123;</span><br><span class="line">    var pos, lowerCasedTagName;</span><br><span class="line">    //当 start 和 end 不存在时，将这两个变量的值设置为当前字符流的读入位置，即index</span><br><span class="line">    //在handleStartTag 函数中调用时会被这样这样调用</span><br><span class="line">    if (start == null) &#123; start = index; &#125;</span><br><span class="line">    if (end == null) &#123; end = index; &#125;</span><br><span class="line">    //找到最近的相同类型的开始标签的位置</span><br><span class="line">    if (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.toLowerCase();</span><br><span class="line">      for (pos = stack.length - 1; pos &gt;= 0; pos--) &#123;</span><br><span class="line">        if (stack[pos].lowerCasedTag === lowerCasedTagName) &#123;</span><br><span class="line">          break</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;//调用 parseEndTag() 函数时不传递任何参数，就处理stack栈中剩余未处理的标签,</span><br><span class="line">      pos = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    //删除最近开始标签 以后的开始标签(可能是一元标签)</span><br><span class="line">    if (pos &gt;= 0) &#123;//检测是否缺少闭合标签</span><br><span class="line">      // Close all the open elements, up the stack</span><br><span class="line">      for (var i = stack.length - 1; i &gt;= pos; i--) &#123;</span><br><span class="line">        if (i &gt; pos || !tagName &amp;&amp; options.warn) &#123;</span><br><span class="line">          //如果发现 stack 数组中存在索引大于 pos 的元素，那么一定有元素是缺少闭合标签的</span><br><span class="line">          options.warn((&quot;tag &lt;&quot; + (stack[i].tag) + &quot;&gt; has no matching end tag.&quot;),&#123; start: stack[i].start, end: stack[i].end &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.end) &#123;</span><br><span class="line">          options.end(stack[i].tag, start, end);//回调parse函数调用时传递进来的回调函数</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      //从stack中删除开标签</span><br><span class="line">      stack.length = pos;</span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - 1].tag;//将lastTag重制为stack栈顶元素</span><br><span class="line">    &#125; else if (lowerCasedTagName === &apos;br&apos;) &#123;</span><br><span class="line">      //为了与浏览器的行为相同，专门处理br与p的结束标签,即：&lt;/br&gt; 和&lt;/p&gt;。</span><br><span class="line">      //&lt;/br&gt; 标签被正常解析为 &lt;br&gt; 标签，而&lt;/p&gt;标签被正常解析为 &lt;p&gt;&lt;/p&gt;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], true, start, end);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (lowerCasedTagName === &apos;p&apos;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], false, start, end);</span><br><span class="line">      &#125;</span><br><span class="line">      if (options.end) &#123;</span><br><span class="line">        options.end(tagName, start, end);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要作用是<br>1.利用stack进行配对，处理stack和lastTag<br>2.特殊处理br和p标签<br>3.调用end回调函数处理父子关系</p>
<h4 id="closeElement"><a href="#closeElement" class="headerlink" title="closeElement"></a>closeElement</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function closeElement(element) &#123;</span><br><span class="line">  trimEndingWhitespace(element);</span><br><span class="line">  if (!inVPre &amp;&amp; !element.processed) &#123;</span><br><span class="line">    //processElement会继续处理element上的属性key,is,inline-template,ref,v-bind,v-on等等,会挂载plain属性供generate创建render函数时使用</span><br><span class="line">    element = processElement(element, options);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>使用 v-if 或 v-else-if 或 v-else 创建多个根结点时<br>v-else-if 或 v-else创建的虚拟节点放到v-if节点的ifconditions属性下面【待验证】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">  if (!stack.length &amp;&amp; element !== root) &#123;</span><br><span class="line">    // allow root elements with v-if, v-else-if and v-else</span><br><span class="line">    if (root.if &amp;&amp; (element.elseif || element.else)) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        checkRootConstraints(element);</span><br><span class="line">      &#125;</span><br><span class="line">      //给root.ifconditions属性push if,elseif,else等条件模板下的虚拟dom对象</span><br><span class="line">      addIfCondition(root, &#123; </span><br><span class="line">        exp: element.elseif,</span><br><span class="line">        block: element</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      warnOnce(</span><br><span class="line">        &quot;Component template should contain exactly one root element. &quot; +</span><br><span class="line">        &quot;If you are using v-if on multiple elements, &quot; +</span><br><span class="line">        &quot;use v-else-if to chain them instead.&quot;,</span><br><span class="line">        &#123; start: element.start &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (currentParent &amp;&amp; !element.forbidden) &#123;</span><br><span class="line">    if (element.elseif || element.else) &#123;</span><br><span class="line">      processIfConditions(element, currentParent);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (element.slotScope) &#123;</span><br><span class="line">        var name = element.slotTarget || &apos;&quot;default&quot;&apos;</span><br><span class="line">        ;(currentParent.scopedSlots || (currentParent.scopedSlots = &#123;&#125;))[name] = element;</span><br><span class="line">      &#125;</span><br><span class="line">      //这样就建立了元素描述对象间的父子级关系。</span><br><span class="line">      currentParent.children.push(element);</span><br><span class="line">      element.parent = currentParent;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  element.children = element.children.filter(function (c) &#123; return !(c).slotScope; &#125;);</span><br><span class="line">  trimEndingWhitespace(element);</span><br><span class="line">  if (element.pre) &#123;</span><br><span class="line">    inVPre = false;</span><br><span class="line">  &#125;</span><br><span class="line">  if (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">    inPre = false;</span><br><span class="line">  &#125;</span><br><span class="line">  for (var i = 0; i &lt; postTransforms.length; i++) &#123;</span><br><span class="line">    postTransforms[i](element, options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要作用是<br>1.处理条件渲染节点关系<br>2.建立父子结点关系</p>
<h4 id="isForbiddenTag"><a href="#isForbiddenTag" class="headerlink" title="isForbiddenTag"></a>isForbiddenTag</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function isForbiddenTag(el) &#123;</span><br><span class="line">	return (</span><br><span class="line">		el.tag === &apos;style&apos; ||</span><br><span class="line">		(el.tag === &apos;script&apos; &amp;&amp; (</span><br><span class="line">			!el.attrsMap.type ||</span><br><span class="line">			el.attrsMap.type === &apos;text/javascript&apos;</span><br><span class="line">		))</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="optimize"><a href="#optimize" class="headerlink" title="optimize"></a>optimize</h1><p>通过两个递归函数给结点挂载static和staticRoot两个属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">function optimize (root, options) &#123;</span><br><span class="line">  if (!root) &#123; return &#125;</span><br><span class="line">  isStaticKey = genStaticKeysCached(options.staticKeys || &apos;&apos;);</span><br><span class="line">  isPlatformReservedTag = options.isReservedTag || no;</span><br><span class="line">  // first pass: mark all non-static nodes.</span><br><span class="line">  markStatic$1(root);</span><br><span class="line">  // second pass: mark static roots.</span><br><span class="line">  markStaticRoots(root, false);</span><br><span class="line">&#125;</span><br><span class="line">//判断结点是否为静态结点</span><br><span class="line">function isStatic (node) &#123;</span><br><span class="line">    if (node.type === 2) &#123; // expression</span><br><span class="line">      return false</span><br><span class="line">    &#125;</span><br><span class="line">    if (node.type === 3) &#123; // text</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line">    return !!(node.pre || (</span><br><span class="line">      !node.hasBindings &amp;&amp; // no dynamic bindings</span><br><span class="line">      !node.if &amp;&amp; !node.for &amp;&amp; // not v-if or v-for or v-else</span><br><span class="line">      !isBuiltInTag(node.tag) &amp;&amp; // not a built-in</span><br><span class="line">      isPlatformReservedTag(node.tag) &amp;&amp; // not a component</span><br><span class="line">      !isDirectChildOfTemplateFor(node) &amp;&amp;</span><br><span class="line">      Object.keys(node).every(isStaticKey)</span><br><span class="line">    ))</span><br><span class="line">  &#125;</span><br><span class="line">function markStatic$1 (node) &#123;</span><br><span class="line">    node.static = isStatic(node);</span><br><span class="line">    if (node.type === 1) &#123;</span><br><span class="line">      // do not make component slot content static. this avoids</span><br><span class="line">      // 1. components not able to mutate slot nodes</span><br><span class="line">      // 2. static slot content fails for hot-reloading</span><br><span class="line">      if (</span><br><span class="line">        !isPlatformReservedTag(node.tag) &amp;&amp;</span><br><span class="line">        node.tag !== &apos;slot&apos; &amp;&amp;</span><br><span class="line">        node.attrsMap[&apos;inline-template&apos;] == null</span><br><span class="line">      ) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      for (var i = 0, l = node.children.length; i &lt; l; i++) &#123;</span><br><span class="line">        var child = node.children[i];</span><br><span class="line">        markStatic$1(child);</span><br><span class="line">        if (!child.static) &#123;//子节点一但为动态结点，则父节点为动态结点</span><br><span class="line">          node.static = false;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (node.ifConditions) &#123; //处理条件渲染节点是否为静态结点</span><br><span class="line">        for (var i$1 = 1, l$1 = node.ifConditions.length; i$1 &lt; l$1; i$1++) &#123;</span><br><span class="line">          var block = node.ifConditions[i$1].block;</span><br><span class="line">          markStatic$1(block);</span><br><span class="line">          if (!block.static) &#123;</span><br><span class="line">            node.static = false;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function markStaticRoots (node, isInFor) &#123;</span><br><span class="line">    if (node.type === 1) &#123;</span><br><span class="line">      if (node.static || node.once) &#123;</span><br><span class="line">        node.staticInFor = isInFor;</span><br><span class="line">      &#125;</span><br><span class="line">      //对只含有一个纯文本结点的node添加staticRoot = false</span><br><span class="line">      //否则staticRoot = true</span><br><span class="line">      if (node.static &amp;&amp; node.children.length &amp;&amp; !(</span><br><span class="line">        node.children.length === 1 &amp;&amp;</span><br><span class="line">        node.children[0].type === 3</span><br><span class="line">      )) &#123;</span><br><span class="line">        node.staticRoot = true;</span><br><span class="line">        return</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        node.staticRoot = false;</span><br><span class="line">      &#125;</span><br><span class="line">      if (node.children) &#123;</span><br><span class="line">        for (var i = 0, l = node.children.length; i &lt; l; i++) &#123;</span><br><span class="line">          markStaticRoots(node.children[i], isInFor || !!node.for);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (node.ifConditions) &#123;</span><br><span class="line">        for (var i$1 = 1, l$1 = node.ifConditions.length; i$1 &lt; l$1; i$1++) &#123;</span><br><span class="line">          markStaticRoots(node.ifConditions[i$1].block, isInFor);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>主要处理思想就是<br>子节点一旦为动态结点，则父节点为动态结点, static = false<br>只含有一个纯文本结点的node,没有其他子节点，staticRoot = false</p>
<h1 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function generate (</span><br><span class="line">    ast,</span><br><span class="line">    options</span><br><span class="line">  ) &#123;</span><br><span class="line">    var state = new CodegenState(options);</span><br><span class="line">    var code = ast ? genElement(ast, state) : &apos;_c(&quot;div&quot;)&apos;;</span><br><span class="line">    return &#123;</span><br><span class="line">      render: (&quot;with(this)&#123;return &quot; + code + &quot;&#125;&quot;),</span><br><span class="line">      staticRenderFns: state.staticRenderFns</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="CodegenState"><a href="#CodegenState" class="headerlink" title="CodegenState"></a>CodegenState</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var CodegenState = function CodegenState (options) &#123;</span><br><span class="line">    this.options = options;</span><br><span class="line">    this.warn = options.warn || baseWarn;</span><br><span class="line">    this.transforms = pluckModuleFunction(options.modules, &apos;transformCode&apos;);</span><br><span class="line">    this.dataGenFns = pluckModuleFunction(options.modules, &apos;genData&apos;);</span><br><span class="line">    this.directives = extend(extend(&#123;&#125;, baseDirectives), options.directives);</span><br><span class="line">    var isReservedTag = options.isReservedTag || no;</span><br><span class="line">    this.maybeComponent = function (el) &#123; return !!el.component || !isReservedTag(el.tag); &#125;;</span><br><span class="line">    this.onceId = 0;</span><br><span class="line">    this.staticRenderFns = [];</span><br><span class="line">    this.pre = false;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="genElement"><a href="#genElement" class="headerlink" title="genElement"></a>genElement</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">function genElement (el, state) &#123;</span><br><span class="line">  if (el.parent) &#123;</span><br><span class="line">    el.pre = el.pre || el.parent.pre;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (el.staticRoot &amp;&amp; !el.staticProcessed) &#123;</span><br><span class="line">    return genStatic(el, state)</span><br><span class="line">  &#125; else if (el.once &amp;&amp; !el.onceProcessed) &#123;</span><br><span class="line">    return genOnce(el, state)</span><br><span class="line">  &#125; else if (el.for &amp;&amp; !el.forProcessed) &#123;</span><br><span class="line">    return genFor(el, state)</span><br><span class="line">  &#125; else if (el.if &amp;&amp; !el.ifProcessed) &#123;</span><br><span class="line">    return genIf(el, state)</span><br><span class="line">  &#125; else if (el.tag === &apos;template&apos; &amp;&amp; !el.slotTarget &amp;&amp; !state.pre) &#123;</span><br><span class="line">    return genChildren(el, state) || &apos;void 0&apos;</span><br><span class="line">  &#125; else if (el.tag === &apos;slot&apos;) &#123;</span><br><span class="line">    return genSlot(el, state)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    var code;</span><br><span class="line">    if (el.component) &#123;</span><br><span class="line">      code = genComponent(elp.comonent, el, state);</span><br><span class="line">    &#125; else &#123;//普通标签情况</span><br><span class="line">      var data;</span><br><span class="line">      //在processElement函数中</span><br><span class="line">      // el.plain = !el.key &amp;&amp;!el.scopedSlots &amp;&amp; !el.attrsList.length</span><br><span class="line">      // v-pre 可以跳过编译</span><br><span class="line">      if (!el.plain || (el.pre &amp;&amp; state.maybeComponent(el))) &#123;</span><br><span class="line">        data = genData$2(el, state);//拼接el标签上配置的内容</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var children = el.inlineTemplate ? null : genChildren(el, state, true);</span><br><span class="line">      code = &quot;_c(&apos;&quot; + (el.tag) + &quot;&apos;&quot; + (data ? (&quot;,&quot; + data) : &apos;&apos;) + (children ? (&quot;,&quot; + children) : &apos;&apos;) + &quot;)&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    for (var i = 0; i &lt; state.transforms.length; i++) &#123;</span><br><span class="line">      code = state.transforms[i](el, code);</span><br><span class="line">    &#125;</span><br><span class="line">    return code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="genData-2"><a href="#genData-2" class="headerlink" title="genData$2"></a>genData$2</h3><p>genData$2 生成el标签上配置的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">function genData$2 (el, state) &#123;</span><br><span class="line">  var data = &apos;&#123;&apos;;</span><br><span class="line">  //优先处理指令，因为指令可能会影响其他属性</span><br><span class="line">  //很重要这个步骤很重要，会给input等存在交互的标签因为v-model绑定响应事件</span><br><span class="line">  //genDirectives下文有详解</span><br><span class="line">  var dirs = genDirectives(el, state);</span><br><span class="line">  if (dirs) &#123; data += dirs + &apos;,&apos;; &#125;</span><br><span class="line"></span><br><span class="line">  // key</span><br><span class="line">  if (el.key) &#123;</span><br><span class="line">    data += &quot;key:&quot; + (el.key) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // ref</span><br><span class="line">  if (el.ref) &#123;</span><br><span class="line">    data += &quot;ref:&quot; + (el.ref) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  if (el.refInFor) &#123;</span><br><span class="line">    data += &quot;refInFor:true,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // pre</span><br><span class="line">  if (el.pre) &#123;</span><br><span class="line">    data += &quot;pre:true,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // record original tag name for components using &quot;is&quot; attribute</span><br><span class="line">  if (el.component) &#123;</span><br><span class="line">    data += &quot;tag:\&quot;&quot; + (el.tag) + &quot;\&quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // module data generation functions</span><br><span class="line">  for (var i = 0; i &lt; state.dataGenFns.length; i++) &#123;</span><br><span class="line">    data += state.dataGenFns[i](el);</span><br><span class="line">  &#125;</span><br><span class="line">  // attributes</span><br><span class="line">  if (el.attrs) &#123;</span><br><span class="line">    data += &quot;attrs:&quot; + (genProps(el.attrs)) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // DOM props</span><br><span class="line">  if (el.props) &#123;</span><br><span class="line">    data += &quot;domProps:&quot; + (genProps(el.props)) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // event handlers</span><br><span class="line">  if (el.events) &#123;</span><br><span class="line">    data += (genHandlers(el.events, false)) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  if (el.nativeEvents) &#123;</span><br><span class="line">    data += (genHandlers(el.nativeEvents, true)) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // slot target</span><br><span class="line">  // only for non-scoped slots</span><br><span class="line">  if (el.slotTarget &amp;&amp; !el.slotScope) &#123;</span><br><span class="line">    data += &quot;slot:&quot; + (el.slotTarget) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // scoped slots</span><br><span class="line">  if (el.scopedSlots) &#123;</span><br><span class="line">    data += (genScopedSlots(el, el.scopedSlots, state)) + &quot;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // component v-model</span><br><span class="line">  if (el.model) &#123;</span><br><span class="line">    data += &quot;model:&#123;value:&quot; + (el.model.value) + &quot;,callback:&quot; + (el.model.callback) + &quot;,expression:&quot; + (el.model.expression) + &quot;&#125;,&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // inline-template</span><br><span class="line">  if (el.inlineTemplate) &#123;</span><br><span class="line">    var inlineTemplate = genInlineTemplate(el, state);</span><br><span class="line">    if (inlineTemplate) &#123;</span><br><span class="line">      data += inlineTemplate + &quot;,&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data = data.replace(/,$/, &apos;&apos;) + &apos;&#125;&apos;;</span><br><span class="line">  // v-bind dynamic argument wrap</span><br><span class="line">  // v-bind with dynamic arguments must be applied using the same v-bind object</span><br><span class="line">  // merge helper so that class/style/mustUseProp attrs are handled correctly.</span><br><span class="line">  if (el.dynamicAttrs) &#123;</span><br><span class="line">    data = &quot;_b(&quot; + data + &quot;,\&quot;&quot; + (el.tag) + &quot;\&quot;,&quot; + (genProps(el.dynamicAttrs)) + &quot;)&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  // v-bind data wrap</span><br><span class="line">  if (el.wrapData) &#123;</span><br><span class="line">    data = el.wrapData(data);</span><br><span class="line">  &#125;</span><br><span class="line">  // v-on data wrap</span><br><span class="line">  if (el.wrapListeners) &#123;</span><br><span class="line">    data = el.wrapListeners(data);</span><br><span class="line">  &#125;</span><br><span class="line">  return data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="genDirectives"><a href="#genDirectives" class="headerlink" title="genDirectives"></a>genDirectives</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">function genDirectives (el, state) &#123;</span><br><span class="line">  var dirs = el.directives;</span><br><span class="line">  if (!dirs) &#123; return &#125;</span><br><span class="line">  var res = &apos;directives:[&apos;;</span><br><span class="line">  var hasRuntime = false;</span><br><span class="line">  var i, l, dir, needRuntime;</span><br><span class="line">  for (i = 0, l = dirs.length; i &lt; l; i++) &#123;</span><br><span class="line">    dir = dirs[i];</span><br><span class="line">    needRuntime = true;</span><br><span class="line">    var gen = state.directives[dir.name];</span><br><span class="line">    if (gen) &#123;</span><br><span class="line">      // 处理ast里面的编译时指令</span><br><span class="line">      // 如果还需要运行时副本，则返回true</span><br><span class="line">      needRuntime = !!gen(el, dir, state.warn);</span><br><span class="line">    &#125;</span><br><span class="line">    if (needRuntime) &#123;</span><br><span class="line">      hasRuntime = true;</span><br><span class="line">      res += &quot;&#123;name:\&quot;&quot; + (dir.name) + &quot;\&quot;,rawName:\&quot;&quot; + (dir.rawName) + &quot;\&quot;&quot; + (dir.value ? (&quot;,value:(&quot; + (dir.value) + &quot;),expression:&quot; + (JSON.stringify(dir.value))) : &apos;&apos;) + (dir.arg ? (&quot;,arg:&quot; + (dir.isDynamicArg ? dir.arg : (&quot;\&quot;&quot; + (dir.arg) + &quot;\&quot;&quot;))) : &apos;&apos;) + (dir.modifiers ? (&quot;,modifiers:&quot; + (JSON.stringify(dir.modifiers))) : &apos;&apos;) + &quot;&#125;,&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (hasRuntime) &#123;</span><br><span class="line">    return res.slice(0, -1) + &apos;]&apos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="el-directives"><a href="#el-directives" class="headerlink" title="el.directives"></a>el.directives</h5><p>el.directives属性在closeElement—&gt;processElement—&gt;processAttrs<br>函数调用流程中被挂载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">function processAttrs (el) &#123;</span><br><span class="line">    var list = el.attrsList;</span><br><span class="line">    var i, l, name, rawName, value, modifiers, syncGen, isDynamic;</span><br><span class="line">    for (i = 0, l = list.length; i &lt; l; i++) &#123;</span><br><span class="line">      name = rawName = list[i].name;</span><br><span class="line">      value = list[i].value;</span><br><span class="line">      if (dirRE.test(name)) &#123; // var dirRE = /^v-|^@|^:|^#/;</span><br><span class="line">        el.hasBindings = true;</span><br><span class="line">        if (bindRE.test(name)) &#123; ...// v-bind</span><br><span class="line">        &#125; else if (onRE.test(name)) &#123;... // v-on</span><br><span class="line">        &#125; else &#123; // normal directives</span><br><span class="line">          name = name.replace(dirRE, &apos;&apos;);</span><br><span class="line">          var argMatch = name.match(argRE);</span><br><span class="line">          var arg = argMatch &amp;&amp; argMatch[1];</span><br><span class="line">          isDynamic = false;</span><br><span class="line">          if (arg) &#123;</span><br><span class="line">            name = name.slice(0, -(arg.length + 1));</span><br><span class="line">            if (dynamicArgRE.test(arg)) &#123;</span><br><span class="line">              arg = arg.slice(1, -1);</span><br><span class="line">              isDynamic = true;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          addDirective(el, name, rawName, value, arg, isDynamic, modifiers, list[i]);</span><br><span class="line">          if (name === &apos;model&apos;) &#123;</span><br><span class="line">            checkForAliasModel(el, value);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;....&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">function addDirective (el,name,rawName,value,arg,isDynamicArg,modifiers,range) &#123;</span><br><span class="line">  (el.directives || (el.directives = [])).push(rangeSetItem(&#123;</span><br><span class="line">    name: name,</span><br><span class="line">    rawName: rawName,</span><br><span class="line">    value: value,</span><br><span class="line">    arg: arg,</span><br><span class="line">    isDynamicArg: isDynamicArg,</span><br><span class="line">    modifiers: modifiers</span><br><span class="line">  &#125;, range));</span><br><span class="line">  el.plain = false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h5><p>假如现在标签为&lt;input v-model=’a’ &gt;<br>那么现在的el.directives=[{name: “model”,rawName: “v-model”,value: “a”,isDynamicArg: false,start: 106,end: 117,modifiers:undefined}]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">var gen = state.directives[dir.name];</span><br><span class="line">---&gt;</span><br><span class="line">state = new CodegenState()</span><br><span class="line">---&gt;</span><br><span class="line">var CodegenState = function CodegenState (options) &#123;</span><br><span class="line">  this.directives = extend(extend(&#123;&#125;, baseDirectives), options.directives);</span><br><span class="line">&#125;</span><br><span class="line">---&gt;</span><br><span class="line">options (finalOptions = Object.create(baseOptions);---&gt;baseCompile()---&gt;generate())</span><br><span class="line">---&gt;</span><br><span class="line">var baseOptions = &#123;</span><br><span class="line">    directives: directives$1,</span><br><span class="line">&#125;</span><br><span class="line">---&gt;</span><br><span class="line">directives$1 = &#123;</span><br><span class="line">  model: model,</span><br><span class="line">  text: text,</span><br><span class="line">  html: html</span><br><span class="line">&#125;;</span><br><span class="line">---&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">state.directives = directives$1</span><br><span class="line">state.directives[el.directives[0].name] ===&gt;model</span><br></pre></td></tr></table></figure></p>
<p>针对不同标签处理双向绑定，添加相应事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function model (el,dir,_warn) &#123;</span><br><span class="line">  warn$1 = _warn;</span><br><span class="line">  var value = dir.value;</span><br><span class="line">  var modifiers = dir.modifiers;</span><br><span class="line">  var tag = el.tag;</span><br><span class="line">  var type = el.attrsMap.type;</span><br><span class="line">  &#123;if (tag === &apos;input&apos; &amp;&amp; type === &apos;file&apos;) &#123;warn$1(....);&#125;&#125;</span><br><span class="line"></span><br><span class="line">  if (el.component) &#123;</span><br><span class="line">    genComponentModel(el, value, modifiers);</span><br><span class="line">    return false</span><br><span class="line">  &#125; else if (tag === &apos;select&apos;) &#123;</span><br><span class="line">    genSelect(el, value, modifiers);</span><br><span class="line">  &#125; else if (tag === &apos;input&apos; &amp;&amp; type === &apos;checkbox&apos;) &#123;</span><br><span class="line">    genCheckboxModel(el, value, modifiers);</span><br><span class="line">  &#125; else if (tag === &apos;input&apos; &amp;&amp; type === &apos;radio&apos;) &#123;</span><br><span class="line">    genRadioModel(el, value, modifiers);</span><br><span class="line">  &#125; else if (tag === &apos;input&apos; || tag === &apos;textarea&apos;) &#123;</span><br><span class="line">    genDefaultModel(el, value, modifiers);</span><br><span class="line">  &#125; else if (!config.isReservedTag(tag)) &#123;</span><br><span class="line">    genComponentModel(el, value, modifiers);</span><br><span class="line">    // component v-model doesn&apos;t need extra runtime</span><br><span class="line">    return false</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    warn$1(...);</span><br><span class="line">  &#125;</span><br><span class="line">  return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>针对input 的v-model绑定input事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">function genDefaultModel (</span><br><span class="line">    el,</span><br><span class="line">    value,</span><br><span class="line">    modifiers</span><br><span class="line">  ) &#123;</span><br><span class="line">    var type = el.attrsMap.type;</span><br><span class="line"></span><br><span class="line">    var ref = modifiers || &#123;&#125;;</span><br><span class="line">    var lazy = ref.lazy;</span><br><span class="line">    var number = ref.number;</span><br><span class="line">    var trim = ref.trim;</span><br><span class="line">    var needCompositionGuard = !lazy &amp;&amp; type !== &apos;range&apos;;</span><br><span class="line">    var event = lazy</span><br><span class="line">      ? &apos;change&apos;</span><br><span class="line">      : type === &apos;range&apos;</span><br><span class="line">        ? RANGE_TOKEN</span><br><span class="line">        : &apos;input&apos;; //默认input事件触发双向绑定</span><br><span class="line"></span><br><span class="line">    var valueExpression = &apos;$event.target.value&apos;;</span><br><span class="line">    if (trim) &#123;</span><br><span class="line">      valueExpression = &quot;$event.target.value.trim()&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (number) &#123;</span><br><span class="line">      valueExpression = &quot;_n(&quot; + valueExpression + &quot;)&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">     //input事件响应函数字符串形式</span><br><span class="line">    var code = genAssignmentCode(value, valueExpression);</span><br><span class="line">    if (needCompositionGuard) &#123;</span><br><span class="line">      code = &quot;if($event.target.composing)return;&quot; + code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addProp(el, &apos;value&apos;, (&quot;(&quot; + value + &quot;)&quot;));</span><br><span class="line">    addHandler(el, event, code, null, true); //addHandler函数给el绑定events属性</span><br><span class="line">    if (trim || number) &#123;</span><br><span class="line">      addHandler(el, &apos;blur&apos;, &apos;$forceUpdate()&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>$event.target.composing是vue自己添加的属性，用于控制在输入中日韩这类语言时<br>确定一个字或词输入完成后再更新绑定值，而不是每次输入一个字母就更新一次绑定值</p>
<h3 id="genChildren"><a href="#genChildren" class="headerlink" title="genChildren"></a>genChildren</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var children = el.inlineTemplate ? null : genChildren(el, state, true);</span><br></pre></td></tr></table></figure>
<p>genElement函数中组建完本身标签内容后，会继续组建子标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">function genChildren (</span><br><span class="line">    el,</span><br><span class="line">    state,</span><br><span class="line">    checkSkip,</span><br><span class="line">    altGenElement,</span><br><span class="line">    altGenNode</span><br><span class="line">  ) &#123;</span><br><span class="line">    var children = el.children;</span><br><span class="line">    if (children.length) &#123;</span><br><span class="line">      var el$1 = children[0];</span><br><span class="line">      // optimize single v-for</span><br><span class="line">      if (children.length === 1 &amp;&amp;</span><br><span class="line">        el$1.for &amp;&amp;</span><br><span class="line">        el$1.tag !== &apos;template&apos; &amp;&amp;</span><br><span class="line">        el$1.tag !== &apos;slot&apos;</span><br><span class="line">      ) &#123;</span><br><span class="line">        var normalizationType = checkSkip</span><br><span class="line">          ? state.maybeComponent(el$1) ? &quot;,1&quot; : &quot;,0&quot;</span><br><span class="line">          : &quot;&quot;;</span><br><span class="line">        return (&quot;&quot; + ((altGenElement || genElement)(el$1, state)) + normalizationType)</span><br><span class="line">      &#125;</span><br><span class="line">      var normalizationType$1 = checkSkip</span><br><span class="line">        ? getNormalizationType(children, state.maybeComponent)</span><br><span class="line">        : 0;</span><br><span class="line">      var gen = altGenNode || genNode;</span><br><span class="line">      return (&quot;[&quot; + (children.map(function (c) &#123; return gen(c, state); &#125;).join(&apos;,&apos;)) + &quot;]&quot; + (normalizationType$1 ? (&quot;,&quot; + normalizationType$1) : &apos;&apos;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">function genNode (node, state) &#123;</span><br><span class="line">  if (node.type === 1) &#123;</span><br><span class="line">    return genElement(node, state)</span><br><span class="line">  &#125; else if (node.type === 3 &amp;&amp; node.isComment) &#123;</span><br><span class="line">    return genComment(node)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return genText(node)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>genChildren函数会循环父标签的的children属性生成每个子标签的渲染函数字符串，<br>以数组字符串形式返回给父标签的_c函数，用作参数</p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>假如html内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id = &apos;app&apos; class=&apos;hello&apos;&gt;</span><br><span class="line">  &lt;p &gt;&#123;&#123;a+&apos;...&apos;+arr[0]&#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;input class=&quot;kk&quot; key=&apos;kkk&apos; ref=&apos;hellodiv&apos; v-model=&apos;a&apos; @input=&apos;search&apos;/&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>那么generate函数返回的render值如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;with(this)&#123;return _c(&apos;div&apos;,&#123;staticClass:&quot;hello&quot;,attrs:&#123;&quot;id&quot;:&quot;app&quot;&#125;&#125;,[_c(&apos;p&apos;,[_v(_s(a+&apos;...&apos;+arr[0]))]),_v(&quot; &quot;),_c(&apos;input&apos;,&#123;directives:[&#123;name:&quot;model&quot;,rawName:&quot;v-model&quot;,value:(a),expression:&quot;a&quot;&#125;],key:&quot;kkk&quot;,ref:&quot;hellodiv&quot;,staticClass:&quot;kk&quot;,domProps:&#123;&quot;value&quot;:(a)&#125;,on:&#123;&quot;input&quot;:[function($event)&#123;if($event.target.composing)return;a=$event.target.value&#125;,search]&#125;&#125;)])&#125;&quot;</span><br></pre></td></tr></table></figure></p>
<p>可见，generate函数只是将parse和optimize处理得到的标签描述对象ast整理成函数参数<br>交由不同类型的可以生成vnode对象的处理函数，整个函数，由字符串拼接形成<br>整个函数字符串会在compileToFunctions函数中调用createFunction转化为真正的函数对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function createFunction (code, errors) &#123;</span><br><span class="line">   try &#123;</span><br><span class="line">     return new Function(code)</span><br><span class="line">   &#125; catch (err) &#123;</span><br><span class="line">     errors.push(&#123; err: err, code: code &#125;);</span><br><span class="line">     return noop</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="渲染函数字符串中的函数缩写"><a href="#渲染函数字符串中的函数缩写" class="headerlink" title="渲染函数字符串中的函数缩写"></a>渲染函数字符串中的函数缩写</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function installRenderHelpers (target) &#123;</span><br><span class="line">    target._o = markOnce;</span><br><span class="line">    target._n = toNumber;</span><br><span class="line">    target._s = toString;</span><br><span class="line">    target._l = renderList;//v-for</span><br><span class="line">    target._t = renderSlot;</span><br><span class="line">    target._q = looseEqual;</span><br><span class="line">    target._i = looseIndexOf;</span><br><span class="line">    target._m = renderStatic;</span><br><span class="line">    target._f = resolveFilter;</span><br><span class="line">    target._k = checkKeyCodes;</span><br><span class="line">    target._b = bindObjectProps;</span><br><span class="line">    target._v = createTextVNode;</span><br><span class="line">    target._e = createEmptyVNode;</span><br><span class="line">    target._u = resolveScopedSlots;</span><br><span class="line">    target._g = bindObjectListeners;</span><br><span class="line">    target._d = bindDynamicKeys;</span><br><span class="line">    target._p = prependModifier;</span><br><span class="line">  &#125;</span><br><span class="line">  Object.defineProperty(Vue, &apos;FunctionalRenderContext&apos;, &#123;</span><br><span class="line">    value: FunctionalRenderContext</span><br><span class="line">  &#125;);</span><br><span class="line">  installRenderHelpers(FunctionalRenderContext.prototype);</span><br><span class="line">  ---&gt;</span><br><span class="line">  render:(&quot;with(this)&#123;return &quot; + code + &quot;&#125;&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="c"><a href="#c" class="headerlink" title="_c"></a>_c</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">vm._c = function (a, b, c, d) &#123; return createElement(vm, a, b, c, d, false); &#125;;</span><br><span class="line">function createElement (context,tag,data,children,normalizationType,alwaysNormalize) &#123;</span><br><span class="line">  if (Array.isArray(data) || isPrimitive(data)) &#123;</span><br><span class="line">    normalizationType = children;</span><br><span class="line">    children = data;</span><br><span class="line">    data = undefined;</span><br><span class="line">  &#125;</span><br><span class="line">  if (isTrue(alwaysNormalize)) &#123;</span><br><span class="line">    normalizationType = ALWAYS_NORMALIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  return _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line">function _createElement (context,tag,data,children,normalizationType) &#123;</span><br><span class="line">  //这里省略一系列边界判断</span><br><span class="line">  var vnode, ns;</span><br><span class="line">  if (typeof tag === &apos;string&apos;) &#123;</span><br><span class="line">    var Ctor;</span><br><span class="line">    ns = (context.$vnode &amp;&amp; context.$vnode.ns) || config.getTagNamespace(tag);</span><br><span class="line">    if (config.isReservedTag(tag)) &#123; //标签名是一般的html标签</span><br><span class="line">      vnode = new VNode(</span><br><span class="line">        config.parsePlatformTagName(tag), data, children,</span><br><span class="line">        undefined, undefined, context</span><br><span class="line">      );</span><br><span class="line">    &#125; else if ((!data || !data.pre) &amp;&amp; isDef(Ctor = resolveAsset(context.$options, &apos;components&apos;, tag))) &#123; //标签名是组件标签名</span><br><span class="line">      vnode = createComponent(Ctor, data, context, children, tag);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      //未知或未列出的命名空间元素在运行时检查，</span><br><span class="line">      //因为当其父项标准化子元素时可能会为其分配一个命名空间</span><br><span class="line">      vnode = new VNode(</span><br><span class="line">        tag, data, children,</span><br><span class="line">        undefined, undefined, context</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // direct component options / constructor</span><br><span class="line">    vnode = createComponent(tag, data, context, children);</span><br><span class="line">  &#125;</span><br><span class="line">  if (Array.isArray(vnode)) &#123;</span><br><span class="line">    return vnode</span><br><span class="line">  &#125; else if (isDef(vnode)) &#123;</span><br><span class="line">    if (isDef(ns)) &#123; applyNS(vnode, ns); &#125;</span><br><span class="line">    if (isDef(data)) &#123; registerDeepBindings(data); &#125;</span><br><span class="line">    return vnode</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">var VNode = function VNode (</span><br><span class="line">    tag,</span><br><span class="line">    data,</span><br><span class="line">    children,</span><br><span class="line">    text,</span><br><span class="line">    elm,</span><br><span class="line">    context,</span><br><span class="line">    componentOptions,</span><br><span class="line">    asyncFactory</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.tag = tag;</span><br><span class="line">    this.data = data;</span><br><span class="line">    this.children = children;//children本身是vnode对象集合，所以不需递归处理父子关系</span><br><span class="line">    this.text = text;</span><br><span class="line">    this.elm = elm;//挂载真正的dom对象</span><br><span class="line">    this.ns = undefined;</span><br><span class="line">    this.context = context;</span><br><span class="line">    this.fnContext = undefined;</span><br><span class="line">    this.fnOptions = undefined;</span><br><span class="line">    this.fnScopeId = undefined;</span><br><span class="line">    this.key = data &amp;&amp; data.key;</span><br><span class="line">    this.componentOptions = componentOptions;</span><br><span class="line">    this.componentInstance = undefined;</span><br><span class="line">    this.parent = undefined;</span><br><span class="line">    this.raw = false;</span><br><span class="line">    this.isStatic = false;</span><br><span class="line">    this.isRootInsert = true;</span><br><span class="line">    this.isComment = false;</span><br><span class="line">    this.isCloned = false;</span><br><span class="line">    this.isOnce = false;</span><br><span class="line">    this.asyncFactory = asyncFactory;</span><br><span class="line">    this.asyncMeta = undefined;</span><br><span class="line">    this.isAsyncPlaceholder = false;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>注意createElement函数只是将一个结点转成vnode对象<br>上面generate得到的render字符串的逻辑是生成一个根结点，<br>里面传递的子节点数组也是调用createElement函数生成的一个个vnode<br>所以这里调用render生成vnode函数时，没有递归逻辑，<br>而是每个结点自己去调createElement生成自己的vnode</p>
<h4 id="s"><a href="#s" class="headerlink" title="_s"></a>_s</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function toString (val) &#123;</span><br><span class="line">   return val == null</span><br><span class="line">     ? &apos;&apos;</span><br><span class="line">     : Array.isArray(val) || (isPlainObject(val) &amp;&amp; val.toString === _toString)</span><br><span class="line">       ? JSON.stringify(val, null, 2)</span><br><span class="line">       : String(val)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="v"><a href="#v" class="headerlink" title="_v"></a>_v</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function createTextVNode (val) &#123;</span><br><span class="line">    return new VNode(undefined, undefined, undefined, String(val))</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="l"><a href="#l" class="headerlink" title="_l"></a>_l</h4><p>循环组建结点的创建函数字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">function renderList (</span><br><span class="line">    val,</span><br><span class="line">    render</span><br><span class="line">  ) &#123;</span><br><span class="line">    var ret, i, l, keys, key;</span><br><span class="line">    if (Array.isArray(val) || typeof val === &apos;string&apos;) &#123;</span><br><span class="line">      ret = new Array(val.length);</span><br><span class="line">      for (i = 0, l = val.length; i &lt; l; i++) &#123;</span><br><span class="line">        ret[i] = render(val[i], i);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (typeof val === &apos;number&apos;) &#123;</span><br><span class="line">      ret = new Array(val);</span><br><span class="line">      for (i = 0; i &lt; val; i++) &#123;</span><br><span class="line">        ret[i] = render(i + 1, i);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (isObject(val)) &#123;</span><br><span class="line">      if (hasSymbol &amp;&amp; val[Symbol.iterator]) &#123;</span><br><span class="line">        ret = [];</span><br><span class="line">        var iterator = val[Symbol.iterator]();//获取对象生成器</span><br><span class="line">        var result = iterator.next();</span><br><span class="line">        while (!result.done) &#123;</span><br><span class="line">          ret.push(render(result.value, ret.length));</span><br><span class="line">          result = iterator.next();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        keys = Object.keys(val);</span><br><span class="line">        ret = new Array(keys.length);</span><br><span class="line">        for (i = 0, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">          key = keys[i];</span><br><span class="line">          ret[i] = render(val[key], key, i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!isDef(ret)) &#123;</span><br><span class="line">      ret = [];</span><br><span class="line">    &#125;</span><br><span class="line">    (ret)._isVList = true;</span><br><span class="line">    return ret</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="mountComponent"><a href="#mountComponent" class="headerlink" title="mountComponent"></a>mountComponent</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function mountComponent (vm,el,hydrating) &#123;</span><br><span class="line">  vm.$el = el;</span><br><span class="line">  if (!vm.$options.render) &#123;</span><br><span class="line">    vm.$options.render = createEmptyVNode;</span><br><span class="line">    &#123;...&#125;</span><br><span class="line">  callHook(vm, &apos;beforeMount&apos;);</span><br><span class="line"></span><br><span class="line">  var updateComponent;</span><br><span class="line">  if (config.performance &amp;&amp; mark) &#123;...</span><br><span class="line">  &#125; else &#123;  //定义updateComponent</span><br><span class="line">    updateComponent = function () &#123;</span><br><span class="line">      vm._update(vm._render(), hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  new Watcher(vm, updateComponent, noop, &#123;</span><br><span class="line">    before: function before () &#123;</span><br><span class="line">      if (vm._isMounted &amp;&amp; !vm._isDestroyed) &#123;</span><br><span class="line">        callHook(vm, &apos;beforeUpdate&apos;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, true);</span><br><span class="line">  hydrating = false;</span><br><span class="line">  if (vm.$vnode == null) &#123;</span><br><span class="line">    vm._isMounted = true;</span><br><span class="line">    callHook(vm, &apos;mounted&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  return vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p>watcher 构造函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var Watcher = function Watcher (vm,expOrFn,cb,options,isRenderWatcher) &#123;</span><br><span class="line">  this.vm = vm;</span><br><span class="line">  if (isRenderWatcher) &#123;</span><br><span class="line">    vm._watcher = this;</span><br><span class="line">  &#125;</span><br><span class="line">  vm._watchers.push(this);</span><br><span class="line">  //...省略不重要代码</span><br><span class="line">  this.expression = expOrFn.toString(); //updateComponent字符串化</span><br><span class="line">  // parse expression for getter</span><br><span class="line">  if (typeof expOrFn === &apos;function&apos;) &#123;</span><br><span class="line">    this.getter = expOrFn; //指向updateComponent</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    this.getter = parsePath(expOrFn);</span><br><span class="line">    if (!this.getter) &#123;</span><br><span class="line">      this.getter = noop;</span><br><span class="line">      warn(....);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  this.value = this.lazy</span><br><span class="line">    ? undefined</span><br><span class="line">    : this.get();//里面会调用this.getter</span><br><span class="line">&#125;;</span><br><span class="line">Watcher.prototype.get = function get () &#123;</span><br><span class="line">  var value;</span><br><span class="line">  var vm = this.vm;</span><br><span class="line">  try &#123;</span><br><span class="line">    value = this.getter.call(vm, vm);//就是在调用updateComponent</span><br><span class="line">  &#125; catch (e) &#123;...</span><br><span class="line">  &#125; finally &#123;...</span><br><span class="line">  &#125;</span><br><span class="line">  return value //最终返回value</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可知在new Watcher过程中构造函数会将updateComponent挂到getter属性上，<br>在通过get属性进行调用<br>再来看一下updateComponent怎么定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">updateComponent = function () &#123;</span><br><span class="line">   vm._update(vm._render(), hydrating);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>updateComponent要调用vue的_update函数<br>注意这里调用了vm._render()，生成了vnode，当做参数传递了进去<br>vue的_update函数是在构建vue构造函数时<br>调用lifecycleMixin函数被挂载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function lifecycleMixin (Vue) &#123;</span><br><span class="line">  Vue.prototype._update = function (vnode, hydrating) &#123;</span><br><span class="line">    var vm = this;</span><br><span class="line">    var prevEl = vm.$el;//vm.$el初次渲染时为挂载点所在html,即最原始的,parse处理的html模板</span><br><span class="line">    var prevVnode = vm._vnode;//这里初次渲染时为null</span><br><span class="line">    var restoreActiveInstance = setActiveInstance(vm);//给全局变量activeInstance赋值为vm</span><br><span class="line">    vm._vnode = vnode;//给vue挂上得到的vnode</span><br><span class="line">    if (!prevVnode) &#123;//初次渲染走这里</span><br><span class="line">      vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */);</span><br><span class="line">    &#125; else &#123;//更新时走这里</span><br><span class="line">      vm.$el = vm.__patch__(prevVnode, vnode);</span><br><span class="line">    &#125;</span><br><span class="line">    restoreActiveInstance();//处理完后更新activeInstance为null</span><br><span class="line">    // update __vue__ reference</span><br><span class="line">    if (prevEl) &#123;</span><br><span class="line">      prevEl.__vue__ = null;</span><br><span class="line">    &#125;</span><br><span class="line">    if (vm.$el) &#123;</span><br><span class="line">      vm.$el.__vue__ = vm;</span><br><span class="line">    &#125;</span><br><span class="line">    // if parent is an HOC, update its $el as well</span><br><span class="line">    if (vm.$vnode &amp;&amp; vm.$parent &amp;&amp; vm.$vnode === vm.$parent._vnode) &#123;</span><br><span class="line">      vm.$parent.$el = vm.$el;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p><strong>patch</strong>函数直接在生成vue构造函数时被挂载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop;</span><br><span class="line">var patch = createPatchFunction(&#123; nodeOps: nodeOps, modules: modules &#125;);</span><br><span class="line"></span><br><span class="line">function createPatchFunction (backend) &#123;</span><br><span class="line">    var i, j;</span><br><span class="line">    var cbs = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    var modules = backend.modules;</span><br><span class="line">    var nodeOps = backend.nodeOps;</span><br><span class="line"></span><br><span class="line">    for (i = 0; i &lt; hooks.length; ++i) &#123;</span><br><span class="line">      cbs[hooks[i]] = [];</span><br><span class="line">      for (j = 0; j &lt; modules.length; ++j) &#123;</span><br><span class="line">        if (isDef(modules[j][hooks[i]])) &#123;</span><br><span class="line">          cbs[hooks[i]].push(modules[j][hooks[i]]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //省略若干函数声明......</span><br><span class="line">    return function patch (oldVnode, vnode, hydrating, removeOnly) &#123;</span><br><span class="line">      if (isUndef(vnode)) &#123;</span><br><span class="line">        if (isDef(oldVnode)) &#123; invokeDestroyHook(oldVnode); &#125;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      var isInitialPatch = false;</span><br><span class="line">      var insertedVnodeQueue = [];</span><br><span class="line">      if (isUndef(oldVnode)) &#123;</span><br><span class="line">        isInitialPatch = true;</span><br><span class="line">        createElm(vnode, insertedVnodeQueue);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        var isRealElement = isDef(oldVnode.nodeType);</span><br><span class="line">        if (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) &#123;//更新时，详见更新节点</span><br><span class="line">          patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly);</span><br><span class="line">        &#125; else &#123;//初次渲染时oldVnode为原始html结点</span><br><span class="line">          if (isRealElement) &#123;</span><br><span class="line">           //是真实的DOM而且是服务端渲染的结果</span><br><span class="line">            if (oldVnode.nodeType === 1 &amp;&amp; oldVnode.hasAttribute(SSR_ATTR)) &#123;</span><br><span class="line">              oldVnode.removeAttribute(SSR_ATTR);</span><br><span class="line">              hydrating = true;</span><br><span class="line">            &#125;</span><br><span class="line">            if (isTrue(hydrating)) &#123;</span><br><span class="line">              if (hydrate(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">                invokeInsertHook(vnode, insertedVnodeQueue, true);</span><br><span class="line">                return oldVnode</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                warn(....);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //不是服务端渲染或者合成失败，就创建空的vnode代替老结点</span><br><span class="line">            oldVnode = emptyNodeAt(oldVnode);</span><br><span class="line">            //oldVnode:&#123;elm:指向原始未编译前的真实html结点&#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          // 替换正存在的结点</span><br><span class="line">          var oldElm = oldVnode.elm;//原来结点</span><br><span class="line">          var parentElm = nodeOps.parentNode(oldElm);//原节点的父节点</span><br><span class="line"></span><br><span class="line">          // 创建dom结点</span><br><span class="line">          createElm(</span><br><span class="line">            vnode,</span><br><span class="line">            insertedVnodeQueue,</span><br><span class="line">            oldElm._leaveCb ? null : parentElm,</span><br><span class="line">            nodeOps.nextSibling(oldElm)</span><br><span class="line">          );</span><br><span class="line">          //创建dom结束后，body里面会有两个挂载点，一个编译前html,一个编译后html</span><br><span class="line">          //所以新老结点更新的思路是,在父元素在新增新结点子元素，然后将老结点删除</span><br><span class="line">          // 递归更新父占位符节点元素</span><br><span class="line">          if (isDef(vnode.parent)) &#123;....&#125;</span><br><span class="line"></span><br><span class="line">          // destroy old node</span><br><span class="line">          if (isDef(parentElm)) &#123;</span><br><span class="line">            removeVnodes([oldVnode], 0, 0);//从父元素中删除老结点</span><br><span class="line">          &#125; else if (isDef(oldVnode.tag)) &#123;</span><br><span class="line">            invokeDestroyHook(oldVnode);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);</span><br><span class="line">      return vnode.elm //返回真正的dom结点</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="createElm"><a href="#createElm" class="headerlink" title="createElm"></a>createElm</h3><p>生成真正的dom结点挂载在各自的vnode的elm属性上，并在生成的过程中建立父子关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">  function createElm (vnode,insertedVnodeQueue,parentElm,refElm,nested,ownerArray,index</span><br><span class="line">  ) &#123;</span><br><span class="line">    if (isDef(vnode.elm) &amp;&amp; isDef(ownerArray)) &#123;//预渲染时克隆源节点，不再重新生成</span><br><span class="line">      vnode = ownerArray[index] = cloneVNode(vnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vnode.isRootInsert = !nested; // for transition enter check</span><br><span class="line">    if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var data = vnode.data;</span><br><span class="line">    var children = vnode.children;</span><br><span class="line">    var tag = vnode.tag;</span><br><span class="line">    if (isDef(tag)) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        if (data &amp;&amp; data.pre) &#123;creatingElmInVPre++;&#125;</span><br><span class="line">        if (isUnknownElement$$1(vnode, creatingElmInVPre)) &#123; warn(...);&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      vnode.elm = vnode.ns</span><br><span class="line">        ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">        : nodeOps.createElement(tag, vnode);//没有命名空间直接生成真正html标签挂到elm属性上</span><br><span class="line">      setScope(vnode);</span><br><span class="line">      &#123;</span><br><span class="line">        createChildren(vnode, children, insertedVnodeQueue); //构建子节点</span><br><span class="line">        if (isDef(data)) &#123;</span><br><span class="line">          invokeCreateHooks(vnode, insertedVnodeQueue);//处理标签上属性（id,class....）</span><br><span class="line">        &#125;</span><br><span class="line">        insert(parentElm, vnode.elm, refElm);</span><br><span class="line">      &#125;</span><br><span class="line">      if (data &amp;&amp; data.pre) &#123;</span><br><span class="line">        creatingElmInVPre--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (isTrue(vnode.isComment)) &#123;//处理注释结点</span><br><span class="line">      vnode.elm = nodeOps.createComment(vnode.text);</span><br><span class="line">      insert(parentElm, vnode.elm, refElm);</span><br><span class="line">    &#125; else &#123;//处理纯静态文本结点</span><br><span class="line">      vnode.elm = nodeOps.createTextNode(vnode.text);</span><br><span class="line">      insert(parentElm, vnode.elm, refElm);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">-----&gt;nodeOps.createElement-----&gt;</span><br><span class="line">  function createElement$1 (tagName, vnode) &#123;</span><br><span class="line">    var elm = document.createElement(tagName);</span><br><span class="line">    if (tagName !== &apos;select&apos;) &#123;</span><br><span class="line">      return elm</span><br><span class="line">    &#125;</span><br><span class="line">    // false or null will remove the attribute but undefined will not</span><br><span class="line">    if (vnode.data &amp;&amp; vnode.data.attrs &amp;&amp; vnode.data.attrs.multiple !== undefined) &#123;</span><br><span class="line">      elm.setAttribute(&apos;multiple&apos;, &apos;multiple&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    return elm</span><br><span class="line">  &#125;</span><br><span class="line">----&gt;nodeOps.createTextNode----&gt;</span><br><span class="line">function createTextNode (text) &#123;</span><br><span class="line">  return document.createTextNode(text)</span><br><span class="line">&#125;</span><br><span class="line">----&gt;nodeOps.createComment----&gt;</span><br><span class="line">function createComment (text) &#123;</span><br><span class="line">  return document.createComment(text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="createChildren"><a href="#createChildren" class="headerlink" title="createChildren"></a>createChildren</h3><p>构建子节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function createChildren (vnode, children, insertedVnodeQueue) &#123;</span><br><span class="line">      if (Array.isArray(children)) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          checkDuplicateKeys(children);//检查子节点是否有重复key值</span><br><span class="line">        &#125;</span><br><span class="line">        for (var i = 0; i &lt; children.length; ++i) &#123; //递归调用createElm创建子节点</span><br><span class="line">          createElm(children[i], insertedVnodeQueue, vnode.elm, null, true, children, i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else if (isPrimitive(vnode.text)) &#123;</span><br><span class="line">        nodeOps.appendChild(vnode.elm, nodeOps.createTextNode(String(vnode.text)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><p>构建父子dom结点关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> function insert (parent, elm, ref$$1) &#123;</span><br><span class="line">  if (isDef(parent)) &#123;</span><br><span class="line">    if (isDef(ref$$1)) &#123;</span><br><span class="line">      if (nodeOps.parentNode(ref$$1) === parent) &#123;</span><br><span class="line">        nodeOps.insertBefore(parent, elm, ref$$1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      nodeOps.appendChild(parent, elm);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">----&gt;nodeOps.insertBefore-----&gt;纯dom操作</span><br><span class="line">function insertBefore (parentNode, newNode, referenceNode) &#123;</span><br><span class="line">  parentNode.insertBefore(newNode, referenceNode);</span><br><span class="line">&#125;</span><br><span class="line">-----&gt;nodeOps.appendChild----&gt;纯dom操作</span><br><span class="line">function appendChild (node, child) &#123;</span><br><span class="line">    node.appendChild(child);</span><br><span class="line">  &#125;</span><br><span class="line">-----&gt;nodeOps.removeChild----&gt;纯dom操作</span><br><span class="line">function removeChild (node, child) &#123;</span><br><span class="line">    node.removeChild(child);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h2><p>mountComponent主要做这样几件事<br>1.执行beforeMount钩子函数<br>2.定义updateComponent,并在new watcher的时候调用<br>3.调用updateComponent函数时会调用vm_render函数生成vnode对象,这个过程ast中变量会拿到实际的值<br>4.updateComponent函数会将vnode传递给vm_update,vm_update在生成vue构造函数时被挂载<br>5.vm_update会调用vm__patch__,vm__patch__会调用patch函数<br>6.patch函数会根据传入参数特征处理第一次挂载还是更新操作<br>7.patch函数会调用createElement递归将vnode对象里面的结点转成真正的dom结点挂载在对应的elm属性上，同时会处理好父子关系以及标签上class,id之类的属性<br>8.因为处理最外层结点时，即挂载点结点时，获取的父节点与未编译的挂载点是同一个，所以要把未编译的挂载点调用removeVnodes移除，</p>
<h1 id="更新节点"><a href="#更新节点" class="headerlink" title="更新节点"></a>更新节点</h1><h2 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h2><p>负责具体的结点更新工作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">function patchVnode (oldVnode,vnode,insertedVnodeQueue,ownerArray,index，removeOnly</span><br><span class="line">) &#123;</span><br><span class="line">  if (oldVnode === vnode) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  //...省略若干边界/特殊条件处理</span><br><span class="line">  var i;</span><br><span class="line">  var data = vnode.data;</span><br><span class="line">  //组件才会有hook属性</span><br><span class="line">  if (isDef(data) &amp;&amp; isDef(i = data.hook) &amp;&amp; isDef(i = i.prepatch)) &#123;</span><br><span class="line">    i(oldVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var oldCh = oldVnode.children;</span><br><span class="line">  var ch = vnode.children;</span><br><span class="line">  if (isDef(data) &amp;&amp; isPatchable(vnode)) &#123;//处理标签上属性更新</span><br><span class="line">    for (i = 0; i &lt; cbs.update.length; ++i) &#123; cbs.update[i](oldVnode, vnode); &#125;</span><br><span class="line">    if (isDef(i = data.hook) &amp;&amp; isDef(i = i.update)) &#123; i(oldVnode, vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (isUndef(vnode.text)) &#123;//如果新结点不是纯文本结点</span><br><span class="line">    if (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;//如果新老结点都有子节点</span><br><span class="line">      if (oldCh !== ch) &#123; updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly); &#125;</span><br><span class="line">    &#125; else if (isDef(ch)) &#123; //如果新结点有子节点，老结点没有，直接新增</span><br><span class="line">      &#123;</span><br><span class="line">        checkDuplicateKeys(ch);</span><br><span class="line">      &#125;</span><br><span class="line">      if (isDef(oldVnode.text)) &#123; nodeOps.setTextContent(elm, &apos;&apos;); &#125;</span><br><span class="line">      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue);</span><br><span class="line">    &#125; else if (isDef(oldCh)) &#123; //如果老结点有子节点，新结点没有，直接删除</span><br><span class="line">      removeVnodes(oldCh, 0, oldCh.length - 1);</span><br><span class="line">    &#125; else if (isDef(oldVnode.text)) &#123;//如果是文本结点，清空</span><br><span class="line">      nodeOps.setTextContent(elm, &apos;&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (oldVnode.text !== vnode.text) &#123; //如果新结点也是纯文本结点，则更新内容</span><br><span class="line">    nodeOps.setTextContent(elm, vnode.text);</span><br><span class="line">  &#125;</span><br><span class="line">  if (isDef(data)) &#123;</span><br><span class="line">    if (isDef(i = data.hook) &amp;&amp; isDef(i = i.postpatch)) &#123; i(oldVnode, vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h2><p>负责判断子节点是否需要更新，递归调用patchVnode进行更新操作<br>主要思路是以新结点为标尺，对比老结点，在老结点树上面移动或者新增删除节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">  function updateChildren (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) &#123;</span><br><span class="line">      var oldStartIdx = 0;</span><br><span class="line">      var newStartIdx = 0;</span><br><span class="line">      var oldEndIdx = oldCh.length - 1;</span><br><span class="line">      var oldStartVnode = oldCh[0];</span><br><span class="line">      var oldEndVnode = oldCh[oldEndIdx];</span><br><span class="line">      var newEndIdx = newCh.length - 1;</span><br><span class="line">      var newStartVnode = newCh[0];</span><br><span class="line">      var newEndVnode = newCh[newEndIdx];</span><br><span class="line">      var oldKeyToIdx, idxInOld, vnodeToMove, refElm;</span><br><span class="line">      var canMove = !removeOnly;</span><br><span class="line"></span><br><span class="line">      &#123;</span><br><span class="line">        checkDuplicateKeys(newCh);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">        if (isUndef(oldStartVnode)) &#123;</span><br><span class="line">          oldStartVnode = oldCh[++oldStartIdx]; // Vnode has been moved left</span><br><span class="line">        &#125; else if (isUndef(oldEndVnode)) &#123;</span><br><span class="line">          oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">        &#125; else if (sameVnode(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">          patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">          oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        &#125; else if (sameVnode(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">          patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);</span><br><span class="line">          oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">          newEndVnode = newCh[--newEndIdx];</span><br><span class="line">        &#125; else if (sameVnode(oldStartVnode, newEndVnode)) &#123; </span><br><span class="line">          patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);</span><br><span class="line">//因为老node的开始节点竟然与新node的结束节点一致，说明老node的开始节点需要移动到当前的老node结束节点的后一位</span><br><span class="line">          canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm));</span><br><span class="line">          oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">          newEndVnode = newCh[--newEndIdx];</span><br><span class="line">        &#125; else if (sameVnode(oldEndVnode, newStartVnode)) &#123; // Vnode moved left</span><br><span class="line">          patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">//老node的结束节点移动到老node的开始节点之前</span><br><span class="line">          canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm);</span><br><span class="line">          oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          if (isUndef(oldKeyToIdx)) &#123; oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx); &#125;</span><br><span class="line">          idxInOld = isDef(newStartVnode.key)</span><br><span class="line">            ? oldKeyToIdx[newStartVnode.key]</span><br><span class="line">            : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">          //判断老结点数组中是否有当前这个新结点</span><br><span class="line">          if (isUndef(idxInOld)) &#123; // 如果没有在当前老结点前面新增这个新结点</span><br><span class="line">            createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            vnodeToMove = oldCh[idxInOld];</span><br><span class="line">            if (sameVnode(vnodeToMove, newStartVnode)) &#123; </span><br><span class="line">              patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">              oldCh[idxInOld] = undefined;</span><br><span class="line">              //如果有且key相同，对比之后，移动到当前老结点前面，保持新老结点位置相同</span><br><span class="line">              canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              如果新老结点不是同一个key，则新增新结点</span><br><span class="line">              createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">//此时newStartIdx和newEndIdx之间的vnode是新增的，调用addVnodes，把他们全部插进before的后边，before很多时候是为null的</span><br><span class="line">        refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm;</span><br><span class="line">        addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);</span><br><span class="line">      &#125; else if (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line"> //newStartIdx &gt; newEndIdx，可以认为newCh先遍历完。</span><br><span class="line"> //此时oldStartIdx和oldEndIdx之间的vnode在新的子节点里已经不存在了，调用removeVnodes将它们从dom里删除。</span><br><span class="line">        removeVnodes(oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">function sameVnode (a, b) &#123;</span><br><span class="line">    return (</span><br><span class="line">      a.key === b.key &amp;&amp; (</span><br><span class="line">        (</span><br><span class="line">          a.tag === b.tag &amp;&amp;</span><br><span class="line">          a.isComment === b.isComment &amp;&amp;</span><br><span class="line">          isDef(a.data) === isDef(b.data) &amp;&amp;</span><br><span class="line">          sameInputType(a, b)</span><br><span class="line">        ) || (</span><br><span class="line">          isTrue(a.isAsyncPlaceholder) &amp;&amp;</span><br><span class="line">          a.asyncFactory === b.asyncFactory &amp;&amp;</span><br><span class="line">          isUndef(b.asyncFactory.error)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.processon.com/view/link/5f1446f2e0b34d44f0527195" target="_blank" rel="noopener">流程图</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/css.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/css.html" itemprop="url">
                  关于css的一些事
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-27T20:41:15+08:00">
                2020-01-27
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.CSS 选择器的优先级<br>!important<br>内联样式（1000）<br>id选择器（100）<br>类选择器（10）<br>元素选择器（1）</p>
<p>2.为兼容浏览器，对css基本样式做统一处理的三种方法<br>【reset】<br>消除浏览器默认样式，针对具体元素标签重写样式<br>【normalize】<br>样式规范确定的情况下，直接重写全部样式<br>【neat】<br>前两者结合，针对确定的样式直接重写，不确定的进行清除</p>
<p>3.css预处理语法工具需要具备的特性<br>可以变量声明和计算<br>支持语法表达式<br>可以定义函数进行处理<br>属性可以继承<br>可以自行实现autoprefix类似的兼容性补全功能</p>
<p>4.实现动画的6种方式<br>纯JS(利用setInternal,16ms)<br>svg(利用标签配置)<br>canvas（利用jsAPI配置）<br>css3-transition(过渡动画，不能独立实现动画)<br>css3-animation(纯css实现动画)<br>requestAnimationFrame(类似setInterval,但性能消耗低)<br>前两种兼容性良好，后四种适用于移动端</p>
<p>5.屏幕适配布局方案<br>想办法让比例不变<br>A.在html/body标签上加上zoom属性，缺点是不灵活<br>B.使用rem，相对于文档根元素font-size,<br>  利用mediaQuery对常见几种屏幕宽度设置html的font-size<br>  以font-size大小为1rem</p>
<p>6.响应式设计的两种方案<br>前端或者后端判断useragent来跳转不同站点得到不同页面<br>使用mediaQuery媒体查询让页面根据不同设备自动改变页面布局和显示</p>
<p>7.根据浏览器屏幕宽度和分辨率加载不同大小的图片<br>使用mediaQuery判断加载不同的背景图<br>使用H5的picture标签<br>模板进行判断然后渲染不同图片<br>请求图片时带上相关参数，让图片服务器吐出不同大小图片</p>
<h1 id="table-layout-fixed-妙用"><a href="#table-layout-fixed-妙用" class="headerlink" title="table-layout: fixed; 妙用"></a>table-layout: fixed; 妙用</h1><p>具有滚动条的table表头和tbody分别用两个table实现时，在每列设置宽度的情况下，有时可能出现表头和tbody对不齐的情况，</p>
<p>这是因为table默认情况下，会按照表格内容进行列宽绘制，tbody和表头整个宽度是一样宽的，而tbody有滚动条宽度,表头没有滚动条，就会导致列对不上了<br>解决办法：</p>
<ol>
<li>给table设置 table-layout: fixed;让table按照设置的列宽进行绘制<br>.xxx-table {<br>table-layout: fixed;<br>}</li>
<li>不让所有的列都有具体的宽度，让某一列不设置宽度</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/psb.jpg" alt="YooHannah">
          <p class="site-author-name" itemprop="name">YooHannah</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">240</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YooHannah</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/treedocument/treedocument.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
